<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://stackpath.bootstrapcdn.com; connect-src 'self' https://financeplus.it2a.cloud https://*.vercel.app https://*.it2a.cloud; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://stackpath.bootstrapcdn.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://stackpath.bootstrapcdn.com; font-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://stackpath.bootstrapcdn.com; img-src 'self' data: blob:;">
    <title>Finanças Pessoais | Fluxo de Caixa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    

    
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            
            /* Variáveis para tema claro (padrão) */
            --bg-color: #f5f7fb;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #eaeaea;
            --navbar-bg: #ffffff;
            --footer-bg: #f8f9fa;
        }
        
        /* Tema escuro */
        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #f8f9fa;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --navbar-bg: #1e1e1e;
            --footer-bg: #1e1e1e;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary);
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: none;
            margin-bottom: 20px;
            background-color: var(--card-bg);
            transition: background-color 0.3s ease;
        }
        
        .card-header {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0 !important;
            transition: background-color 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }
        
        .table th {
            font-weight: 600;
            color: var(--gray);
        }
        
        .entrada {
            color: #28a745;
            font-weight: 600;
        }
        
        .saida {
            color: #dc3545;
            font-weight: 600;
        }
        
        .saldo-positivo {
            color: #28a745;
            font-weight: 700;
        }
        
        .saldo-negativo {
            color: #dc3545;
            font-weight: 700;
        }
        
        .filters {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            transition: background-color 0.3s ease;
        }
        
        .summary-card {
            text-align: center;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card h5 {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .summary-card h3 {
            font-weight: 700;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 20px;
        }
        
        .modal-content {
            border-radius: 12px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .config-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .badge-categoria {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
        }
        
        .filtro-anual {
            display: none;
        }
        
        .btn-excluir-direto {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        /* Estilos para diferenciar lançamentos previstos dos realizados */
        .lancamento-previsto {
            background-color: rgba(255, 193, 7, 0.1) !important;
            border-left: 4px solid #ffc107;
        }
        
        .lancamento-realizado {
            background-color: rgba(40, 167, 69, 0.05) !important;
            border-left: 4px solid #28a745;
        }
        
        .lancamento-transferencia {
            background-color: rgba(108, 117, 125, 0.1) !important;
            border-left: 4px solid #6c757d;
            font-style: italic;
        }
        
        /* Estilos para modo escuro */
        [data-theme="dark"] .lancamento-previsto {
            background-color: rgba(255, 193, 7, 0.15) !important;
        }
        
        [data-theme="dark"] .lancamento-realizado {
            background-color: rgba(40, 167, 69, 0.1) !important;
        }
        
        [data-theme="dark"] .lancamento-transferencia {
            background-color: rgba(108, 117, 125, 0.15) !important;
        }
        
        /* Estilo para o switch de tema */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            margin-left: 10px;
        }
        
        /* Estilos para foto de perfil */
        .profile-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .profile-photo:hover {
            transform: scale(1.1);
            border-color: var(--secondary);
        }
        
        .profile-photo-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary);
            margin: 0 auto 20px;
            display: block;
        }
        
        .profile-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .profile-upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .profile-upload-area.dragover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .theme-icon {
            margin-right: 5px;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
        }

        /* Estilos específicos para modo escuro - Apenas cor da fonte na tabela da página inicial */
        [data-theme="dark"] #dashboard #tabela-lancamentos th,
        [data-theme="dark"] #dashboard #tabela-lancamentos td,
        [data-theme="dark"] #dashboard #tabela-lancamentos th *,
        [data-theme="dark"] #dashboard #tabela-lancamentos td *,
        [data-theme="dark"] #dashboard #tabela-lancamentos strong,
        [data-theme="dark"] #dashboard #tabela-lancamentos span,
        [data-theme="dark"] #dashboard #tabela-lancamentos .text-success,
        [data-theme="dark"] #dashboard #tabela-lancamentos .text-danger,
        [data-theme="dark"] #dashboard #tabela-lancamentos .text-muted {
            color: #f8f9fa !important;
        }

        /* Estilos específicos para modo escuro - Tabela de fluxo de caixa detalhado nos relatórios */
        /* Apenas linhas de períodos (fonte branca) */
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table th,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table th *,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr:not(.table-light):not(.table-warning) td,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr:not(.table-light):not(.table-warning) td *,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr:not(.table-light):not(.table-warning) strong,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr:not(.table-light):not(.table-warning) span,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr:not(.table-light):not(.table-warning) .text-success,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr:not(.table-light):not(.table-warning) .text-danger,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr:not(.table-light):not(.table-warning) .text-muted {
            color: #f8f9fa !important;
        }
        
        /* Linhas de transações e linha de TOTAL (fonte preta - aparência original) */
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr.table-light td,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr.table-light td *,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr.table-light small,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr.table-light i,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr.table-warning td,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr.table-warning td *,
        [data-theme="dark"] #relatorios #fluxo-caixa-tabela .table tbody tr.table-warning strong {
            color: inherit !important;
        }

        /* Estilos específicos para modo escuro - Seção de estatísticas nos relatórios */
        [data-theme="dark"] #relatorios #relatorio-estatisticas,
        [data-theme="dark"] #relatorios #relatorio-estatisticas p,
        [data-theme="dark"] #relatorios #relatorio-estatisticas .table th,
        [data-theme="dark"] #relatorios #relatorio-estatisticas .table td,
        [data-theme="dark"] #relatorios #relatorio-estatisticas .table th *,
        [data-theme="dark"] #relatorios #relatorio-estatisticas .table td *,
        [data-theme="dark"] #relatorios #relatorio-estatisticas strong,
        [data-theme="dark"] #relatorios #relatorio-estatisticas span {
            color: #f8f9fa !important;
        }

        /* Estilos específicos para modo escuro - Tabelas de investimentos */
        [data-theme="dark"] #investimentos #tabela-investimentos th,
        [data-theme="dark"] #investimentos #tabela-investimentos td,
        [data-theme="dark"] #investimentos #tabela-investimentos th *,
        [data-theme="dark"] #investimentos #tabela-investimentos td *,
        [data-theme="dark"] #investimentos #tabela-investimentos strong,
        [data-theme="dark"] #investimentos #tabela-investimentos span,
        [data-theme="dark"] #investimentos #tabela-investimentos .text-success,
        [data-theme="dark"] #investimentos #tabela-investimentos .text-danger,
        [data-theme="dark"] #investimentos #tabela-investimentos .text-muted,
        [data-theme="dark"] #investimentos #tabela-dividendos th,
        [data-theme="dark"] #investimentos #tabela-dividendos td,
        [data-theme="dark"] #investimentos #tabela-dividendos th *,
        [data-theme="dark"] #investimentos #tabela-dividendos td *,
        [data-theme="dark"] #investimentos #tabela-dividendos strong,
        [data-theme="dark"] #investimentos #tabela-dividendos span,
        [data-theme="dark"] #investimentos #tabela-dividendos .text-success,
        [data-theme="dark"] #investimentos #tabela-dividendos .text-danger,
        [data-theme="dark"] #investimentos #tabela-dividendos .text-muted,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel th,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel td,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel th *,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel td *,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel strong,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel span,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel .text-success,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel .text-danger,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-variavel .text-muted,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa th,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa td,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa th *,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa td *,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa strong,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa span,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa .text-success,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa .text-danger,
        [data-theme="dark"] #investimentos #tabela-resumo-renda-fixa .text-muted,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas th,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas td,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas th *,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas td *,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas strong,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas span,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas .text-success,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas .text-danger,
        [data-theme="dark"] #investimentos #tabela-resumo-criptomoedas .text-muted {
            color: #f8f9fa !important;
        }

        /* Estilos para caixas de saldo no modo escuro */
        [data-theme="dark"] #saldo-atual,
        [data-theme="dark"] #saldo-previsto,
        [data-theme="dark"] #total-entradas,
        [data-theme="dark"] #total-saidas,
        [data-theme="dark"] #total-investido-main,
        [data-theme="dark"] #patrimonio-total,
        [data-theme="dark"] #dividendos-total,
        [data-theme="dark"] #rentabilidade-total,
        [data-theme="dark"] #total-ativos,
        [data-theme="dark"] #valor-entrada,
        [data-theme="dark"] #valor-saida,
        [data-theme="dark"] #saldo-inicial-evolucao,
        [data-theme="dark"] #saldo-final-evolucao {
            color: #ffffff !important;
        }

        /* Estilos gerais para textos em cards no modo escuro */
        [data-theme="dark"] .card-header,
        [data-theme="dark"] .card-body h5,
        [data-theme="dark"] .card-body h6,
        [data-theme="dark"] .card-body .text-muted {
            color: #ffffff !important;
        }

        /* Manter fundo branco dos gráficos no modo escuro para melhor visualização */
        [data-theme="dark"] .chart-container,
        [data-theme="dark"] .chart-container canvas,
        [data-theme="dark"] #relatorioChart,
        [data-theme="dark"] #comparativoChart,
        [data-theme="dark"] #evolucaoChart {
            background-color: #ffffff !important;
            border-radius: 8px;
        }

        /* Estilo específico para cabeçalho da tabela do relatório de fluxo de caixa - sempre fonte branca */
        .table-dark th {
            color: #ffffff !important;
            background-color: #212529 !important;
        }
        
        /* Garantir que a fonte seja branca independentemente do tema */
        [data-theme="light"] .table-dark th,
        [data-theme="dark"] .table-dark th {
            color: #ffffff !important;
            background-color: #212529 !important;
        }
        
        /* Estilos para logos dos bancos na tabela */
        .banco-logo-tabela {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .banco-logo-tabela svg {
            width: 20px;
            height: 20px;
        }
        
        .banco-info-tabela {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .banco-nome-tabela {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Estilos para formulário de configuração de bancos */
        #form-adicionar-banco {
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        #form-adicionar-banco.banco-selecionado {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(10px);
        }
        
        /* Cores específicas para cada banco no formulário */
        #form-adicionar-banco.banco-nubank {
            border-color: #8A05BE;
            background: linear-gradient(135deg, rgba(138, 5, 190, 0.1), rgba(138, 5, 190, 0.05));
        }
        
        #form-adicionar-banco.banco-inter {
            border-color: #FF7A00;
            background: linear-gradient(135deg, rgba(255, 122, 0, 0.1), rgba(255, 122, 0, 0.05));
        }
        
        #form-adicionar-banco.banco-bradesco {
            border-color: #E31E24;
            background: linear-gradient(135deg, rgba(227, 30, 36, 0.1), rgba(227, 30, 36, 0.05));
        }
        
        #form-adicionar-banco.banco-itau {
            border-color: #EC7000;
            background: linear-gradient(135deg, rgba(236, 112, 0, 0.1), rgba(236, 112, 0, 0.05));
        }
        
        #form-adicionar-banco.banco-santander {
            border-color: #EC0000;
            background: linear-gradient(135deg, rgba(236, 0, 0, 0.1), rgba(236, 0, 0, 0.05));
        }
        
        #form-adicionar-banco.banco-caixa {
            border-color: #0066CC;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
        }
        
        #form-adicionar-banco.banco-bb {
            border-color: #FFFF00;
            background: linear-gradient(135deg, rgba(255, 255, 0, 0.1), rgba(255, 255, 0, 0.05));
        }
        
        #form-adicionar-banco.banco-c6 {
            border-color: #000000;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05));
        }
        
        #form-adicionar-banco.banco-picpay {
            border-color: #21C25E;
            background: linear-gradient(135deg, rgba(33, 194, 94, 0.1), rgba(33, 194, 94, 0.05));
        }
        
        #form-adicionar-banco.banco-neon {
            border-color: #00D4FF;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 212, 255, 0.05));
        }
        
        /* Estilos para selects com logos de bancos */
        .select-com-logo {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-left: 2.5rem;
        }
        
        .select-com-logo option {
            padding-left: 2rem;
            background-repeat: no-repeat;
            background-position: 0.5rem center;
            background-size: 20px 20px;
        }
        
        /* Estilo para o container do select customizado */
        .banco-select-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .banco-select-container::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 1;
            pointer-events: none;
        }
        
        /* Classes específicas para cada banco */
        .banco-nubank::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%238A05BE'/%3e%3cpath d='M12 6L18 12L12 18L6 12L12 6Z' fill='white'/%3e%3c/svg%3e"); }
        .banco-inter::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%23FF7A00'/%3e%3cpath d='M8 8H16V16H8V8Z' fill='white'/%3e%3c/svg%3e"); }
        .banco-bradesco::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%23CC092F'/%3e%3ccircle cx='12' cy='12' r='6' fill='white'/%3e%3c/svg%3e"); }
        .banco-itau::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%23EC7000'/%3e%3cpath d='M6 12L12 6L18 12L12 18L6 12Z' fill='white'/%3e%3c/svg%3e"); }
        .banco-santander::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%23EC0000'/%3e%3cpath d='M8 8L16 8L12 16L8 8Z' fill='white'/%3e%3c/svg%3e"); }
        .banco-caixa::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%230066CC'/%3e%3crect x='8' y='8' width='8' height='8' fill='white'/%3e%3c/svg%3e"); }
        .banco-bb::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%23FFDD00'/%3e%3cpath d='M8 8H16V16H8V8Z' fill='%23003366'/%3e%3c/svg%3e"); }
        .banco-c6::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%23000000'/%3e%3ctext x='12' y='16' text-anchor='middle' fill='white' font-size='10' font-weight='bold'%3eC6%3c/text%3e%3c/svg%3e"); }
        .banco-picpay::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%2321C25E'/%3e%3ccircle cx='12' cy='12' r='4' fill='white'/%3e%3c/svg%3e"); }
        .banco-neon::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%2300D4FF'/%3e%3cpath d='M8 8L16 16M16 8L8 16' stroke='white' stroke-width='2'/%3e%3c/svg%3e"); }
        .banco-original::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%2300A859'/%3e%3ccircle cx='12' cy='12' r='5' fill='white'/%3e%3c/svg%3e"); }
        .banco-next::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%2300D4AA'/%3e%3cpath d='M8 8L16 12L8 16V8Z' fill='white'/%3e%3c/svg%3e"); }
        .banco-default::before { background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3e%3crect width='24' height='24' rx='4' fill='%236C757D'/%3e%3cpath d='M8 8H16V16H8V8Z' fill='white'/%3e%3c/svg%3e"); }
        
        /* Limitação de altura das tabelas de investimentos e dividendos */
        #tabela-investimentos tbody,
        #tabela-dividendos tbody {
            display: block;
            max-height: 400px; /* Aproximadamente 10 linhas */
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        #tabela-investimentos thead,
        #tabela-dividendos thead {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        #tabela-investimentos tbody tr,
        #tabela-dividendos tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        /* Ajuste da barra de rolagem */
        #tabela-investimentos tbody::-webkit-scrollbar,
        #tabela-dividendos tbody::-webkit-scrollbar {
            width: 8px;
        }
        
        #tabela-investimentos tbody::-webkit-scrollbar-track,
        #tabela-dividendos tbody::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #tabela-investimentos tbody::-webkit-scrollbar-thumb,
        #tabela-dividendos tbody::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        #tabela-investimentos tbody::-webkit-scrollbar-thumb:hover,
        #tabela-dividendos tbody::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Animação de loading para o botão de cotações */
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para Saldos por Conta */
        .saldo-conta-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .saldo-conta-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .saldo-conta-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .saldo-conta-banco {
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            margin-left: 8px;
        }
        
        .saldo-conta-nome {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .saldo-conta-valor {
            font-size: 1.4em;
            font-weight: bold;
            text-align: right;
        }
        
        .saldo-positivo {
            color: #28a745;
        }
        
        .saldo-negativo {
            color: #dc3545;
        }
        
        .saldo-zero {
            color: #6c757d;
        }
        
        /* Tema escuro para saldos por conta */
        [data-theme="dark"] .saldo-conta-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .saldo-conta-banco {
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .saldo-conta-nome {
            color: #a0aec0;
        }
    </style>
</head>
<body>
    <!-- Modal de Login -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog" style="z-index: 2000;">
            <div class="modal-content">
                <style>
                    /* Estilo para ocultar o fundo da aplicação quando o modal de login está aberto */
                    body.login-active .container, 
                    body.login-active #main-navbar,
                    body.login-active #main-footer {
                        display: none;
                    }
                    body.login-active {
                        background-color: var(--primary);
                        background-image: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
                    }
                </style>
                <script>
                    // Adicionar classe ao body quando o modal de login é aberto
                    document.addEventListener('DOMContentLoaded', function() {
                        const loginModal = document.getElementById('loginModal');
                        const registroModal = document.getElementById('registroModal');
                        
                        // Corrigir problema de aria-hidden com foco
                        function fixAriaHidden(modal) {
                            modal.addEventListener('shown.bs.modal', function() {
                                modal.removeAttribute('aria-hidden');
                                document.body.classList.add('login-active');
                            });
                            modal.addEventListener('hidden.bs.modal', function() {
                                modal.setAttribute('aria-hidden', 'true');
                                document.body.classList.remove('login-active');
                            });
                        }
                        
                        fixAriaHidden(loginModal);
                        fixAriaHidden(registroModal);
                    });
                </script>
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>Login</h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="bi bi-cash-coin" style="font-size: 3rem; color: var(--primary);"></i>
                        <h4 class="mt-2">Finanças Pessoais</h4>
                        <p class="text-muted">Faça login para acessar seus dados financeiros</p>
                    </div>
                    <div id="login-error" class="alert alert-danger d-none" role="alert">
                        Credenciais inválidas. Por favor, tente novamente.
                    </div>
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                <input type="email" class="form-control" id="login-email" autocomplete="username" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="login-senha" class="form-label">Senha</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-key"></i></span>
                                <input type="password" class="form-control" id="login-senha" autocomplete="current-password" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="lembrar-login">
                            <label class="form-check-label" for="lembrar-login">Lembrar de mim</label>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Entrar</button>
                            <button type="button" class="btn btn-outline-secondary" id="criar-conta-btn">Criar Conta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Registro -->
    <div class="modal fade" id="registroModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Criar Conta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="registro-error" class="alert alert-danger d-none" role="alert">
                        Erro ao criar conta. Por favor, tente novamente.
                    </div>
                    <form id="registro-form">
                        <div class="mb-3">
                            <label for="registro-nome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="registro-nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="registro-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registro-email" autocomplete="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="registro-senha" class="form-label">Senha</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="registro-senha" autocomplete="new-password" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="progress mt-2" style="height: 5px;">
                                <div id="senha-forca" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="senha-feedback" class="form-text">A senha deve ter pelo menos 8 caracteres</small>
                        </div>
                        <div class="mb-3">
                            <label for="registro-confirmar-senha" class="form-label">Confirmar Senha</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="registro-confirmar-senha" autocomplete="new-password" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div id="senha-match-feedback" class="form-text"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelar-registro" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvar-registro">Criar Conta</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Perfil -->
    <div class="modal fade" id="perfilModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-circle me-2"></i>Perfil do Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <img id="modal-profile-photo" class="profile-photo-large" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z'/%3E%3C/svg%3E" alt="Foto de Perfil">
                        <h5 id="modal-user-name" class="mt-3">Nome do Usuário</h5>
                        <p id="modal-user-email" class="text-muted">email@exemplo.com</p>
                    </div>
                    
                    <div class="profile-upload-area" id="profile-upload-area">
                        <i class="bi bi-cloud-upload" style="font-size: 2rem; color: var(--primary);"></i>
                        <h6 class="mt-2">Clique ou arraste uma foto aqui</h6>
                        <p class="text-muted small">Formatos aceitos: JPG, PNG, GIF (máx. 2MB)</p>
                        <input type="file" id="profile-photo-input" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button type="button" class="btn btn-outline-danger flex-fill" id="remover-foto">
                            <i class="bi bi-trash me-1"></i>Remover Foto
                        </button>
                        <button type="button" class="btn btn-primary flex-fill" id="salvar-foto">
                            <i class="bi bi-check-lg me-1"></i>Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg shadow-sm" id="main-navbar">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-cash-coin me-2"></i>Finanças Pessoais
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-page="dashboard"><i class="bi bi-house me-1"></i> Início</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#lancamentoModal">
                            <i class="bi bi-plus-circle me-1"></i> Novo Lançamento
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="investimentos"><i class="bi bi-graph-up me-1"></i> Investimentos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="relatorios"><i class="bi bi-bar-chart-line me-1"></i> Relatórios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="configuracoes"><i class="bi bi-gear me-1"></i> Configurações</a>
                    </li>
                    <li class="nav-item" id="admin-menu-item" style="display: none;">
                        <a class="nav-link" href="#" data-page="admin"><i class="bi bi-shield-check me-1"></i> Administração</a>
                    </li>
                    <li class="nav-item d-flex align-items-center ms-3">
                        <img id="navbar-profile-photo" class="profile-photo me-2" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z'/%3E%3C/svg%3E" alt="Foto de Perfil" title="Clique para alterar foto" onclick="abrirModalPerfil()">
                        <span class="theme-icon"><i class="bi bi-sun-fill" id="theme-icon"></i></span>
                        <label class="theme-switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Página Principal/Dashboard -->
        <div id="dashboard" class="page active">
            <!-- Filtros -->
            <div class="filters card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="periodo" class="form-label">Período</label>
                            <select class="form-select" id="periodo">
                                <option value="mensal" selected>Mensal</option>
                                <option value="anual">Anual</option>
                            </select>
                        </div>
                        <div class="col-md-3 filtro-mensal">
                            <label for="mes" class="form-label">Mês</label>
                            <select class="form-select" id="mes">
                                <!-- Meses serão carregados dinamicamente -->
                            </select>
                        </div>
                        <div class="col-md-2 filtro-mensal">
                            <label for="ano" class="form-label">Ano</label>
                            <select class="form-select" id="ano">
                                <!-- Anos serão carregados dinamicamente -->
                            </select>
                        </div>
                        <div class="col-md-3 filtro-anual">
                            <label for="anoAnual" class="form-label">Ano</label>
                            <select class="form-select" id="anoAnual">
                                <!-- Anos serão carregados dinamicamente -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="categoria" class="form-label">Categoria</label>
                            <select class="form-select" id="categoria">
                                <option value="">Todas as categorias</option>
                                <!-- Categorias serão carregadas dinamicamente -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="tipo" class="form-label">Tipo</label>
                            <select class="form-select" id="tipo">
                                <option value="">Todos os tipos</option>
                                <option value="entrada">Entrada</option>
                                <option value="saida">Saída</option>
                            </select>
                        </div>

                        <div class="col-12 text-end">
                            <button class="btn btn-primary" id="aplicarFiltros">
                                <i class="bi bi-funnel me-1"></i> Aplicar Filtros
                            </button>
                            <button class="btn btn-outline-secondary ms-2" id="limparFiltros">
                                <i class="bi bi-arrow-clockwise me-1"></i> Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumo Financeiro -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <i class="bi bi-wallet2 text-primary fs-2 mb-2"></i>
                            <h5 class="text-muted">Saldo Atual</h5>
                            <h3 id="saldo-atual" class="mb-0">R$ 0,00</h3>
                            <small class="text-muted">Apenas realizados</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <i class="bi bi-graph-up-arrow text-info fs-2 mb-2"></i>
                            <h5 class="text-muted">Saldo Previsto</h5>
                            <h3 id="saldo-previsto" class="mb-0">R$ 0,00</h3>
                            <small class="text-muted">Realizados + previstos</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <i class="bi bi-arrow-up-circle text-success fs-2 mb-2"></i>
                            <h5 class="text-muted">Total Entradas</h5>
                            <h3 id="total-entradas" class="mb-0">R$ 0,00</h3>
                            <small class="text-muted">Realizadas + previstas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <i class="bi bi-arrow-down-circle text-danger fs-2 mb-2"></i>
                            <h5 class="text-muted">Total Saídas</h5>
                            <h3 id="total-saidas" class="mb-0">R$ 0,00</h3>
                            <small class="text-muted">Realizadas + previstas</small>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Investimentos -->
            <div class="row mt-4" id="investimentos-section" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-graph-up me-2"></i> Resumo de Investimentos
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card summary-card h-100">
                                        <div class="card-body text-center">
                                            <i class="bi bi-wallet text-secondary fs-2 mb-2"></i>
                                            <h5 class="text-muted">Total Investido</h5>
                                            <h3 id="total-investido-main" class="mb-0">R$ 0,00</h3>
                                            <small class="text-muted">Capital aplicado</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card summary-card h-100">
                                        <div class="card-body text-center">
                                            <i class="bi bi-piggy-bank text-primary fs-2 mb-2"></i>
                                            <h5 class="text-muted">Patrimônio Total</h5>
                                            <h3 id="patrimonio-total" class="mb-0">R$ 0,00</h3>
                                            <small class="text-muted">Valor atual dos ativos</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card summary-card h-100">
                                        <div class="card-body text-center">
                                            <i class="bi bi-cash-coin text-success fs-2 mb-2"></i>
                                            <h5 class="text-muted">Dividendos Recebidos</h5>
                                            <h3 id="dividendos-total" class="mb-0">R$ 0,00</h3>
                                            <small class="text-muted">Total de rendimentos</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-6">
                                    <div class="card summary-card h-100">
                                        <div class="card-body text-center">
                                            <i class="bi bi-graph-up-arrow text-info fs-2 mb-2"></i>
                                            <h5 class="text-muted">Rentabilidade</h5>
                                            <h3 id="rentabilidade-total" class="mb-0">0,00%</h3>
                                            <small class="text-muted">Ganho/perda total</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-6">
                                    <div class="card summary-card h-100">
                                        <div class="card-body text-center">
                                            <i class="bi bi-building text-warning fs-2 mb-2"></i>
                                            <h5 class="text-muted">Ativos</h5>
                                            <h3 id="total-ativos" class="mb-0">0</h3>
                                            <small class="text-muted">Quantidade de ativos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cartões de Crédito -->
            <div class="row mt-4" id="cartoes-section" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-credit-card me-2"></i> Cartões de Crédito
                            </div>
                            <small class="text-muted">Limites e utilização</small>
                        </div>
                        <div class="card-body">
                            <div class="row" id="cartoes-dashboard">
                                <!-- Cartões serão carregados dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-bar-chart me-2"></i> Receitas vs Despesas
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="dropdown me-2">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="tipoGraficoDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-pie-chart"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="tipoGraficoDropdown">
                                        <li><a class="dropdown-item tipo-grafico" href="#" data-tipo="doughnut"><i class="bi bi-pie-chart me-2"></i>Rosca</a></li>
                                        <li><a class="dropdown-item tipo-grafico" href="#" data-tipo="pie"><i class="bi bi-pie-chart-fill me-2"></i>Pizza</a></li>
                                        <li><a class="dropdown-item tipo-grafico" href="#" data-tipo="bar"><i class="bi bi-bar-chart me-2"></i>Barras</a></li>
                                        <li><a class="dropdown-item tipo-grafico" href="#" data-tipo="polarArea"><i class="bi bi-bullseye me-2"></i>Área Polar</a></li>
                                    </ul>
                                </div>
                                <div class="form-check form-switch me-2">
                                    <input class="form-check-input" type="checkbox" id="comparar-periodos">
                                    <label class="form-check-label" for="comparar-periodos">Comparar</label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="comparativoChart"></canvas>
                            </div>
                            <div class="text-center mt-3" id="grafico-info">
                                <div class="row justify-content-center">
                                    <div class="col-6">
                                        <div class="p-2 rounded" style="background-color: rgba(40, 167, 69, 0.1);">
                                            <span class="badge bg-success">Entradas</span>
                                            <h5 class="mb-0 mt-1" id="valor-entrada">R$ 0,00</h5>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 rounded" style="background-color: rgba(220, 53, 69, 0.1);">
                                            <span class="badge bg-danger">Saídas</span>
                                            <h5 class="mb-0 mt-1" id="valor-saida">R$ 0,00</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-graph-up me-2"></i> Evolução Financeira
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="evolucaoChart"></canvas>
                            </div>
                            <div class="text-center mt-3" id="evolucao-info">
                                <div class="row justify-content-center">
                                    <div class="col-6">
                                        <div class="p-2 rounded" style="background-color: rgba(0, 123, 255, 0.1);">
                                            <span class="badge bg-primary">Saldo Inicial</span>
                                            <h5 class="mb-0 mt-1" id="saldo-inicial-evolucao">R$ 0,00</h5>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 rounded" style="background-color: rgba(40, 167, 69, 0.1);">
                                            <span class="badge bg-success">Saldo Final</span>
                                            <h5 class="mb-0 mt-1" id="saldo-final-evolucao">R$ 0,00</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saldos por Conta Individual -->
            <div class="row mt-4" id="saldos-por-conta" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-credit-card me-2"></i> Saldos por Conta Individual
                                <small class="text-muted ms-2">(Detalhamento por conta)</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3" id="saldos-contas-container">
                                <!-- Saldos por conta serão carregados dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Lançamentos -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-table me-2"></i> <span id="titulo-tabela">Fluxo de Caixa</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-warning" id="recarregar-fluxo-caixa-inicial" title="Recarregar Fluxo de Caixa">
                            <i class="bi bi-arrow-clockwise me-1"></i> Recarregar
                        </button>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#transferenciaModal" onclick="prepararModalTransferencia()">
                            <i class="bi bi-arrow-left-right me-1"></i> Transferir
                        </button>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#lancamentoModal">
                            <i class="bi bi-plus-circle me-1"></i> Novo
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descrição</th>
                                    <th>Categoria</th>
                                    <th>Banco/Conta</th>
                                    <th>Tipo Transação</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-end">Entrada</th>
                                    <th class="text-end">Saída</th>
                                    <th class="text-end">Saldo</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-lancamentos">
                                <!-- Estado vazio -->
                                <tr id="empty-state-row">
                                    <td colspan="10">
                                        <div class="empty-state">
                                            <i class="bi bi-wallet2"></i>
                                            <h4>Nenhum lançamento cadastrado</h4>
                                            <p>Comece adicionando seu primeiro lançamento financeiro</p>
                                            <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#lancamentoModal">
                                                <i class="bi bi-plus-circle me-1"></i> Adicionar Lançamento
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Relatórios -->
        <div id="relatorios" class="page">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-bar-chart-line me-2"></i> Relatórios Avançados
                </div>
                <div class="card-body">
                    <!-- Filtros para relatórios -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="tipo-relatorio" class="form-label">Tipo de Relatório</label>
                            <select class="form-select" id="tipo-relatorio">
                                <option value="fluxo-caixa">Fluxo de Caixa</option>
                                <option value="categoria">Análise por Categoria</option>
                                <option value="tendencia">Análise de Tendências</option>
                                <option value="investimentos">Relatório de Investimentos</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="data-inicio-relatorio" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="data-inicio-relatorio" required>
                        </div>
                        <div class="col-md-4">
                            <label for="data-fim-relatorio" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="data-fim-relatorio" required>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="filtro-status" class="form-label">Filtrar por Status</label>
                            <select class="form-select" id="filtro-status">
                                <option value="todos">Todos os Lançamentos</option>
                                <option value="realizado">Apenas Realizados</option>
                                <option value="previsto">Apenas Previstos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="banco-relatorio" class="form-label">Banco</label>
                            <select class="form-select" id="banco-relatorio">
                                <option value="">Todos os bancos</option>
                                <!-- Bancos serão carregados dinamicamente -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="comparar-status" class="form-label">Comparação</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="comparar-status">
                                <label class="form-check-label" for="comparar-status">
                                    Comparar Previsto vs Realizado
                                </label>
                            </div>
                        </div>
                        <div class="col-md-12 mt-3 d-flex justify-content-end gap-2">
                            <button class="btn btn-primary" id="gerar-relatorio">
                                <i class="bi bi-bar-chart me-1"></i> Gerar Relatório
                            </button>
                            <button class="btn btn-success" id="exportar-pdf" disabled>
                                <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF
                            </button>
                            <button class="btn btn-info" id="exportar-fluxo-caixa" disabled>
                                <i class="bi bi-file-earmark-text me-1"></i> Exportar Fluxo de Caixa
                            </button>
                        </div>
                    </div>
                    
                    <!-- Gráficos de relatórios -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="chart-container" style="position: relative; height:400px;">
                                <canvas id="relatorioChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">Estatísticas</div>
                                <div class="card-body">
                                    <div id="relatorio-estatisticas">
                                        <p>Selecione um tipo de relatório e clique em Gerar para visualizar as estatísticas.</p>
                                        <div class="mt-3">
                                            <table class="table table-sm">
                                                <tbody>
                                                    <tr>
                                                        <td>Total de Entradas:</td>
                                                        <td id="estatistica-total-entradas">R$ 0,00</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Total de Saídas:</td>
                                                        <td id="estatistica-total-saidas">R$ 0,00</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Saldo:</td>
                                                        <td id="estatistica-saldo">R$ 0,00</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Maior Entrada:</td>
                                                        <td id="estatistica-maior-entrada">R$ 0,00</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Maior Saída:</td>
                                                        <td id="estatistica-maior-saida">R$ 0,00</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Categoria com mais gastos:</td>
                                                        <td id="estatistica-categoria-mais-gastos">Nenhuma</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    
                    <!-- Tabela detalhada do Fluxo de Caixa -->
                    <div class="row mt-4" id="fluxo-caixa-tabela" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-table me-2"></i> Fluxo de Caixa Detalhado
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Período</th>
                                                    <th class="text-end">Saldo Inicial</th>
                                                    <th class="text-end">Entradas</th>
                                                    <th class="text-end">Saídas</th>
                                                    <th class="text-end">Movimento</th>
                                                    <th class="text-end">Saldo Final</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fluxo-caixa-tbody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Página de Configurações -->
        <div id="configuracoes" class="page">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-gear me-2"></i> Configurações
                </div>
                <div class="card-body">
                    <div class="config-item">
                        <h5>Saldo Inicial</h5>
                        <p>Defina o saldo inicial da sua conta</p>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="saldo-inicial-input" step="0.01" value="0">
                                    <button class="btn btn-primary" type="button" id="salvar-saldo-inicial">Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <h5>🧪 Teste de Diagnóstico</h5>
                        <p>Ferramenta para diagnosticar problemas com lançamentos mensais</p>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button class="btn btn-warning me-2 mb-2" type="button" onclick="testarLancamentoMensal()">
                                    <i class="bi bi-bug me-1"></i> Executar Teste Completo
                                </button>
                                <button class="btn btn-success me-2 mb-2" type="button" onclick="criarLancamentoTesteOutubro()">
                                    <i class="bi bi-plus-circle me-1"></i> Criar Teste Outubro 2024
                                </button>
                                <button class="btn btn-info me-2 mb-2" type="button" onclick="testarOutubro2025()">
                                    <i class="bi bi-calendar-check me-1"></i> Testar Outubro 2025
                                </button>
                                <button class="btn btn-secondary mb-2" type="button" onclick="testarTransferencia()">
                                    <i class="bi bi-arrow-left-right me-1"></i> Testar Transferência
                                </button>
                                <small class="text-muted d-block mt-1">Verifique o console do navegador (F12) para ver os resultados</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <h5>Categorias Personalizadas</h5>
                        <p>Gerencie suas categorias de lançamentos financeiros</p>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="nova-categoria" placeholder="Nova categoria">
                                    <button class="btn btn-primary" type="button" id="adicionar-categoria">Adicionar</button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-group" id="lista-categorias">
                                    <!-- Categorias serão carregadas dinamicamente -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <h5>Bancos e Contas</h5>
                        <p>Gerencie seus bancos e contas correntes</p>
                        <div class="row mb-3" id="form-adicionar-banco">
                            <div class="col-md-3">
                                <label for="select-banco-config" class="form-label">Banco</label>
                                <div class="banco-select-wrapper">
                                    <select class="form-select select-com-logo" id="select-banco-config" onchange="aplicarCorBancoFormulario()">
                                        <option value="">Selecione um banco</option>
                                        <option value="Nubank" data-logo="nubank">Nubank</option>
                                        <option value="Inter" data-logo="inter">Inter</option>
                                        <option value="Bradesco" data-logo="bradesco">Bradesco</option>
                                        <option value="Itaú" data-logo="itau">Itaú</option>
                                        <option value="Santander" data-logo="santander">Santander</option>
                                        <option value="Caixa Econômica Federal" data-logo="caixa">Caixa Econômica Federal</option>
                                        <option value="Banco do Brasil" data-logo="bb">Banco do Brasil</option>
                                        <option value="C6 Bank" data-logo="c6">C6 Bank</option>
                                        <option value="PicPay" data-logo="picpay">PicPay</option>
                                        <option value="Neon" data-logo="neon">Neon</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="nova-conta" class="form-label">Número da Conta</label>
                                <input type="text" class="form-control" id="nova-conta" placeholder="Ex: 12345-6">
                            </div>
                            <div class="col-md-3">
                                <label for="tipo-conta" class="form-label">Tipo de Conta</label>
                                <select class="form-select" id="tipo-conta">
                                    <option value="">Selecione o tipo</option>
                                    <option value="Conta Corrente">Conta Corrente</option>
                                    <option value="Conta Poupança">Conta Poupança</option>
                                    <option value="Conta Digital">Conta Digital</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary w-100" type="button" id="adicionar-banco">
                                    <i class="bi bi-plus-circle me-1"></i> Adicionar
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabela-bancos">
                                <thead>
                                    <tr>
                                        <th>Banco</th>
                                        <th>Conta</th>
                                        <th>Tipo</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Bancos serão carregados dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <h5>Cartões de Crédito</h5>
                        <p>Gerencie seus cartões de crédito e limites</p>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="novo-cartao" placeholder="Nome do cartão">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="banco-cartao" placeholder="Banco emissor">
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="limite-cartao" step="0.01" min="0" placeholder="Limite">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary" type="button" id="adicionar-cartao">Adicionar</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabela-cartoes">
                                <thead>
                                    <tr>
                                        <th>Cartão</th>
                                        <th>Banco</th>
                                        <th>Limite Total</th>
                                        <th>Limite Usado</th>
                                        <th>Limite Disponível</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Cartões serão carregados dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <h5>Orçamento Mensal por Categoria</h5>
                        <p>Defina limites de gastos mensais para cada categoria</p>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-select" id="categoria-orcamento">
                                    <!-- Categorias serão carregadas dinamicamente -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="valor-orcamento" step="0.01" min="0" placeholder="Limite mensal">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary" type="button" id="salvar-orcamento">Salvar Orçamento</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabela-orcamentos">
                                <thead>
                                    <tr>
                                        <th>Categoria</th>
                                        <th>Limite Mensal</th>
                                        <th>Gasto Atual</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Orçamentos serão carregados dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <h5>Preferências de Visualização</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="saldo-inicial-automatico" checked>
                            <label class="form-check-label" for="saldo-inicial-automatico">Usar saldo inicial automático do mês anterior</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="notificacoes" checked>
                            <label class="form-check-label" for="notificacoes">Ativar notificações de saldo baixo</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="alertas-orcamento" checked>
                            <label class="form-check-label" for="alertas-orcamento">Ativar alertas de orçamento</label>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <h5>💾 Backup e Restauração</h5>
                        <div class="alert alert-success">
                            <i class="bi bi-shield-check me-1"></i>
                            <strong>Proteja seus dados!</strong> Faça backup regularmente para não perder suas informações financeiras.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-download display-4 text-primary mb-3"></i>
                                        <h6 class="card-title">Fazer Backup</h6>
                                        <p class="card-text small">Salva todos os seus dados em um arquivo seguro</p>
                                        <button class="btn btn-primary btn-lg w-100" id="backup-simples">
                                            <i class="bi bi-download me-2"></i>Criar Backup
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-upload display-4 text-success mb-3"></i>
                                        <h6 class="card-title">Restaurar Backup</h6>
                                        <p class="card-text small">Recupera seus dados de um arquivo de backup</p>
                                        <button class="btn btn-success btn-lg w-100" id="restaurar-simples">
                                            <i class="bi bi-upload me-2"></i>Restaurar Dados
                                        </button>
                                        <input type="file" id="input-backup-simples" accept=".json" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>Importante:</strong> O backup restaura TODOS os dados. Faça backup antes de restaurar se quiser manter os dados atuais.
                        </div>
                    </div>

                    <div class="config-item">
                        <h5>🔄 Migração de Dados (Avançado)</h5>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Dados em locais diferentes?</strong> Use esta ferramenta para migrar dados entre o arquivo HTML direto e o servidor web.
                        </div>
                        <button class="btn btn-warning me-2" id="migrar-dados">
                            <i class="bi bi-arrow-repeat me-1"></i> Migrar Dados do Arquivo HTML
                        </button>
                        <button class="btn btn-outline-info me-2" id="verificar-dados">
                            <i class="bi bi-search me-1"></i> Verificar Dados Disponíveis
                        </button>
                    </div>
                    
                    <div class="config-item">
                        <h5>Importar e Exportar Dados</h5>
                        <p>Importe ou exporte seus dados financeiros para backup ou análise externa</p>
                        <button class="btn btn-outline-primary me-2" id="exportar-csv">
                            <i class="bi bi-file-earmark-arrow-down me-1"></i> Exportar CSV
                        </button>
                        <button class="btn btn-outline-success me-2" id="importar-csv">
                            <i class="bi bi-file-earmark-arrow-up me-1"></i> Importar Backup
                        </button>
                        <button class="btn btn-outline-primary">
                            <i class="bi bi-file-earmark-text me-1"></i> Exportar PDF
                        </button>
                        <input type="file" id="input-importar-csv" accept=".csv,.zip" style="display: none;">
                    </div>
                    
                    <div class="config-item border-0">
                        <h5>Limpar Dados</h5>
                        <p>Remova todos os lançamentos financeiros (esta ação não pode ser desfeita)</p>
                        <button class="btn btn-outline-danger me-2" id="limpar-dados">
                            <i class="bi bi-trash me-1"></i> Limpar Todos os Dados
                        </button>
                        <button class="btn btn-outline-warning me-2" id="limpar-dados-invalidos">
                            <i class="bi bi-shield-check me-1"></i> Limpar Dados Inválidos
                        </button>
                        <button class="btn btn-outline-info" id="limpar-bancos-teste">
                            <i class="bi bi-bank me-1"></i> Limpar Bancos de Teste
                        </button>
                        <small class="d-block mt-2 text-muted">
                            O botão "Limpar Dados Inválidos" remove apenas contas e lançamentos corrompidos (como "undefined")<br>
                            O botão "Limpar Bancos de Teste" remove apenas os bancos com contas de teste, permitindo recadastrar suas contas reais
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Administração -->
        <div id="admin" class="page">
            <div class="row mb-4">
                <div class="col-12">
                    <h2><i class="bi bi-shield-check me-2"></i> Administração do Sistema</h2>
                    <p class="text-muted">Gerencie usuários e suas assinaturas</p>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="row mb-4">
                <div class="col-md-3 col-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">Total de Usuários</h5>
                            <h3 class="text-primary" id="total-usuarios">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">Assinaturas Premium</h5>
                            <h3 class="text-success" id="total-premium">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">Assinaturas Gratuitas</h5>
                            <h3 class="text-warning" id="total-free">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info">Assinaturas Ativas</h5>
                            <h3 class="text-info" id="total-ativas">0</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Usuários -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i> Usuários do Sistema</h5>
                    <button class="btn btn-primary btn-sm" onclick="carregarUsuarios()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Assinatura</th>
                                    <th>Status</th>
                                    <th>Data de Criação</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usuarios-lista">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Edição de Usuário -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editUserModalLabel">
                            <i class="bi bi-pencil-square me-2"></i>Editar Usuário
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editUserForm">
                            <input type="hidden" id="editUserId">
                            
                            <div class="mb-3">
                                <label class="form-label"><strong>Informações do Usuário</strong></label>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <p class="mb-1"><strong>ID:</strong> <span id="editUserIdDisplay"></span></p>
                                        <p class="mb-1"><strong>Nome:</strong> <span id="editUserName"></span></p>
                                        <p class="mb-0"><strong>Email:</strong> <span id="editUserEmail"></span></p>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="editSubscriptionType" class="form-label">Tipo de Assinatura</label>
                                <select class="form-select" id="editSubscriptionType" required>
                                    <option value="free">Gratuita</option>
                                    <option value="premium">Premium</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="editSubscriptionActive" class="form-label">Status da Assinatura</label>
                                <select class="form-select" id="editSubscriptionActive" required>
                                    <option value="true">Ativa</option>
                                    <option value="false">Inativa</option>
                                </select>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Dica:</strong> Usuários com assinatura inativa não terão acesso às funcionalidades premium, independentemente do tipo de assinatura.
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="salvarEdicaoUsuario()">
                            <i class="bi bi-check-circle me-1"></i>Salvar Alterações
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Investimentos -->
        <div id="investimentos" class="page">
            <div class="row mb-4">
                <div class="col-12">
                    <h2><i class="bi bi-graph-up me-2"></i> Gestão de Investimentos</h2>
                </div>
            </div>

            <!-- Dashboard de Investimentos -->
            <div class="row mb-4">
                <div class="col-md-2 col-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">Total Investido</h5>
                            <h3 class="text-primary" id="total-investido">R$ 0,00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">Valor Atual</h5>
                            <h3 class="text-success" id="valor-atual-investimentos">R$ 0,00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info">Valorização</h5>
                            <h3 class="text-info" id="rendimento-total">R$ 0,00</h3>
                            <small class="text-muted">Ganho/perda de capital</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-secondary">Dividendos e Rendimentos</h5>
                            <h3 class="text-secondary" id="total-dividendos-card">R$ 0,00</h3>
                            <small class="text-muted">Todos os rendimentos recebidos</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 col-12">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">Rentabilidade Total</h5>
                            <h3 class="text-warning" id="rentabilidade-completa">R$ 0,00 (0,00%)</h3>
                            <small class="text-muted">Valorização + dividendos</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="filtro-categoria-investimento" class="form-label">Categoria</label>
                            <select class="form-select" id="filtro-categoria-investimento">
                                <option value="">Todas as categorias</option>
                                <option value="renda-fixa">Renda Fixa</option>
                                <option value="acoes-br">Ações Brasileiras</option>
                                <option value="acoes-global">Ações Globais</option>
                                <option value="fundos">Fundos de Investimento</option>
                                <option value="fiis">Fundos Imobiliários</option>
                                <option value="reits">REITs</option>
                                <option value="etfs-br">ETFs Brasileiros</option>
                                <option value="etfs-us">ETFs Americanos</option>
                                <option value="criptomoedas">Criptomoedas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filtro-tipo-lancamento" class="form-label">Tipo de Lançamento</label>
                            <select class="form-select" id="filtro-tipo-lancamento">
                                <option value="">Todos</option>
                                <option value="compra">Compra</option>
                                <option value="venda">Venda</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filtro-corretora-investimento" class="form-label">Corretora</label>
                            <input type="text" class="form-control" id="filtro-corretora-investimento" placeholder="Digite a corretora...">
                        </div>
                        <div class="col-md-2">
                            <label for="filtro-data-inicio" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="filtro-data-inicio">
                        </div>
                        <div class="col-md-2">
                            <label for="filtro-data-fim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="filtro-data-fim">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-outline-primary w-100" onclick="aplicarFiltrosInvestimentos()">
                                <i class="bi bi-funnel me-1"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Investimentos -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-table me-2"></i> Histórico de Lançamentos</span>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" onclick="atualizarCotacoes()" id="btnAtualizarCotacoes">
                            <i class="bi bi-arrow-clockwise me-1"></i> Atualizar Cotações
                        </button>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#investimentoModal">
                            <i class="bi bi-plus-circle me-1"></i> Novo Lançamento
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabela-investimentos">
                            <thead>
                                <tr>
                                    <th>Ativo</th>
                                    <th>Data</th>
                                    <th>Categoria</th>
                                    <th>Corretora</th>
                                    <th>Quantidade</th>
                                    <th>Preço</th>
                                    <th>Valor Total</th>
                                    <th>Tipo de Lançamento</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Investimentos serão carregados dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Resumo de Ativos -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-pie-chart me-2"></i> Resumo de Ativos
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Renda Variável -->
                        <div class="col-12 mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-graph-up me-2"></i>Renda Variável
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped" id="tabela-resumo-renda-variavel">
                                    <thead>
                                        <tr>
                                            <th>Ativo</th>
                                            <th>Quantidade</th>
                                            <th>Valor Total</th>
                                            <th>Preço Médio</th>
                                            <th>Cotação Atual</th>
                                            <th>Valorização</th>
                                            <th>Dividendos</th>
                                            <th>Total Geral</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dados serão carregados dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Renda Fixa -->
                        <div class="col-12 mb-4">
                            <h5 class="text-success mb-3">
                                <i class="bi bi-bank me-2"></i>Renda Fixa
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped" id="tabela-resumo-renda-fixa">
                                    <thead>
                                        <tr>
                                            <th>Ativo</th>
                                            <th>Quantidade</th>
                                            <th>Valor Total</th>
                                            <th>Rendimentos</th>
                                            <th>Total Geral</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dados serão carregados dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Criptomoedas -->
                        <div class="col-12">
                            <h5 class="text-warning mb-3">
                                <i class="bi bi-currency-bitcoin me-2"></i>Criptomoedas
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped" id="tabela-resumo-criptomoedas">
                                    <thead>
                                        <tr>
                                            <th>Ativo</th>
                                            <th>Quantidade</th>
                                            <th>Valor Total</th>
                                            <th>Preço Médio</th>
                                            <th>Cotação Atual</th>
                                            <th>Valorização</th>
                                            <th>Total Geral</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dados serão carregados dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Dividendos e Rendimentos -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-cash-coin me-2"></i> Dividendos e Rendimentos</span>
                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#dividendoModal">
                        <i class="bi bi-plus-circle me-1"></i> Novo Rendimento
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="tabela-dividendos">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Ativo</th>
                                    <th>Tipo</th>
                                    <th>Valor</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dividendos serão carregados dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar/editar lançamento -->
    <div class="modal fade" id="lancamentoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLancamentoTitulo">Adicionar Lançamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="lancamentoForm">
                        <input type="hidden" id="lancamentoId">
                        <div class="mb-3">
                            <label for="data" class="form-label">Data</label>
                            <input type="date" class="form-control" id="data" required>
                        </div>
                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="descricao" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoriaModal" class="form-label">Categoria</label>
                            <select class="form-select" id="categoriaModal" required>
                                <option value="">Selecione uma categoria</option>
                                <!-- Categorias serão carregadas dinamicamente -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="bancoModal" class="form-label">Banco</label>
                            <div class="banco-select-wrapper">
                                <select class="form-select" id="bancoModal" required>
                                    <option value="">Selecione um banco</option>
                                    <!-- Bancos serão carregados dinamicamente -->
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="contaModal" class="form-label">Conta</label>
                            <select class="form-select" id="contaModal" required>
                                <option value="">Selecione uma conta</option>
                                <!-- Contas serão carregadas dinamicamente -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="tipo" id="entrada" value="entrada" checked>
                                    <label class="form-check-label" for="entrada">Entrada</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="tipo" id="saida" value="saida">
                                    <label class="form-check-label" for="saida">Saída</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3" id="tipoTransacaoDiv">
                            <label for="tipoTransacao" class="form-label">Método de Transação</label>
                            <select class="form-select" id="tipoTransacao" required>
                                <option value="">Selecione o método</option>
                                <option value="pix">PIX</option>
                                <option value="transferencia">Transferência</option>
                                <option value="debito">Cartão Débito</option>
                                <option value="credito">Cartão Crédito</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="ted">TED</option>
                                <option value="doc">DOC</option>
                                <option value="saldo_conta">Saldo da Conta</option>
                                <option value="transferencia_contas">Transferência entre Contas</option>
                            </select>
                        </div>
                        <div class="mb-3" id="cartaoDiv" style="display: none;">
                            <label for="cartaoModal" class="form-label">Cartão de Crédito</label>
                            <select class="form-select" id="cartaoModal">
                                <option value="">Selecione um cartão</option>
                                <!-- Cartões serão carregados dinamicamente -->
                            </select>
                        </div>
                        <div class="mb-3" id="contaDestinoDiv" style="display: none;">
                            <label for="contaDestino" class="form-label">Conta de Destino</label>
                            <input type="text" class="form-control" id="contaDestino" placeholder="Digite o nome da conta de destino">
                        </div>
                        <div class="mb-3">
                            <label for="valor" class="form-label">Valor</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="valor" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="status" id="realizado" value="realizado" checked>
                                    <label class="form-check-label" for="realizado">
                                        <i class="bi bi-check-circle text-success me-1"></i>Realizado
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="status" id="previsto" value="previsto">
                                    <label class="form-check-label" for="previsto">
                                        <i class="bi bi-clock text-warning me-1"></i>Previsto
                                    </label>
                                </div>
                            </div>
                            <small class="form-text text-muted">Lançamentos previstos não afetam o saldo atual, apenas o saldo futuro.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarLancamento">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para transferência entre contas -->
    <div class="modal fade" id="transferenciaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-arrow-left-right me-2"></i>
                        Transferência entre Contas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transferenciaForm">
                        <div class="mb-3">
                            <label for="dataTransferencia" class="form-label">Data</label>
                            <input type="date" class="form-control" id="dataTransferencia" required>
                        </div>
                        <div class="mb-3">
                            <label for="descricaoTransferencia" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="descricaoTransferencia" placeholder="Ex: Transferência para poupança" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="banco-origem-transferencia" class="form-label">Banco de Origem</label>
                                    <select class="form-select" id="banco-origem-transferencia" onchange="carregarContasTransferencia(this.value, 'conta-origem-transferencia')" required>
                                        <option value="">Selecione o banco</option>
                                        <!-- Bancos serão carregados dinamicamente -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="conta-origem-transferencia" class="form-label">Conta de Origem</label>
                                    <select class="form-select" id="conta-origem-transferencia" required>
                                        <option value="">Selecione a conta</option>
                                        <!-- Contas serão carregadas dinamicamente -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="banco-destino-transferencia" class="form-label">Banco de Destino</label>
                                    <select class="form-select" id="banco-destino-transferencia" onchange="carregarContasTransferencia(this.value, 'conta-destino-transferencia')" required>
                                        <option value="">Selecione o banco</option>
                                        <!-- Bancos serão carregados dinamicamente -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="conta-destino-transferencia" class="form-label">Conta de Destino</label>
                                    <select class="form-select" id="conta-destino-transferencia" required>
                                        <option value="">Selecione a conta</option>
                                        <!-- Contas serão carregadas dinamicamente -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="valor-transferencia" class="form-label">Valor</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="valor-transferencia" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="categoria-transferencia" class="form-label">Categoria</label>
                            <select class="form-select" id="categoria-transferencia" required>
                                <option value="">Selecione uma categoria</option>
                                <!-- Categorias serão carregadas dinamicamente -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="status-transferencia" id="efetivada-transferencia" value="efetivada" checked>
                                    <label class="form-check-label" for="efetivada-transferencia">Efetivada</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="status-transferencia" id="pendente-transferencia" value="pendente">
                                    <label class="form-check-label" for="pendente-transferencia">Pendente</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarTransferencia()">
                        <i class="bi bi-check-lg me-1"></i>
                        Realizar Transferência
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmação para exclusão -->
    <div class="modal fade" id="confirmacaoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir este lançamento?</p>
                    <p class="fw-bold" id="lancamento-descricao"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarExclusao">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar/editar investimento -->
    <div class="modal fade" id="investimentoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalInvestimentoTitulo">Adicionar Lançamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="investimentoForm">
                        <input type="hidden" id="investimentoId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ativo" class="form-label">Nome do Ativo</label>
                                    <div class="input-group">
                                        <select class="form-select" id="ativo-select" onchange="selecionarAtivo()">
                                            <option value="">Selecione um ativo</option>
                                            <option value="novo">+ Cadastrar novo ativo</option>
                                        </select>
                                        <input type="text" class="form-control d-none" id="ativo" required placeholder="Ex: PETR4, ITUB4, TESOURO SELIC">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="categoria-investimento" class="form-label">Categoria</label>
                                    <select class="form-select" id="categoria-investimento" required onchange="alternarCamposCategoria()">
                                        <option value="">Selecione uma categoria</option>
                                        <option value="renda-fixa">Renda Fixa (CDB, LCI, LCA, Tesouro Direto)</option>
                                        <option value="acoes-br">Ações Brasileiras</option>
                                        <option value="acoes-global">Ações Globais</option>
                                        <option value="fundos">Fundos de Investimento</option>
                                        <option value="fiis">Fundos Imobiliários (FIIs)</option>
                                        <option value="reits">REITs</option>
                                        <option value="etfs-br">ETFs Brasileiros</option>
                                        <option value="etfs-us">ETFs Americanos</option>
                                        <option value="criptomoedas">Criptomoedas (Bitcoin, Ethereum, etc.)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="corretora" class="form-label">Corretora</label>
                                    <div class="input-group">
                                        <select class="form-select" id="corretora-select" onchange="selecionarCorretora()">
                                            <option value="">Selecione uma corretora</option>
                                            <option value="nova">+ Cadastrar nova corretora</option>
                                        </select>
                                        <input type="text" class="form-control d-none" id="corretora" required placeholder="Ex: XP, Rico, Clear, Inter">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="data-compra" class="form-label">Data da Compra</label>
                                    <input type="date" class="form-control" id="data-compra" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <!-- Campos para Renda Variável e Renda Fixa -->
                            <div class="col-md-4" id="campo-quantidade-tradicional">
                                <div class="mb-3">
                                    <label for="quantidade" class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="quantidade" step="0.01" required placeholder="Ex: 100">
                                </div>
                            </div>
                            <div class="col-md-4" id="campo-preco-compra-tradicional">
                                <div class="mb-3">
                                    <label for="preco-compra" class="form-label">Preço de Compra (R$)</label>
                                    <input type="number" class="form-control" id="preco-compra" step="0.01" required placeholder="Ex: 25.50">
                                </div>
                            </div>
                            
                            <!-- Campo para Criptomoedas -->
                            <div class="col-md-4 d-none" id="campo-valor-investido">
                                <div class="mb-3">
                                    <label for="valor-investido" class="form-label">Valor Investido (R$)</label>
                                    <input type="number" class="form-control" id="valor-investido" step="0.01" placeholder="Ex: 500.00">
                                </div>
                            </div>
                            <div class="col-md-4 d-none" id="campo-cotacao-compra">
                                <div class="mb-3">
                                    <label for="cotacao-compra" class="form-label">Cotação na Compra (R$)</label>
                                    <input type="number" class="form-control" id="cotacao-compra" step="0.01" placeholder="Ex: 350000.00">
                                </div>
                            </div>
                            
                            <!-- Campo para Renda Fixa -->
                            <div class="col-md-4 d-none" id="campo-percentual-cdi">
                                <div class="mb-3">
                                    <label for="percentual-cdi" class="form-label">% do CDI</label>
                                    <input type="number" class="form-control" id="percentual-cdi" step="0.01" placeholder="Ex: 100.00">
                                    <small class="text-muted">Percentual do CDI que este ativo rende</small>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="preco-atual" class="form-label">Preço Atual (R$)</label>
                                    <input type="number" class="form-control" id="preco-atual" step="0.01" placeholder="Ex: 28.75">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tipo-lancamento" class="form-label">Tipo de Lançamento</label>
                                    <select class="form-select" id="tipo-lancamento" required>
                                        <option value="compra">Compra</option>
                                        <option value="venda">Venda</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="data-vencimento" class="form-label">Data de Vencimento (opcional)</label>
                                    <input type="date" class="form-control" id="data-vencimento">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="observacoes-investimento" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes-investimento" rows="3" placeholder="Informações adicionais sobre o investimento"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarInvestimento()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar dividendo/rendimento -->
    <div class="modal fade" id="dividendoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDividendoTitulo">Adicionar Dividendo/Rendimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dividendoForm">
                        <input type="hidden" id="dividendoId">
                        <div class="mb-3">
                            <label for="data-dividendo" class="form-label">Data</label>
                            <input type="date" class="form-control" id="data-dividendo" required>
                        </div>
                        <div class="mb-3">
                            <label for="ativo-dividendo" class="form-label">Ativo</label>
                            <select class="form-select" id="ativo-dividendo" required>
                                <option value="">Selecione um ativo</option>
                                <!-- Ativos serão carregados dinamicamente -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="tipo-rendimento" class="form-label">Tipo de Rendimento</label>
                            <select class="form-select" id="tipo-rendimento" required>
                                <option value="">Selecione o tipo</option>
                                <option value="dividendo">Dividendo</option>
                                <option value="jcp">Juros sobre Capital Próprio (JCP)</option>
                                <option value="rendimento">Rendimento (Renda Fixa)</option>
                                <option value="aluguel">Aluguel (FII/REIT)</option>
                                <option value="bonificacao">Bonificação</option>
                                <option value="split">Split/Desdobramento</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="valor-dividendo" class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control" id="valor-dividendo" step="0.01" required placeholder="Ex: 150.00">
                        </div>
                        <div class="mb-3">
                            <label for="observacoes-dividendo" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes-dividendo" rows="2" placeholder="Informações adicionais"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="salvarDividendo()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para lançamento de rendimento de renda fixa -->
    <!-- Modal de confirmação para exclusão de investimento -->
    <div class="modal fade" id="confirmacaoInvestimentoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir este investimento?</p>
                    <p class="fw-bold" id="investimento-descricao"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarExclusaoInvestimento">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3" id="main-footer">
        <div class="container text-center">
            <p class="mb-0">Sistema de Gerenciamento de Fluxo de Caixa &copy; 2025</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dados da aplicação - Iniciando vazios
        let lancamentos = [];
        let saldoInicial = 0.00;
        let nextId = 1;
        let lancamentoParaExcluir = null;
        let modoEdicao = false;
        
        // Dados de investimentos
        let investimentos = [];
        let dividendos = [];
        let nextInvestimentoId = 1;
        let nextDividendoId = 1;
        let investimentoParaExcluir = null;
        let modoEdicaoInvestimento = false;
        let comparativoChart = null;
        let evolucaoChart = null;
        let orcamentos = []; // Array para armazenar os orçamentos por categoria
        
        // Dados de ativos e corretoras
        let ativos = []; // Array para armazenar tickers cadastrados
        let corretoras = []; // Array para armazenar corretoras cadastradas
        
        // Dados de bancos e cartões
        let bancos = []; // Array para armazenar bancos e contas
        
        let cartoes = []; // Array para armazenar cartões de crédito


        // Categorias padrão
        let categorias = ['Alimentação', 'Transporte', 'Lazer', 'Salário', 'Moradia', 'Saúde'];
        
        // Tema da aplicação
        let tema = 'light';

        // Nomes dos meses
        const meses = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        // Dados de usuário
        let usuarioAtual = null;
        let usuarios = [];
        let sessaoTemporaria = false; // Controla se a sessão deve ser encerrada ao fechar a página
        
        // Função para identificar origem do usuário
        function isUsuarioDoBanco() {
            if (!usuarioAtual) return false;
            // Se tem 'id' numérico, é do banco Neon
            return usuarioAtual.hasOwnProperty('id') && typeof usuarioAtual.id === 'number';
        }
        
        function getUsuarioInfo() {
            if (!usuarioAtual) return { origem: 'nenhum', usuario: null };
            
            if (isUsuarioDoBanco()) {
                return {
                    origem: 'banco_neon',
                    usuario: usuarioAtual,
                    id_banco: usuarioAtual.id,
                    subscription_centralizada: true,
                    dados_financeiros: 'localStorage'
                };
            } else {
                return {
                    origem: 'localStorage',
                    usuario: usuarioAtual,
                    id_banco: null,
                    subscription_centralizada: false,
                    dados_financeiros: 'localStorage'
                };
            }
        }
        
        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Iniciando aplicação...');
            console.log('📊 Chart.js disponível:', typeof Chart !== 'undefined');
            console.log('🎯 Bootstrap disponível:', typeof bootstrap !== 'undefined');
            
            // Verificar se há usuário logado (carregarDadosSalvos será chamado dentro desta função se necessário)
            console.log('🔐 Verificando autenticação...');
            verificarAutenticacao();
            
            // Exemplo de uso das funções de identificação (após login)
            setTimeout(() => {
                if (usuarioAtual) {
                    const info = getUsuarioInfo();
                    console.log('👤 Informações do usuário:', info);
                    
                    if (isUsuarioDoBanco()) {
                        console.log('🏦 Usuário autenticado via banco Neon');
                        console.log('🆔 ID no banco:', usuarioAtual.id);
                        console.log('📊 Subscription centralizada:', usuarioAtual.subscription_type);
                    } else {
                        console.log('💾 Usuário autenticado via localStorage');
                        console.log('📧 Identificado por email:', usuarioAtual.email);
                        console.log('⚠️ Subscription apenas local');
                    }
                }
            }, 1000);
            // Configurar upload de foto
            configurarUploadFoto();
            
            // Adicionar evento para desconectar ao fechar a página
            window.addEventListener('beforeunload', function() {
                if (sessaoTemporaria && usuarioAtual) {
                    localStorage.removeItem('financasUsuarioLogado');
                    sessionStorage.removeItem('financasUsuarioLogado');
                }
            });

            // ========================================
            // MÉTODOS ALTERNATIVOS DE LOGOUT
            // ========================================

            // 1. Logout por combinação de teclas (Ctrl+Shift+L)
            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey && event.shiftKey && event.key === 'L' && usuarioAtual) {
                    event.preventDefault();
                    console.log('🔑 Logout ativado por teclas de atalho');
                    fazerLogout();
                }
            });

            // 2. Logout por clique triplo no logo/título
            let clickCount = 0;
            let clickTimer = null;
            const navbarBrand = document.querySelector('.navbar-brand');
            if (navbarBrand) {
                navbarBrand.addEventListener('click', function(event) {
                    clickCount++;
                    if (clickCount === 1) {
                        clickTimer = setTimeout(() => {
                            clickCount = 0;
                        }, 1000);
                    } else if (clickCount === 3 && usuarioAtual) {
                        clearTimeout(clickTimer);
                        clickCount = 0;
                        event.preventDefault();
                        if (confirm('🔒 Deseja fazer logout?\n\n(Clique triplo detectado no logo)')) {
                            console.log('🔑 Logout ativado por clique triplo no logo');
                            fazerLogout();
                        }
                    }
                });
            }

            // 3. Logout por comando no console
            window.forcarLogout = function() {
                if (usuarioAtual) {
                    console.log('🔑 Logout forçado via console');
                    fazerLogout();
                    return '✅ Logout realizado com sucesso!';
                } else {
                    return '⚠️ Nenhum usuário logado.';
                }
            };

            // 4. Logout por URL especial
            function verificarLogoutPorURL() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('logout') === 'force' && usuarioAtual) {
                    console.log('🔑 Logout ativado por parâmetro URL');
                    fazerLogout();
                }
            }
            verificarLogoutPorURL();

            // 5. Mostrar métodos de logout no console
            if (usuarioAtual) {
                console.log('🔑 MÉTODOS ALTERNATIVOS DE LOGOUT DISPONÍVEIS:');
                console.log('1. Teclas: Ctrl+Shift+L');
                console.log('2. Clique triplo no logo "Finanças Pessoais"');
                console.log('3. Console: forcarLogout()');
                console.log('4. URL: adicione ?logout=force na URL');
            }
            
            // Configurar data atual no formulário
            const dataAtual = new Date();
            document.getElementById('data').value = dataAtual.toISOString().split('T')[0];
            
            // Carregar categorias nos selects
            carregarCategorias();
            
            // Carregar bancos nos selects
            carregarBancos();
            
            // Inicializar gráficos
            console.log('📊 Inicializando gráficos...');
            inicializarGraficos();
            
            // Carregar filtros baseados nos dados existentes
            console.log('🔍 Atualizando filtros...');
            atualizarFiltros();
            
            // Aplicar filtros iniciais e atualizar gráficos
            console.log('🎯 Aplicando filtros...');
            aplicarFiltros();
            
            // Garantir que o dashboard seja atualizado
            console.log('📈 Atualizando dashboard...');
            atualizarDashboard();
            
            // Configurar navegação entre páginas
            console.log('🧭 Configurando navegação...');
            configurarNavegacao();
            
            // Configurar alternância entre filtros mensal e anual
            console.log('📅 Configurando filtros de período...');
            configurarFiltrosPeriodo();
            
            // Inicializar relatórios avançados
            inicializarRelatorios();
            
            // Configurar eventos do gráfico
            configurarEventosGrafico();
            
            // Configurar tema escuro
            console.log('🌙 Configurando tema...');
            configurarTema();
            
            // Verificar alertas de orçamento
            console.log('⚠️ Verificando alertas...');
            verificarAlertasOrcamento();
            
            console.log('✅ Aplicação inicializada com sucesso!');
            
            // Event listeners
            document.getElementById('aplicarFiltros').addEventListener('click', aplicarFiltros);
            document.getElementById('limparFiltros').addEventListener('click', limparFiltros);
            document.getElementById('salvarLancamento').addEventListener('click', salvarLancamento);
            document.getElementById('confirmarExclusao').addEventListener('click', excluirLancamento);
            document.getElementById('adicionar-categoria').addEventListener('click', adicionarCategoria);
            document.getElementById('limpar-dados').addEventListener('click', limparDados);
        document.getElementById('limpar-dados-invalidos').addEventListener('click', limparDadosInvalidos);
            document.getElementById('limpar-bancos-teste').addEventListener('click', limparBancosTeste);
            document.getElementById('exportar-csv').addEventListener('click', exportarCSV);
            document.getElementById('importar-csv').addEventListener('click', function() {
                document.getElementById('input-importar-csv').click();
            });
            document.getElementById('input-importar-csv').addEventListener('change', importarCSV);
            
            // Event listeners para backup simplificado
            document.getElementById('backup-simples').addEventListener('click', criarBackupSimples);
            document.getElementById('restaurar-simples').addEventListener('click', function() {
                document.getElementById('input-backup-simples').click();
            });
            document.getElementById('input-backup-simples').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    restaurarBackupSimples(e.target.files[0]);
                    e.target.value = ''; // Limpar input para permitir selecionar o mesmo arquivo novamente
                }
            });
            
            document.getElementById('migrar-dados').addEventListener('click', migrarDadosHTML);
            document.getElementById('verificar-dados').addEventListener('click', verificarDadosDisponiveis);
            document.getElementById('salvar-saldo-inicial').addEventListener('click', salvarSaldoInicial);
            document.getElementById('gerar-relatorio').addEventListener('click', gerarRelatorio);
            document.getElementById('theme-toggle').addEventListener('change', alternarTema);
            document.getElementById('salvar-orcamento').addEventListener('click', salvarOrcamento);
            
            // Event listeners para autenticação
            document.getElementById('login-form').addEventListener('submit', fazerLogin);
            document.getElementById('criar-conta-btn').addEventListener('click', abrirModalRegistro);
            document.getElementById('salvar-registro').addEventListener('click', criarConta);
            document.getElementById('cancelar-registro').addEventListener('click', cancelarRegistro);
            document.getElementById('registro-senha').addEventListener('input', verificarForcaSenha);
            document.getElementById('registro-confirmar-senha').addEventListener('input', verificarSenhasIguais);
            
            // Event listener para botões de mostrar/ocultar senha
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', togglePasswordVisibility);
            });
            
            // Adicionar botão de logout na navbar
            const navbarNav = document.querySelector('#navbarNav .navbar-nav');
            const logoutItem = document.createElement('li');
            logoutItem.className = 'nav-item';
            logoutItem.innerHTML = `
                <a class="nav-link" href="#" id="logout-btn">
                    <i class="bi bi-box-arrow-right me-1"></i> Sair
                </a>
            `;
            navbarNav.appendChild(logoutItem);
            document.getElementById('logout-btn').addEventListener('click', fazerLogout);
            
            // Event listener para recarregar categorias quando o modal de lançamentos for aberto
            document.getElementById('lancamentoModal').addEventListener('shown.bs.modal', function() {
                carregarCategorias();
                carregarBancos();
            });
            
            // Delegation de eventos para botões dinâmicos
            document.getElementById('tabela-lancamentos').addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-excluir') || e.target.closest('.btn-excluir')) {
                    const id = e.target.closest('tr').dataset.id;
                    console.log('=== BOTÃO EXCLUIR CLICADO ===');
                    console.log('ID original:', id);
                    console.log('Tipo do ID:', typeof id);
                    // Manter ID como string se contém sufixos de transferência, senão converter para número
                    const idProcessado = (id.includes('_entrada') || id.includes('_saida') || id.includes('_transfer')) ? id : (isNaN(parseInt(id)) ? id : parseInt(id));
                    console.log('ID processado:', idProcessado);
                    console.log('Tipo do ID processado:', typeof idProcessado);
                    confirmarExclusao(idProcessado);
                }
                
                if (e.target.classList.contains('btn-editar') || e.target.closest('.btn-editar')) {
                    const id = e.target.closest('tr').dataset.id;
                    console.log('=== BOTÃO EDITAR CLICADO ===');
                    console.log('ID original:', id);
                    console.log('Tipo do ID:', typeof id);
                    // Manter ID como string se contém sufixos de transferência, senão converter para número
                    const idProcessado = (id.includes('_entrada') || id.includes('_saida') || id.includes('_transfer')) ? id : (isNaN(parseInt(id)) ? id : parseInt(id));
                    console.log('ID processado:', idProcessado);
                    console.log('Tipo do ID processado:', typeof idProcessado);
                    editarLancamento(idProcessado);
                }
                
                if (e.target.classList.contains('btn-excluir-direto') || e.target.closest('.btn-excluir-direto')) {
                    const id = e.target.closest('tr').dataset.id;
                    console.log('=== BOTÃO EXCLUIR DIRETO CLICADO ===');
                    console.log('ID original:', id);
                    console.log('Tipo do ID:', typeof id);
                    // Manter ID como string se contém sufixos de transferência, senão converter para número
                    const idProcessado = (id.includes('_entrada') || id.includes('_saida') || id.includes('_transfer')) ? id : (isNaN(parseInt(id)) ? id : parseInt(id));
                    console.log('ID processado:', idProcessado);
                    console.log('Tipo do ID processado:', typeof idProcessado);
                    excluirLancamentoDireto(idProcessado);
                }
                
                if (e.target.classList.contains('btn-marcar-realizado') || e.target.closest('.btn-marcar-realizado')) {
                    const id = e.target.closest('tr').dataset.id;
                    console.log('=== BOTÃO MARCAR REALIZADO CLICADO ===');
                    console.log('ID original:', id);
                    console.log('Tipo do ID:', typeof id);
                    // Manter ID como string se contém sufixos de transferência, senão converter para número
                    const idProcessado = (id.includes('_entrada') || id.includes('_saida') || id.includes('_transfer')) ? id : (isNaN(parseInt(id)) ? id : parseInt(id));
                    console.log('ID processado:', idProcessado);
                    console.log('Tipo do ID processado:', typeof idProcessado);
                    marcarComoRealizado(idProcessado);
                }
            });
            
            document.getElementById('lista-categorias').addEventListener('click', function(e) {
                if (e.target.classList.contains('remover-categoria')) {
                    removerCategoria(e.target.closest('li'));
                }
            });
            
            // Event listener para tabela de orçamentos
            document.getElementById('tabela-orcamentos').addEventListener('click', function(e) {
                if (e.target.classList.contains('remover-orcamento')) {
                    removerOrcamento(e.target.closest('tr').dataset.categoria);
                }
            });
        });

        // Funções para salvar e carregar dados
        function salvarDados() {
            if (!usuarioAtual) return;
            
            const userPrefix = `financas_${usuarioAtual.email}_`;
            
            localStorage.setItem(`${userPrefix}Lancamentos`, JSON.stringify(lancamentos));
            localStorage.setItem(`${userPrefix}SaldoInicial`, saldoInicial.toString());
            localStorage.setItem(`${userPrefix}NextId`, nextId.toString());
            localStorage.setItem(`${userPrefix}Categorias`, JSON.stringify(categorias));
            localStorage.setItem(`${userPrefix}Orcamentos`, JSON.stringify(orcamentos));
            localStorage.setItem(`${userPrefix}Investimentos`, JSON.stringify(investimentos));
            localStorage.setItem(`${userPrefix}Dividendos`, JSON.stringify(dividendos));

            localStorage.setItem(`${userPrefix}NextInvestimentoId`, nextInvestimentoId.toString());
            localStorage.setItem(`${userPrefix}NextDividendoId`, nextDividendoId.toString());
            localStorage.setItem(`${userPrefix}Ativos`, JSON.stringify(ativos));
            localStorage.setItem(`${userPrefix}Corretoras`, JSON.stringify(corretoras));
            localStorage.setItem(`${userPrefix}Bancos`, JSON.stringify(bancos));
            localStorage.setItem(`${userPrefix}Cartoes`, JSON.stringify(cartoes));
            localStorage.setItem('financasTema', document.body.getAttribute('data-theme') || 'light');
        }

        function carregarDadosSalvos() {
            if (!usuarioAtual) {
                console.log('⚠️ carregarDadosSalvos: usuarioAtual é null, retornando...');
                return;
            }
            
            const userPrefix = `financas_${usuarioAtual.email}_`;
            console.log(`📂 carregarDadosSalvos: Carregando dados para ${usuarioAtual.email}`);
            
            // Carregar lançamentos
            const lancamentosSalvos = localStorage.getItem(`${userPrefix}Lancamentos`);
            if (lancamentosSalvos) {
                lancamentos = JSON.parse(lancamentosSalvos);
                console.log(`✅ carregarDadosSalvos: ${lancamentos.length} lançamentos carregados`);
                
                // DEBUG: Mostrar todos os lançamentos carregados
                console.log('🔍 DEBUG LANÇAMENTOS CARREGADOS:');
                lancamentos.forEach(l => {
                    console.log(`   ID: ${l.id} | Data: ${l.data} | Desc: ${l.descricao} | Tipo: ${l.tipo} | Valor: ${l.valor}`);
                });
                
                // Verificar transferências duplicadas
                const transferencias = lancamentos.filter(l => l.tipoTransacao === 'transferencia_contas');
                console.log(`🔍 VERIFICANDO TRANSFERÊNCIAS: ${transferencias.length} encontradas`);
                transferencias.forEach(t => {
                    console.log(`   ID: ${t.id} | Banco: ${t.bancoId} | Tipo: ${t.tipo} | Valor: ${t.valor} | Desc: ${t.descricao}`);
                });
            } else {
                lancamentos = [];
                console.log('⚠️ carregarDadosSalvos: Nenhum lançamento salvo encontrado, array zerado');
            }
            
            // Carregar saldo inicial
            const saldoInicialSalvo = localStorage.getItem(`${userPrefix}SaldoInicial`);
            if (saldoInicialSalvo) {
                saldoInicial = parseFloat(saldoInicialSalvo);
                document.getElementById('saldo-inicial-input').value = saldoInicial;
            } else {
                saldoInicial = 0.00;
            }
            
            // Carregar próximo ID
            const nextIdSalvo = localStorage.getItem(`${userPrefix}NextId`);
            if (nextIdSalvo) {
                nextId = parseInt(nextIdSalvo);
            } else {
                nextId = 1;
            }
            
            // Carregar categorias
            const categoriasSalvas = localStorage.getItem(`${userPrefix}Categorias`);
            if (categoriasSalvas) {
                categorias = JSON.parse(categoriasSalvas);
            } else {
                categorias = ['Alimentação', 'Transporte', 'Lazer', 'Salário', 'Moradia', 'Saúde'];
            }
            
            // Carregar orçamentos
            const orcamentosSalvos = localStorage.getItem(`${userPrefix}Orcamentos`);
            if (orcamentosSalvos) {
                orcamentos = JSON.parse(orcamentosSalvos);
            } else {
                orcamentos = [];
            }
            
            // Carregar investimentos
            const investimentosSalvos = localStorage.getItem(`${userPrefix}Investimentos`);
            if (investimentosSalvos) {
                investimentos = JSON.parse(investimentosSalvos);
                console.log(`✅ carregarDadosSalvos: ${investimentos.length} investimentos carregados`);
            } else {
                investimentos = [];
                console.log('⚠️ carregarDadosSalvos: Nenhum investimento salvo encontrado, array zerado');
            }
            
            // Carregar dividendos
            const dividendosSalvos = localStorage.getItem(`${userPrefix}Dividendos`);
            if (dividendosSalvos) {
                dividendos = JSON.parse(dividendosSalvos);
                console.log(`✅ carregarDadosSalvos: ${dividendos.length} dividendos carregados`);
            } else {
                dividendos = [];
                console.log('⚠️ carregarDadosSalvos: Nenhum dividendo salvo encontrado, array zerado');
            }
            

            
            // Carregar próximo ID de investimento
            const nextInvestimentoIdSalvo = localStorage.getItem(`${userPrefix}NextInvestimentoId`);
            if (nextInvestimentoIdSalvo) {
                nextInvestimentoId = parseInt(nextInvestimentoIdSalvo);
            } else {
                nextInvestimentoId = 1;
            }
            
            // Carregar próximo ID de dividendo
            const nextDividendoIdSalvo = localStorage.getItem(`${userPrefix}NextDividendoId`);
            if (nextDividendoIdSalvo) {
                nextDividendoId = parseInt(nextDividendoIdSalvo);
            } else {
                nextDividendoId = 1;
            }
            
            // Carregar ativos
            const ativosSalvos = localStorage.getItem(`${userPrefix}Ativos`);
            if (ativosSalvos) {
                ativos = JSON.parse(ativosSalvos);
            } else {
                ativos = [];
            }
            
            // Carregar corretoras
            const corretorasSalvas = localStorage.getItem(`${userPrefix}Corretoras`);
            if (corretorasSalvas) {
                corretoras = JSON.parse(corretorasSalvas);
            } else {
                corretoras = [];
            }
            
            // Carregar bancos
            const bancosSalvos = localStorage.getItem(`${userPrefix}Bancos`);
            if (bancosSalvos) {
                bancos = JSON.parse(bancosSalvos);
                console.log(`✅ carregarDadosSalvos: ${bancos.length} bancos carregados`);
            } else {
                bancos = [];
                console.log('⚠️ carregarDadosSalvos: Nenhum banco salvo encontrado, array zerado');
            }
            
            // Carregar cartões
            const cartoesSalvos = localStorage.getItem(`${userPrefix}Cartoes`);
            if (cartoesSalvos) {
                cartoes = JSON.parse(cartoesSalvos);
                console.log(`✅ carregarDadosSalvos: ${cartoes.length} cartões carregados`);
            } else {
                cartoes = [];
                console.log('⚠️ carregarDadosSalvos: Nenhum cartão salvo encontrado, array zerado');
            }
            
            // Carregar tema
            const temaSalvo = localStorage.getItem('financasTema');
            if (temaSalvo) {
                document.body.setAttribute('data-theme', temaSalvo);
                document.getElementById('theme-toggle').checked = (temaSalvo === 'dark');
                atualizarIconeTema(temaSalvo === 'dark');
            }
            
            // Migrar contas antigas se necessário
            if (bancos.length > 0) {
                console.log('🔄 DEBUG: Migrando contas antigas...');
                migrarContasAntigas();
            }
            
            // Adicionar bancos de exemplo apenas se não existirem E se for um novo usuário
            if (bancos.length === 0) {
                console.log('🏦 DEBUG: Nenhum banco encontrado, inicializando exemplos');
                inicializarBancosExemplo();
                console.log(`🏦 DEBUG: Após inicialização: ${bancos.length} bancos criados`);
            } else {
                console.log(`🏦 DEBUG: ${bancos.length} bancos já existem, não inicializando exemplos`);
            }
            
            // Adicionar investimentos de exemplo apenas se não existirem
            if (investimentos.length === 0) {
                console.log('📈 DEBUG: Nenhum investimento encontrado, inicializando exemplos');
                inicializarInvestimentosExemplo();
                console.log(`📈 DEBUG: Após inicialização: ${investimentos.length} investimentos criados`);
            } else {
                console.log(`📈 DEBUG: ${investimentos.length} investimentos já existem, não inicializando exemplos`);
            }
            
            // Adicionar ativos de exemplo apenas se não existirem
            if (ativos.length === 0) {
                console.log('🏢 DEBUG: Nenhum ativo encontrado, inicializando exemplos');
                inicializarAtivosExemplo();
                console.log(`🏢 DEBUG: Após inicialização: ${ativos.length} ativos criados`);
            } else {
                console.log(`🏢 DEBUG: ${ativos.length} ativos já existem, não inicializando exemplos`);
            }
            
            // Adicionar corretoras de exemplo apenas se não existirem
            if (corretoras.length === 0) {
                console.log('🏛️ DEBUG: Nenhuma corretora encontrada, inicializando exemplos');
                inicializarCorretorasExemplo();
                console.log(`🏛️ DEBUG: Após inicialização: ${corretoras.length} corretoras criadas`);
            } else {
                console.log(`🏛️ DEBUG: ${corretoras.length} corretoras já existem, não inicializando exemplos`);
            }
            
            // Carregar lançamentos na interface após carregar os dados
            console.log('🔄 Carregando lançamentos na interface...');
            carregarLancamentos();
        }

        // Função para limpar transferências duplicadas (antigas)
        function limparTransferenciasDuplicadas() {
            console.log('🧹 LIMPANDO TRANSFERÊNCIAS DUPLICADAS ANTIGAS...');
            const transferenciasAntes = lancamentos.filter(l => l.tipoTransacao === 'transferencia_contas').length;
            
            // Remover apenas transferências antigas (tipo entrada/saída), manter as novas (tipo transferência)
            lancamentos = lancamentos.filter(l => {
                if (l.tipoTransacao === 'transferencia_contas') {
                    // Manter transferências novas (tipo 'transferencia')
                    if (l.tipo === 'transferencia') {
                        return true;
                    }
                    // Remover transferências antigas (tipo 'entrada' ou 'saida')
                    return false;
                }
                return true;
            });
            
            const transferenciasDepois = lancamentos.filter(l => l.tipoTransacao === 'transferencia_contas').length;
            console.log(`✅ Transferências antigas removidas: ${transferenciasAntes} → ${transferenciasDepois}`);
            
            salvarDados();
            atualizarDashboard();
            exibirLancamentos();
        }

        function atualizarFiltros() {
            // Extrair anos únicos dos lançamentos
            const anosUnicos = [...new Set(lancamentos.map(l => new Date(l.data).getFullYear()))].sort((a, b) => b - a);
            
            // Obter o ano selecionado no filtro ou usar o ano atual como padrão
            const anoAtual = new Date().getFullYear();
            const anoSelecionado = document.getElementById('ano') ? 
                (document.getElementById('ano').value || anoAtual) : anoAtual;
            
            // Extrair meses únicos dos lançamentos para o ano selecionado
            const mesesUnicos = [...new Set(lancamentos
                .filter(l => new Date(l.data).getFullYear() == anoSelecionado)
                .map(l => new Date(l.data).getMonth())
            )].sort((a, b) => a - b);
            
            // Extrair categorias únicas dos lançamentos
            const categoriasUnicas = [...new Set(lancamentos.map(l => l.categoria))].sort();
            
            // Atualizar select de anos
            const selectAno = document.getElementById('ano');
            const selectAnoAnual = document.getElementById('anoAnual');
            
            selectAno.innerHTML = '';
            selectAnoAnual.innerHTML = '';
            
            if (anosUnicos.length > 0) {
                anosUnicos.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    if (ano === anoAtual) option.selected = true;
                    selectAno.appendChild(option.cloneNode(true));
                    selectAnoAnual.appendChild(option);
                });
            } else {
                // Se não houver lançamentos, usar ano atual
                const option = document.createElement('option');
                option.value = anoAtual;
                option.textContent = anoAtual;
                option.selected = true;
                selectAno.appendChild(option.cloneNode(true));
                selectAnoAnual.appendChild(option);
            }
            
            // Atualizar select de meses
            const selectMes = document.getElementById('mes');
            selectMes.innerHTML = '';
            
            if (mesesUnicos.length > 0) {
                mesesUnicos.forEach(mes => {
                    const option = document.createElement('option');
                    option.value = mes;
                    option.textContent = meses[mes];
                    if (mes === new Date().getMonth()) option.selected = true;
                    selectMes.appendChild(option);
                });
            } else {
                // Se não houver lançamentos, usar mês atual
                const mesAtual = new Date().getMonth();
                const option = document.createElement('option');
                option.value = mesAtual;
                option.textContent = meses[mesAtual];
                option.selected = true;
                selectMes.appendChild(option);
            }
            
            // Atualizar select de categorias
            const selectCategoria = document.getElementById('categoria');
            selectCategoria.innerHTML = '<option value="">Todas as categorias</option>';
            
            if (categoriasUnicas.length > 0) {
                categoriasUnicas.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    selectCategoria.appendChild(option);
                });
            }
        }

        function carregarBancos() {
            // Carregar bancos no select de relatórios
            const selectBancoRelatorio = document.getElementById('banco-relatorio');
            if (selectBancoRelatorio) {
                selectBancoRelatorio.innerHTML = '<option value="">Todos os bancos</option>';
                
                bancos.forEach(banco => {
                    const option = document.createElement('option');
                    option.value = banco.nome || banco;
                    option.textContent = banco.nome || banco;
                    option.setAttribute('data-logo', obterLogoBanco(banco.nome || banco));
                    selectBancoRelatorio.appendChild(option);
                });
                
                // Adicionar classe para estilização customizada
                selectBancoRelatorio.classList.add('select-com-logo');
            }
        }

        function carregarCategorias() {
            // Carregar categorias no select de filtro
            const selectFiltro = document.getElementById('categoria');
            selectFiltro.innerHTML = '<option value="">Todas as categorias</option>';
            
            // Carregar categorias no select do modal
            const selectModal = document.getElementById('categoriaModal');
            selectModal.innerHTML = '<option value="">Selecione uma categoria</option>';
            
            // Carregar categorias no select de orçamento
            const selectOrcamento = document.getElementById('categoria-orcamento');
            selectOrcamento.innerHTML = '<option value="">Selecione uma categoria</option>';
            
            // Carregar categorias no select de transferência
            const selectTransferencia = document.getElementById('categoria-transferencia');
            if (selectTransferencia) {
                selectTransferencia.innerHTML = '<option value="">Selecione uma categoria</option>';
            }
            
            categorias.forEach(categoria => {
                const optionFiltro = document.createElement('option');
                optionFiltro.value = categoria;
                optionFiltro.textContent = categoria;
                selectFiltro.appendChild(optionFiltro);
                
                const optionModal = document.createElement('option');
                optionModal.value = categoria;
                optionModal.textContent = categoria;
                selectModal.appendChild(optionModal);
                
                const optionOrcamento = document.createElement('option');
                optionOrcamento.value = categoria;
                optionOrcamento.textContent = categoria;
                selectOrcamento.appendChild(optionOrcamento);
                
                // Adicionar categoria ao select de transferência
                if (selectTransferencia) {
                    const optionTransferencia = document.createElement('option');
                    optionTransferencia.value = categoria;
                    optionTransferencia.textContent = categoria;
                    selectTransferencia.appendChild(optionTransferencia);
                }
            });
            
            // Atualizar lista de categorias na página de configurações
            const listaCategorias = document.getElementById('lista-categorias');
            listaCategorias.innerHTML = '';
            
            categorias.forEach(categoria => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    ${categoria}
                    <button class="btn btn-sm btn-outline-danger remover-categoria">Remover</button>
                `;
                listaCategorias.appendChild(li);
            });
            
            // Atualizar tabela de orçamentos
            atualizarTabelaOrcamentos();
        }

        function inicializarGraficos() {
            // Gráfico comparativo
            const comparativoCtx = document.getElementById('comparativoChart').getContext('2d');
            comparativoChart = new Chart(comparativoCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== undefined) {
                                        label += new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de evolução
            const evolucaoCtx = document.getElementById('evolucaoChart').getContext('2d');
            evolucaoChart = new Chart(evolucaoCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Saldo',
                        data: [],
                        borderColor: '#4361ee',
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('pt-BR', {
                                        style: 'currency',
                                        currency: 'BRL'
                                    }).format(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function aplicarFiltros() {
            const periodo = document.getElementById('periodo').value;
            const mes = periodo === 'mensal' ? parseInt(document.getElementById('mes').value) : null;
            const ano = periodo === 'mensal' ? document.getElementById('ano').value : document.getElementById('anoAnual').value;
            const categoria = document.getElementById('categoria').value;
            const tipo = document.getElementById('tipo').value;
            
            // Filtrar lançamentos
            let lancamentosFiltrados = lancamentos.filter(l => {
                const dataLancamento = new Date(l.data);
                const anoLancamento = dataLancamento.getFullYear().toString();
                const mesLancamento = dataLancamento.getMonth();
                
                let passaFiltro = true;
                
                // Filtro por período
                if (periodo === 'mensal') {
                    passaFiltro = passaFiltro && (anoLancamento === ano && mesLancamento === mes);
                } else {
                    passaFiltro = passaFiltro && (anoLancamento === ano);
                }
                
                // Filtro por categoria
                if (categoria) {
                    passaFiltro = passaFiltro && (l.categoria === categoria);
                }
                
                // Filtro por tipo
                if (tipo) {
                    passaFiltro = passaFiltro && (l.tipo === tipo);
                }
                
                return passaFiltro;
            });
            
            // Se não há lançamentos filtrados, mostrar todos
            if (lancamentosFiltrados.length === 0 && lancamentos.length > 0) {
                console.log('⚠️ Filtros não retornaram resultados, mostrando todos os lançamentos');
                carregarLancamentos();
            } else {
                // Carregar lançamentos filtrados na tabela
                carregarLancamentos(lancamentosFiltrados);
            }
            
            // Atualizar gráficos
            atualizarGraficos(lancamentosFiltrados, periodo, mes, ano);
            
            // Atualizar título da tabela
            atualizarTituloTabela(periodo, mes, ano);
            
            // Desativar modo de comparação se estiver ativo
            document.getElementById('comparar-periodos').checked = false;
            
            // Verificar alertas de orçamento
            verificarAlertasOrcamento();
        }

        function carregarLancamentos(lancamentosParaExibir = null) {
            const tbody = document.getElementById('tabela-lancamentos');
            tbody.innerHTML = '';
            
            // Se não foram fornecidos lançamentos, usar todos
            const lancamentosExibicao = lancamentosParaExibir || lancamentos;
            
            // Verificar se há lançamentos para exibir
            if (lancamentosExibicao.length === 0) {
                tbody.innerHTML = `
                    <tr id="empty-state-row">
                        <td colspan="10">
                            <div class="empty-state">
                                <i class="bi bi-wallet2"></i>
                                <h4>Nenhum lançamento ${lancamentosParaExibir ? 'encontrado' : 'cadastrado'}</h4>
                                <p>${lancamentos.length === 0 ? 'Comece adicionando seu primeiro lançamento financeiro' : 'Tente ajustar os filtros para ver mais resultados'}</p>
                                ${lancamentos.length === 0 ? 
                                    '<button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#lancamentoModal">' +
                                    '<i class="bi bi-plus-circle me-1"></i> Adicionar Lançamento</button>' : ''}
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Calcular saldo inicial considerando lançamentos anteriores ao período filtrado
            let saldoAcumulado = saldoInicial;
            
            // Se há filtro aplicado, calcular saldo acumulado até o início do período
            if (lancamentosParaExibir && lancamentosParaExibir !== lancamentos) {
                // Obter a data mais antiga dos lançamentos filtrados
                const datasLancamentosFiltrados = lancamentosParaExibir.map(l => new Date(l.data));
                const dataInicioFiltro = new Date(Math.min(...datasLancamentosFiltrados));
                
                // Calcular saldo acumulado de todos os lançamentos anteriores ao filtro
                const lancamentosAnteriores = lancamentos.filter(l => {
                    const dataLancamento = new Date(l.data);
                    return dataLancamento < dataInicioFiltro;
                });
                
                // Ordenar lançamentos anteriores por data
                const lancamentosAnterioresOrdenados = [...lancamentosAnteriores].sort((a, b) => 
                    new Date(a.data) - new Date(b.data)
                );
                
                // Calcular saldo acumulado dos lançamentos anteriores
                lancamentosAnterioresOrdenados.forEach(lancamento => {
                    const status = lancamento.status || 'realizado';
                    const isTransferencia = lancamento.tipoTransacao === 'transferencia_interna';
                    
                    if ((status === 'realizado' || status === 'efetivada') && !isTransferencia) {
                        if (lancamento.tipo === 'entrada') {
                            saldoAcumulado += lancamento.valor;
                        } else {
                            saldoAcumulado -= lancamento.valor;
                        }
                    }
                });
            }
            
            // Ordenar lançamentos por data
            const lancamentosOrdenados = [...lancamentosExibicao].sort((a, b) => 
                new Date(a.data) - new Date(b.data)
            );
            
            lancamentosOrdenados.forEach(lancamento => {
                // Corrigir problema de fuso horário - garantir que a data seja interpretada como local
                const partesData = lancamento.data.split('-');
                const dataLocal = new Date(partesData[0], partesData[1] - 1, partesData[2]);
                const dataFormatada = dataLocal.toLocaleDateString('pt-BR');
                
                // Apenas lançamentos realizados afetam o saldo acumulado
                // EXCLUIR transferências entre contas do saldo do fluxo de caixa
                const status = lancamento.status || 'realizado';
                const isTransferencia = lancamento.tipoTransacao === 'transferencia_interna';
                
                if ((status === 'realizado' || status === 'efetivada') && !isTransferencia) {
                    if (lancamento.tipo === 'entrada') {
                        saldoAcumulado += lancamento.valor;
                    } else {
                        saldoAcumulado -= lancamento.valor;
                    }
                }
                
                const saldoClass = saldoAcumulado >= 0 ? 'saldo-positivo' : 'saldo-negativo';
                const saldoFormatado = saldoAcumulado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                // Usar a variável status já declarada acima
                const statusBadge = status === 'previsto' 
                    ? '<span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Previsto</span>'
                    : '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Realizado</span>';
                
                const linha = document.createElement('tr');
                linha.dataset.id = lancamento.id;
                
                // Adicionar classe CSS baseada no status e tipo
                if (status === 'previsto') {
                    linha.classList.add('lancamento-previsto');
                } else {
                    linha.classList.add('lancamento-realizado');
                }
                
                // Adicionar classe especial para transferências
                if (isTransferencia) {
                    linha.classList.add('lancamento-transferencia');
                }
                // Formatar informações de banco e conta com logo
                let bancoInfo;
                if (isTransferencia && lancamento.tipo === 'transferencia') {
                    // Para transferências, mostrar origem e destino
                    const bancoOrigemInfo = formatarBancoContaTabela(lancamento.bancoOrigem, lancamento.contaOrigem);
                    const bancoDestinoInfo = formatarBancoContaTabela(lancamento.bancoDestino, lancamento.contaDestino);
                    bancoInfo = `${bancoOrigemInfo}<br><small class="text-muted">↓</small><br>${bancoDestinoInfo}`;
                } else {
                    bancoInfo = formatarBancoContaTabela(lancamento.banco, lancamento.conta);
                }
                
                // Formatar tipo de transação
                let tipoTransacaoInfo = '-';
                if (lancamento.tipoTransacao) {
                    switch(lancamento.tipoTransacao) {
                        case 'pix':
                            tipoTransacaoInfo = 'PIX';
                            break;
                        case 'transferencia':
                            tipoTransacaoInfo = 'Transferência';
                            break;
                        case 'debito':
                            tipoTransacaoInfo = 'Débito';
                            break;
                        case 'credito':
                            tipoTransacaoInfo = lancamento.cartao ? `Crédito (${lancamento.cartao})` : 'Crédito';
                            break;
                        case 'saldo_conta':
                            tipoTransacaoInfo = 'Saldo da Conta';
                            break;
                        case 'transferencia_contas':
                            if (lancamento.tipo === 'transferencia') {
                                // Nova lógica: transferência única
                                const bancoOrigemObj = bancos.find(b => b.id == lancamento.bancoOrigem);
                                const bancoDestinoObj = bancos.find(b => b.id == lancamento.bancoDestino);
                                const origemNome = bancoOrigemObj ? bancoOrigemObj.nome : 'Banco';
                                const destinoNome = bancoDestinoObj ? bancoDestinoObj.nome : 'Banco';
                                tipoTransacaoInfo = `${origemNome} → ${destinoNome}`;
                            } else {
                                // Lógica antiga: manter compatibilidade
                                tipoTransacaoInfo = lancamento.contaDestino ? `Transf. → ${lancamento.contaDestino}` : 'Transf. entre Contas';
                            }
                            break;
                        default:
                            tipoTransacaoInfo = lancamento.tipoTransacao.charAt(0).toUpperCase() + lancamento.tipoTransacao.slice(1);
                    }
                }
                
                linha.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${lancamento.descricao}</td>
                    <td><span class="badge bg-secondary badge-categoria">${lancamento.categoria}</span></td>
                    <td>${bancoInfo}</td>
                    <td><small class="text-muted">${tipoTransacaoInfo}</small></td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-end ${lancamento.tipo === 'entrada' ? 'entrada' : (isTransferencia && lancamento.tipo === 'transferencia' ? 'transferencia-valor' : '')}">
                        ${lancamento.tipo === 'entrada' ? lancamento.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 
                          (isTransferencia && lancamento.tipo === 'transferencia' ? `<span class="text-muted">${lancamento.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>` : '-')}
                    </td>
                    <td class="text-end ${lancamento.tipo === 'saida' ? 'saida' : (isTransferencia && lancamento.tipo === 'transferencia' ? 'transferencia-valor' : '')}">
                        ${lancamento.tipo === 'saida' ? lancamento.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 
                          (isTransferencia && lancamento.tipo === 'transferencia' ? `<span class="text-muted">${lancamento.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>` : '-')}
                    </td>
                    <td class="text-end ${saldoClass}">
                        ${isTransferencia ? 
                            `<span class="text-muted" title="Transferências não afetam o saldo do fluxo de caixa">${saldoFormatado} <i class="bi bi-arrow-left-right"></i></span>` : 
                            saldoFormatado
                        }
                    </td>
                    <td class="text-center">
                        ${status === 'previsto' ? `
                        <button class="btn btn-sm btn-outline-success btn-marcar-realizado me-1" title="Marcar como realizado">
                            <i class="bi bi-check-circle"></i>
                        </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-primary btn-editar me-1" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-excluir me-1" title="Excluir com confirmação">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-dark btn-excluir-direto" title="Excluir diretamente">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(linha);
            });
            
            // Calcular totais - SEMPRE usar todos os lançamentos para totais gerais
            calcularTotais();
            
            // Atualizar dashboard - SEMPRE usar todos os lançamentos para cálculo de saldos
            atualizarDashboard(); // Sem parâmetro = usa todos os lançamentos
            
            // Atualizar saldos por conta - SEMPRE usar todos os lançamentos
            atualizarSaldosPorConta(); // Sem parâmetro = usa todos os lançamentos
        }

        function atualizarDashboard(lancamentosParaCalcular = null) {
            const lancamentosCalculo = lancamentosParaCalcular || lancamentos;
            const totais = calcularTotais(lancamentosCalculo);
            
            // Atualizar elementos do dashboard
            const saldoAtualElement = document.getElementById('saldo-atual');
            const saldoPrevisto = document.getElementById('saldo-previsto');
            const totalEntradas = document.getElementById('total-entradas');
            const totalSaidas = document.getElementById('total-saidas');
            
            if (saldoAtualElement) {
                saldoAtualElement.textContent = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(totais.saldoAtual);
                
                // Aplicar cor baseada no valor
                saldoAtualElement.className = totais.saldoAtual >= 0 ? 'mb-0 saldo-positivo' : 'mb-0 saldo-negativo';
            }
            
            if (saldoPrevisto) {
                saldoPrevisto.textContent = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(totais.saldoPrevisto);
                
                // Aplicar cor baseada no valor
                saldoPrevisto.className = totais.saldoPrevisto >= 0 ? 'mb-0 saldo-positivo' : 'mb-0 saldo-negativo';
            }
            
            if (totalEntradas) {
                totalEntradas.textContent = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(totais.totalEntradas);
            }
            
            if (totalSaidas) {
                totalSaidas.textContent = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(totais.totalSaidas);
            }
            
            // Atualizar dashboard de cartões
            atualizarDashboardCartoes();
            
            // Atualizar dashboard de investimentos
            atualizarDashboardInvestimentos();
            
            // Atualizar saldos por conta
            atualizarSaldosPorConta(lancamentosCalculo);
        }

        function atualizarSaldosPorConta(lancamentosParaCalcular = null) {
            const saldosPorConta = calcularSaldosPorConta(lancamentosParaCalcular);
            
            const container = document.getElementById('saldos-contas-container');
            const saldosSection = document.getElementById('saldos-por-conta');
            
            if (!container || !saldosSection) return;
            
            // Limpar container
            container.innerHTML = '';
            
            // Se não há contas, ocultar a seção
            if (saldosPorConta.length === 0) {
                saldosSection.style.display = 'none';
                return;
            }
            
            // Mostrar a seção
            saldosSection.style.display = 'block';
            
            // Calcular colunas responsivas
            let colClass = 'col-12';
            if (saldosPorConta.length === 2) {
                colClass = 'col-md-6';
            } else if (saldosPorConta.length === 3) {
                colClass = 'col-lg-4 col-md-6';
            } else if (saldosPorConta.length >= 4) {
                colClass = 'col-xl-3 col-lg-4 col-md-6';
            }
            
            // Criar cards para cada conta
            saldosPorConta.forEach(conta => {
                const saldoFormatado = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(conta.saldo);
                
                // Determinar classe de cor do saldo
                let saldoClass = 'saldo-zero';
                if (conta.saldo > 0) {
                    saldoClass = 'saldo-positivo';
                } else if (conta.saldo < 0) {
                    saldoClass = 'saldo-negativo';
                }
                
                // Obter ícone do banco
                const iconeBanco = obterIconeBanco(conta.bancoNome);
                
                // Usar a variável colClass que foi definida anteriormente
                const cardHtml = `
                    <div class="${colClass}">
                        <div class="saldo-conta-card">
                            <div class="saldo-conta-header">
                                ${iconeBanco}
                                <span class="saldo-conta-banco">${conta.bancoNome || 'Banco'}</span>
                            </div>
                            <div class="saldo-conta-nome">${conta.contaNome}</div>
                            <div class="saldo-conta-valor ${saldoClass}">${saldoFormatado}</div>
                        </div>
                    </div>
                `;
                
                container.innerHTML += cardHtml;
            });
        }

        function calcularTotais(lancamentosParaCalcular = null) {
            const lancamentosCalculo = lancamentosParaCalcular || lancamentos;
            
            // Excluir transferências entre contas do cálculo de totais (fluxo de caixa)
            const lancamentosSemTransferencias = lancamentosCalculo.filter(l => l.tipoTransacao !== 'transferencia_interna');
            
            console.log('💰 CALCULANDO TOTAIS (FLUXO DE CAIXA)');
            console.log(`Total de lançamentos: ${lancamentosCalculo.length}`);
            console.log(`Lançamentos sem transferências: ${lancamentosSemTransferencias.length}`);
            console.log(`Transferências excluídas: ${lancamentosCalculo.length - lancamentosSemTransferencias.length}`);
            
            // Separar lançamentos realizados e previstos (sem transferências)
            const lancamentosRealizados = lancamentosSemTransferencias.filter(l => (l.status || 'realizado') === 'realizado');
            const lancamentosPrevistos = lancamentosSemTransferencias.filter(l => l.status === 'previsto');
            
            // Calcular totais realizados
            const totalEntradasRealizadas = lancamentosRealizados
                .filter(l => l.tipo === 'entrada')
                .reduce((total, l) => total + l.valor, 0);
                
            const totalSaidasRealizadas = lancamentosRealizados
                .filter(l => l.tipo === 'saida')
                .reduce((total, l) => total + l.valor, 0);
            
            // Calcular totais previstos
            const totalEntradasPrevistas = lancamentosPrevistos
                .filter(l => l.tipo === 'entrada')
                .reduce((total, l) => total + l.valor, 0);
                
            const totalSaidasPrevistas = lancamentosPrevistos
                .filter(l => l.tipo === 'saida')
                .reduce((total, l) => total + l.valor, 0);
            
            // Calcular saldos
            const saldoAtual = saldoInicial + totalEntradasRealizadas - totalSaidasRealizadas;
            const saldoPrevisto = saldoAtual + totalEntradasPrevistas - totalSaidasPrevistas;
            
            // Totais gerais (para compatibilidade)
            const totalEntradas = totalEntradasRealizadas + totalEntradasPrevistas;
            const totalSaidas = totalSaidasRealizadas + totalSaidasPrevistas;
            const saldoFinal = saldoInicial + totalEntradas - totalSaidas;
            
            // Retornar objeto com todos os cálculos
            return {
                saldoAtual,
                saldoPrevisto,
                totalEntradasRealizadas,
                totalSaidasRealizadas,
                totalEntradasPrevistas,
                totalSaidasPrevistas,
                totalEntradas,
                totalSaidas,
                saldoFinal
            };
        }



        function calcularSaldosPorConta(lancamentosParaCalcular = null) {
            const lancamentosCalculo = lancamentosParaCalcular || lancamentos;
            const saldosPorConta = {};
            

            
            // Filtrar lançamentos realizados + transferências (que sempre devem ser incluídas)
            const lancamentosRealizados = lancamentosCalculo.filter(l => 
                (l.status || 'realizado') === 'realizado' || l.tipoTransacao === 'transferencia_interna'
            );
            console.log('Lançamentos realizados:', lancamentosRealizados.length);
            
            // Calcular saldo para cada conta
            lancamentosRealizados.forEach(lancamento => {
                if (!lancamento.conta || !lancamento.banco) {
                    console.log(`⚠️ Lançamento sem conta/banco - ID: ${lancamento.id}`);
                    return;
                }
                
                const bancoId = lancamento.banco;
                const contaId = lancamento.conta;
                const chaveUnica = `${bancoId}_${contaId}`;
                
                // Buscar dados do banco e conta
                const banco = bancos.find(b => String(b.id) === String(bancoId));
                if (!banco) {
                    console.log(`⚠️ Banco não encontrado - ID: ${bancoId}`);
                    return;
                }
                
                const conta = banco.contas ? banco.contas.find(c => String(c.id) === String(contaId)) : null;
                if (!conta) {
                    console.log(`⚠️ Conta não encontrada - Banco: ${banco.nome}, Conta ID: ${contaId}`);
                    return;
                }
                
                // Garantir que a conta existe no objeto
                if (!saldosPorConta[chaveUnica]) {
                    saldosPorConta[chaveUnica] = {
                        bancoId: bancoId,
                        contaId: contaId,
                        bancoNome: banco.nome,
                        contaNome: conta.numero || conta.nome || 'Conta',
                        conta: `${banco.nome} - ${conta.numero || conta.nome || 'Conta'}`,
                        banco: banco.nome,
                        saldo: 0,
                        entradas: 0,
                        saidas: 0
                    };
                    console.log(`✅ Nova conta criada: ${saldosPorConta[chaveUnica].conta}`);
                }
                
                const isTransferencia = lancamento.tipoTransacao === 'transferencia_interna';
                
                const valorAnterior = saldosPorConta[chaveUnica].saldo;
                
                // Processar lançamento normalmente (transferências agora são lançamentos normais)
                if (lancamento.tipo === 'entrada') {
                    saldosPorConta[chaveUnica].entradas += lancamento.valor;
                    saldosPorConta[chaveUnica].saldo += lancamento.valor;
                } else if (lancamento.tipo === 'saida') {
                    saldosPorConta[chaveUnica].saidas += lancamento.valor;
                    saldosPorConta[chaveUnica].saldo -= lancamento.valor;
                }
            });
            

            
            // Converter para array e ordenar por banco/conta
            return Object.values(saldosPorConta).sort((a, b) => {
                if (a.bancoNome !== b.bancoNome) {
                    return a.bancoNome.localeCompare(b.bancoNome);
                }
                return a.contaNome.localeCompare(b.contaNome);
            });
        }



        function atualizarGraficos(lancamentosFiltrados, periodo, mes, ano) {
            // Usar os novos cálculos separados por status
            const totais = calcularTotais(lancamentosFiltrados);
            
            // Para o gráfico, usar totais realizados + previstos
            const totalEntradas = totais.totalEntradas;
            const totalSaidas = totais.totalSaidas;
            
            // Preparar dados para o gráfico - apenas entradas e saídas
            const labels = ['Entradas', 'Saídas'];
            const valores = [totalEntradas, totalSaidas];
            const cores = ['#28a745', '#dc3545']; // Verde para entradas, Vermelho para saídas
            
            // Atualizar o gráfico comparativo
            comparativoChart.data.labels = labels;
            comparativoChart.data.datasets = [
                {
                    data: valores,
                    backgroundColor: cores,
                    borderWidth: 1,
                    borderColor: '#ffffff',
                    hoverBorderWidth: 3,
                    hoverBorderColor: '#ffffff',
                    hoverOffset: 10
                }
            ];
            
            // Atualizar tipo de gráfico para doughnut para melhor visualização
            comparativoChart.config.type = 'doughnut';
            
            // Atualizar opções para mostrar legendas e tooltips melhorados
            comparativoChart.options.plugins.legend.position = 'right';
            comparativoChart.options.plugins.legend.labels = {
                font: {
                    weight: 'bold'
                },
                padding: 15
            };
            
            // Configurar tooltips simples
            comparativoChart.options.plugins.tooltip = {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        return `${label}: ${new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        }).format(value)}`;
                    }
                },
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 13
                },
                displayColors: true,
                borderColor: '#ffffff',
                borderWidth: 1
            };
            
            // Atualizar o gráfico
            comparativoChart.update();
            
            // Atualizar valores nos elementos HTML
            document.getElementById('valor-entrada').textContent = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(totalEntradas);
            
            document.getElementById('valor-saida').textContent = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(totalSaidas);
            
            // Atualizar gráfico de evolução
            if (periodo === 'mensal') {
                // Para visualização mensal, mostrar dias do mês
                const diasNoMes = new Date(parseInt(ano), parseInt(mes) + 1, 0).getDate();
                const labels = Array.from({length: diasNoMes}, (_, i) => (i + 1).toString());
                
                const dadosEvolucao = Array(diasNoMes).fill(null);
                let saldoDiario = saldoInicial;
                
                // Preencher com saldo inicial no primeiro dia
                if (diasNoMes > 0) dadosEvolucao[0] = saldoInicial;
                
                lancamentosFiltrados.forEach(lancamento => {
                    const dia = new Date(lancamento.data).getDate() - 1; // índice 0-based
                    if (lancamento.tipo === 'entrada') {
                        saldoDiario += lancamento.valor;
                    } else {
                        saldoDiario -= lancamento.valor;
                    }
                    dadosEvolucao[dia] = saldoDiario;
                });
                
                // Preencher valores nulos com o último saldo conhecido
                let ultimoSaldo = saldoInicial;
                for (let i = 0; i < dadosEvolucao.length; i++) {
                    if (dadosEvolucao[i] !== null) {
                        ultimoSaldo = dadosEvolucao[i];
                    } else {
                        dadosEvolucao[i] = ultimoSaldo;
                    }
                }
                
                evolucaoChart.data.labels = labels;
                evolucaoChart.data.datasets[0].data = dadosEvolucao;
                evolucaoChart.data.datasets[0].label = 'Saldo Diário';
            } else {
                // Para visualização anual, mostrar meses do ano
                const labels = meses.slice(0, 12);
                const dadosEvolucao = Array(12).fill(0);
                let saldoAcumulado = saldoInicial;
                
                // Primeiro mês começa com o saldo inicial
                dadosEvolucao[0] = saldoInicial;
                
                for (let i = 0; i < 12; i++) {
                    const lancamentosMes = lancamentos.filter(l => {
                        const dataLancamento = new Date(l.data);
                        return dataLancamento.getFullYear().toString() === ano && 
                               dataLancamento.getMonth() === i;
                    });
                    
                    // Calcular movimento do mês
                    const movimentoMes = lancamentosMes.reduce((total, l) => {
                        return l.tipo === 'entrada' ? total + l.valor : total - l.valor;
                    }, 0);
                    
                    // Atualizar saldo acumulado
                    if (i === 0) {
                        saldoAcumulado = saldoInicial + movimentoMes;
                    } else {
                        saldoAcumulado += movimentoMes;
                    }
                    
                    dadosEvolucao[i] = saldoAcumulado;
                }
                
                evolucaoChart.data.labels = labels;
                evolucaoChart.data.datasets[0].data = dadosEvolucao;
                evolucaoChart.data.datasets[0].label = 'Saldo Mensal';
            }
            
            evolucaoChart.update();
            
            // Atualizar informações de saldo inicial e final
            // Calcular saldo final baseado no saldo inicial + todos os lançamentos do período
            const entradasPeriodo = lancamentosFiltrados
                .filter(l => l.tipo === 'entrada')
                .reduce((total, l) => total + l.valor, 0);
                
            const saidasPeriodo = lancamentosFiltrados
                .filter(l => l.tipo === 'saida')
                .reduce((total, l) => total + l.valor, 0);
                
            const saldoFinal = saldoInicial + entradasPeriodo - saidasPeriodo;
            
            document.getElementById('saldo-inicial-evolucao').textContent = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(saldoInicial);
            
            document.getElementById('saldo-final-evolucao').textContent = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(saldoFinal);
        }

        function configurarNavegacao() {
            const links = document.querySelectorAll('.nav-link[data-page]');
            
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remover classe active de todos os links
                    links.forEach(l => l.classList.remove('active'));
                    
                    // Adicionar classe active ao link clicado
                    this.classList.add('active');
                    
                    // Mostrar a página correspondente
                    const pageId = this.getAttribute('data-page');
                    mostrarPagina(pageId);
                });
            });
            
            // Garantir que a página inicial (dashboard) esteja ativa
            inicializarPaginaInicial();
        }
        
        function mostrarPagina(pageId) {
            const pages = document.querySelectorAll('.page');
            
            // Esconder todas as páginas
            pages.forEach(page => page.classList.remove('active'));
            
            // Mostrar a página solicitada
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Se for a página de relatórios, inicializar os relatórios
                if (pageId === 'relatorios') {
                    inicializarRelatorios();
                }
                
                // Se for a página de investimentos, carregar investimentos
                if (pageId === 'investimentos') {
                    carregarInvestimentos();
                }
                
                // Se for a página de configurações, carregar configurações
                if (pageId === 'configuracoes') {
                    carregarConfiguracoes();
                }
                
                // Se for a página de administração, carregar usuários
                if (pageId === 'admin') {
                    carregarUsuarios();
                }
            } else {
                console.error(`Página com ID ${pageId} não encontrada`);
                // Fallback para dashboard se a página não existir
                document.getElementById('dashboard').classList.add('active');
            }
        }
        
        function inicializarPaginaInicial() {
            // Garantir que apenas o dashboard esteja ativo inicialmente
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            const dashboard = document.getElementById('dashboard');
            if (dashboard) {
                dashboard.classList.add('active');
            }
            
            // Ativar o link do dashboard na navegação
            const dashboardLink = document.querySelector('.nav-link[data-page="dashboard"]');
            if (dashboardLink) {
                const allLinks = document.querySelectorAll('.nav-link[data-page]');
                allLinks.forEach(link => link.classList.remove('active'));
                dashboardLink.classList.add('active');
            }
        }
        
        function carregarConfiguracoes() {
             // Carregar saldo inicial atual
             const saldoInicialInput = document.getElementById('saldo-inicial-input');
             if (saldoInicialInput) {
                 saldoInicialInput.value = saldoInicial.toFixed(2);
             }
             
             // Atualizar lista de categorias
             atualizarListaCategorias();
             
             // Atualizar tabela de orçamentos
             atualizarTabelaOrcamentos();
             
             // Atualizar tabelas de bancos e cartões
             carregarTabelaBancos();
         }
         
         function atualizarListaCategorias() {
             const listaCategorias = document.getElementById('lista-categorias');
             if (!listaCategorias) return;
             
             listaCategorias.innerHTML = '';
             
             categorias.forEach(categoria => {
                 const li = document.createElement('li');
                 li.className = 'list-group-item d-flex justify-content-between align-items-center';
                 li.innerHTML = `
                     <span>${categoria}</span>
                     <button class="btn btn-sm btn-outline-danger remover-categoria" type="button">
                         <i class="bi bi-trash"></i>
                     </button>
                 `;
                 listaCategorias.appendChild(li);
             });
         }
         
         function adicionarCategoria() {
             const input = document.getElementById('nova-categoria');
             const novaCategoria = input.value.trim();
             
             if (!novaCategoria) {
                 alert('Por favor, digite o nome da categoria.');
                 return;
             }
             
             if (categorias.includes(novaCategoria)) {
                 alert('Esta categoria já existe.');
                 return;
             }
             
             categorias.push(novaCategoria);
             input.value = '';
             
             // Atualizar lista visual
             atualizarListaCategorias();
             
             // Atualizar selects de categoria
             carregarCategorias();
             
             // Salvar dados
             salvarDados();
             
             alert('Categoria adicionada com sucesso!');
         }
         
         function removerCategoria(elemento) {
             const categoria = elemento.querySelector('span').textContent;
             
             if (confirm(`Tem certeza que deseja remover a categoria "${categoria}"?`)) {
                 const index = categorias.indexOf(categoria);
                 if (index > -1) {
                     categorias.splice(index, 1);
                     
                     // Atualizar lista visual
                     atualizarListaCategorias();
                     
                     // Atualizar selects de categoria
                     carregarCategorias();
                     
                     // Salvar dados
                     salvarDados();
                     
                     alert('Categoria removida com sucesso!');
                 }
             }
         }
        
        function configurarTema() {
            // Configurar navbar com base no tema atual
            atualizarEstilosTema();
            
            // Verificar preferência do sistema
            if (!localStorage.getItem('financasTema')) {
                const prefereTemEscuro = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefereTemEscuro) {
                    document.body.setAttribute('data-theme', 'dark');
                    document.getElementById('theme-toggle').checked = true;
                    atualizarIconeTema(true);
                    salvarDados();
                }
            }
        }
        
        // Funções de API para integração com banco Neon
        // Detectar automaticamente a URL da API baseada no ambiente
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001' 
            : window.location.origin;
        
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}/api${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                console.warn('🌐 API temporariamente indisponível. Usando modo offline:', error.message);
                return { success: false, error: 'API temporariamente indisponível' };
            }
        }
        
        async function registrarUsuarioAPI(nome, email, senha) {
            const result = await apiRequest('/register', {
                method: 'POST',
                body: JSON.stringify({ name: nome, email, password: senha })
            });
            
            if (result.success) {
                return { success: true, user: result.data.user };
            } else {
                return { success: false, error: result.data?.error || 'Erro no registro' };
            }
        }
        
        async function loginUsuarioAPI(email, senha) {
            console.log('🔍 Tentando login via API para:', email);
            const result = await apiRequest('/login', {
                method: 'POST',
                body: JSON.stringify({ email, password: senha })
            });
            
            console.log('📊 Resultado da API:', result);
            
            if (result.success) {
                console.log('✅ Login via API bem-sucedido:', result.data.user);
                return { success: true, user: result.data.user };
            } else {
                console.log('❌ Erro no login:', result.data?.error || 'Erro desconhecido');
                return { success: false, error: result.data?.error || 'Erro no login' };
            }
        }
        
        function registrarUsuarioLocalStorage(nome, email, senha) {
            // Verificar se email já existe
            if (usuarios.some(u => u.email === email)) {
                return { success: false, error: 'Este email já está cadastrado.' };
            }
            
            // Criar novo usuário
            const novoUsuario = { nome, email, senha, subscription_type: 'free' };
            usuarios.push(novoUsuario);
            localStorage.setItem('financasUsuarios', JSON.stringify(usuarios));
            
            return { success: true, user: { name: nome, email, subscription_type: 'free' } };
        }
        
        function loginUsuarioLocalStorage(email, senha) {
            const usuario = usuarios.find(u => u.email === email && u.senha === senha);
            if (usuario) {
                return { 
                    success: true, 
                    user: { 
                        name: usuario.nome, 
                        email: usuario.email, 
                        subscription_type: usuario.subscription_type || 'free' 
                    } 
                };
            } else {
                return { success: false, error: 'Email ou senha incorretos.' };
            }
        }
        
        // Funções de autenticação
        function verificarAutenticacao() {
            // Carregar usuários cadastrados
            const usuariosSalvos = localStorage.getItem('financasUsuarios');
            if (usuariosSalvos) {
                usuarios = JSON.parse(usuariosSalvos);
            }
            
            // Adicionar usuário de teste do banco se não existir
            const usuarioTesteBanco = usuarios.find(u => u.email === 'banco@teste.com');
            if (!usuarioTesteBanco) {
                usuarios.push({
                    id: 1, // ID numérico indica usuário do banco
                    nome: 'Usuário do Banco',
                    email: 'banco@teste.com',
                    senha: '123456',
                    subscription_type: 'premium',
                    origem: 'banco_neon'
                });
                localStorage.setItem('financasUsuarios', JSON.stringify(usuarios));
            }
            
            // Verificar se há usuário logado
            const usuarioLogado = localStorage.getItem('financasUsuarioLogado') || sessionStorage.getItem('financasUsuarioLogado');
            if (usuarioLogado) {
                try {
                    usuarioAtual = JSON.parse(usuarioLogado);
                    // Definir se a sessão é temporária baseada no tipo de storage
                    sessaoTemporaria = !localStorage.getItem('financasUsuarioLogado');
                    atualizarInterfaceUsuarioLogado();
                    carregarDadosSalvos();
                    carregarFotoPerfil();
                    // Atualizar filtros após carregar os dados
                    atualizarFiltros();
                    return;
                } catch (e) {
                    console.error('Erro ao carregar usuário:', e);
                    localStorage.removeItem('financasUsuarioLogado');
                    sessionStorage.removeItem('financasUsuarioLogado');
                }
            }
            
            // Se não há usuário logado, mostrar modal de login
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }
        
        async function fazerLogin(e) {
            if (e) e.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const senha = document.getElementById('login-senha').value;
            const lembrar = document.getElementById('lembrar-login').checked;
            
            // Tentar login via API primeiro, depois localStorage
            const resultado = await loginUsuarioAPI(email, senha);
            
            if (resultado.success) {
                // Login bem-sucedido
                usuarioAtual = { 
                    id: resultado.user.id, // ✅ PRESERVAR ID DO BANCO
                    nome: resultado.user.name, 
                    email: resultado.user.email,
                    subscription_type: resultado.user.subscription_type || 'free',
                    subscription_active: resultado.user.subscription_active !== false
                };
                
                if (lembrar) {
                    localStorage.setItem('financasUsuarioLogado', JSON.stringify(usuarioAtual));
                    sessaoTemporaria = false; // Sessão permanente
                } else {
                    sessionStorage.setItem('financasUsuarioLogado', JSON.stringify(usuarioAtual));
                    sessaoTemporaria = true; // Sessão temporária
                }
                
                // Fechar modal e atualizar interface
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                atualizarInterfaceUsuarioLogado();
                carregarDadosSalvos();
                carregarFotoPerfil();
                // Atualizar filtros após carregar os dados
                atualizarFiltros();
                aplicarFiltros();
            } else {
                // Login falhou
                document.getElementById('login-error').textContent = resultado.error || 'Email ou senha incorretos.';
                document.getElementById('login-error').classList.remove('d-none');
                setTimeout(() => {
                    document.getElementById('login-error').classList.add('d-none');
                }, 3000);
            }
        }
        
        function abrirModalRegistro() {
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            const registroModal = new bootstrap.Modal(document.getElementById('registroModal'));
            registroModal.show();
        }
        
        function cancelarRegistro() {
            // Fechar modal de registro
            const registroModal = bootstrap.Modal.getInstance(document.getElementById('registroModal'));
            if (registroModal) {
                registroModal.hide();
            }
            
            // Limpar campos do formulário de registro
            document.getElementById('registro-nome').value = '';
            document.getElementById('registro-email').value = '';
            document.getElementById('registro-senha').value = '';
            document.getElementById('registro-confirmar-senha').value = '';
            
            // Ocultar mensagens de erro
            document.getElementById('registro-error').classList.add('d-none');
            
            // Voltar para o modal de login
            setTimeout(() => {
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            }, 300); // Pequeno delay para suavizar a transição
        }
        
        async function criarConta() {
            const nome = document.getElementById('registro-nome').value.trim();
            const email = document.getElementById('registro-email').value.trim();
            const senha = document.getElementById('registro-senha').value;
            const confirmarSenha = document.getElementById('registro-confirmar-senha').value;
            
            // Validações básicas
            if (!nome || !email || !senha || senha !== confirmarSenha) {
                document.getElementById('registro-error').textContent = 'Por favor, preencha todos os campos corretamente.';
                document.getElementById('registro-error').classList.remove('d-none');
                return;
            }
            
            // Validação de formato de e-mail
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('registro-error').textContent = 'Por favor, insira um e-mail válido.';
                document.getElementById('registro-error').classList.remove('d-none');
                return;
            }
            
            // Tentar registrar via API primeiro, depois localStorage
            const resultado = await registrarUsuarioAPI(nome, email, senha);
            
            if (!resultado.success) {
                document.getElementById('registro-error').textContent = resultado.error || 'Erro ao criar conta.';
                document.getElementById('registro-error').classList.remove('d-none');
                return;
            }
            
            // Fazer login com o novo usuário
            usuarioAtual = { 
                id: resultado.user.id, // ✅ PRESERVAR ID DO BANCO
                nome: resultado.user.name, 
                email: resultado.user.email,
                subscription_type: resultado.user.subscription_type || 'free',
                subscription_active: true
            };
            localStorage.setItem('financasUsuarioLogado', JSON.stringify(usuarioAtual));
            
            // Fechar modal e atualizar interface
            bootstrap.Modal.getInstance(document.getElementById('registroModal')).hide();
            atualizarInterfaceUsuarioLogado();
            
            // Inicializar dados do usuário apenas se não existirem dados salvos
            const userPrefix = `financas_${usuarioAtual.email}_`;
            const dadosExistentes = localStorage.getItem(`${userPrefix}Categorias`);
            
            if (!dadosExistentes) {
                // Novo usuário - inicializar com dados padrão
                lancamentos = [];
                saldoInicial = 0.00;
                nextId = 1;
                categorias = ['Alimentação', 'Transporte', 'Lazer', 'Salário', 'Moradia', 'Saúde'];
                bancos = [];
                investimentos = [];
                cartoes = [];
                orcamentos = [];
                dividendos = [];
                ativos = [];
                corretoras = [];
                
                // Inicializar bancos de exemplo para novo usuário
                inicializarBancosExemplo();
                
                salvarDados();
            } else {
                // Usuário existente - carregar dados salvos
                carregarDadosSalvos();
            }
            
            aplicarFiltros();
            
            // Mostrar mensagem de boas-vindas
            mostrarAlerta(`Bem-vindo, ${nome}! Sua conta foi criada com sucesso.`, 'success');
        }
        
        function fazerLogout() {
            // Limpar dados de sessão
            localStorage.removeItem('financasUsuarioLogado');
            sessionStorage.removeItem('financasUsuarioLogado');
            usuarioAtual = null;
            
            // Limpar dados em memória
            lancamentos = [];
            saldoInicial = 0.00;
            nextId = 1;
            
            // Redirecionar para login
            window.location.reload();
        }
        
        function atualizarInterfaceUsuarioLogado() {
            // Fechar modal de login se estiver aberto
            const loginModalElement = document.getElementById('loginModal');
            const loginModalInstance = bootstrap.Modal.getInstance(loginModalElement);
            if (loginModalInstance) {
                loginModalInstance.hide();
            }
            
            // Atualizar nome do usuário na navbar
            const navbarBrand = document.querySelector('.navbar-brand');
            navbarBrand.innerHTML = `<i class="bi bi-cash-coin me-2"></i>Finanças de ${usuarioAtual.nome.split(' ')[0]}`;
            
            // Verificar se é admin e mostrar menu de administração
            if (usuarioAtual.email === 'admin@financeplus.com') {
                mostrarMenuAdmin();
            }
            
            // Mostrar conteúdo principal da aplicação
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }
        
        function verificarForcaSenha() {
            const senha = document.getElementById('registro-senha').value;
            const progressBar = document.getElementById('senha-forca');
            const feedback = document.getElementById('senha-feedback');
            
            // Critérios de força
            const comprimento = senha.length >= 8;
            const temNumeros = /\d/.test(senha);
            const temMinusculas = /[a-z]/.test(senha);
            const temMaiusculas = /[A-Z]/.test(senha);
            const temEspeciais = /[^A-Za-z0-9]/.test(senha);
            
            // Calcular pontuação (0-100)
            let pontuacao = 0;
            if (comprimento) pontuacao += 20;
            if (temNumeros) pontuacao += 20;
            if (temMinusculas) pontuacao += 20;
            if (temMaiusculas) pontuacao += 20;
            if (temEspeciais) pontuacao += 20;
            
            // Atualizar barra de progresso
            progressBar.style.width = `${pontuacao}%`;
            
            // Definir cor baseada na pontuação
            if (pontuacao < 40) {
                progressBar.className = 'progress-bar bg-danger';
                feedback.textContent = 'Senha fraca';
                feedback.className = 'form-text text-danger';
            } else if (pontuacao < 80) {
                progressBar.className = 'progress-bar bg-warning';
                feedback.textContent = 'Senha média';
                feedback.className = 'form-text text-warning';
            } else {
                progressBar.className = 'progress-bar bg-success';
                feedback.textContent = 'Senha forte';
                feedback.className = 'form-text text-success';
            }
        }
        
        function verificarSenhasIguais() {
            const senha = document.getElementById('registro-senha').value;
            const confirmarSenha = document.getElementById('registro-confirmar-senha').value;
            const feedback = document.getElementById('senha-match-feedback');
            
            if (!confirmarSenha) {
                feedback.textContent = '';
                return;
            }
            
            if (senha === confirmarSenha) {
                feedback.textContent = 'Senhas conferem';
                feedback.className = 'form-text text-success';
            } else {
                feedback.textContent = 'Senhas não conferem';
                feedback.className = 'form-text text-danger';
            }
        }
        
        function togglePasswordVisibility(e) {
            const button = e.currentTarget;
            const input = button.previousElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }
        
        function mostrarAlerta(mensagem, tipo = 'info') {
            const alertPlaceholder = document.createElement('div');
            alertPlaceholder.className = 'position-fixed top-0 end-0 p-3';
            alertPlaceholder.style.zIndex = '5000';
            document.body.appendChild(alertPlaceholder);
            
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertPlaceholder.appendChild(wrapper);
            
            setTimeout(() => {
                const alert = bootstrap.Alert.getOrCreateInstance(wrapper.querySelector('.alert'));
                alert.close();
                setTimeout(() => alertPlaceholder.remove(), 500);
            }, 5000);
        }
        
        function alternarTema() {
            const isDarkMode = document.getElementById('theme-toggle').checked;
            document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            atualizarIconeTema(isDarkMode);
            atualizarEstilosTema();
            salvarDados();
        }
        
        function atualizarIconeTema(isDarkMode) {
            const themeIcon = document.getElementById('theme-icon');
            if (isDarkMode) {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
            } else {
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
            }
        }
        
        function atualizarEstilosTema() {
            const isDarkMode = document.body.getAttribute('data-theme') === 'dark';
            const navbar = document.getElementById('main-navbar');
            const footer = document.getElementById('main-footer');
            
            // Atualizar navbar
            if (isDarkMode) {
                navbar.classList.remove('navbar-light', 'bg-white');
                navbar.classList.add('navbar-dark', 'bg-dark');
                footer.classList.remove('bg-light');
                footer.classList.add('bg-dark', 'text-light');
            } else {
                navbar.classList.remove('navbar-dark', 'bg-dark');
                navbar.classList.add('navbar-light', 'bg-white');
                footer.classList.remove('bg-dark', 'text-light');
                footer.classList.add('bg-light');
            }
            
            // Atualizar gráficos se existirem
            if (comparativoChart && lancamentos) {
                // Aplicar filtros atuais para atualizar os gráficos
                aplicarFiltros();
            }
        }

        function configurarFiltrosPeriodo() {
            const periodoSelect = document.getElementById('periodo');
            const filtroMensal = document.querySelector('.filtro-mensal');
            const filtroAnual = document.querySelector('.filtro-anual');
            
            periodoSelect.addEventListener('change', function() {
                if (this.value === 'mensal') {
                    filtroMensal.style.display = 'block';
                    filtroAnual.style.display = 'none';
                } else {
                    filtroMensal.style.display = 'none';
                    filtroAnual.style.display = 'block';
                }
                
                // Aplicar filtros automaticamente ao mudar o período
                aplicarFiltros();
            });
            
            // Event listeners para os filtros de mês e ano
            document.getElementById('mes').addEventListener('change', aplicarFiltros);
            document.getElementById('ano').addEventListener('change', function() {
                // Atualizar meses disponíveis quando o ano mudar
                atualizarFiltros();
                aplicarFiltros();
            });
            document.getElementById('anoAnual').addEventListener('change', aplicarFiltros);
            document.getElementById('categoria').addEventListener('change', aplicarFiltros);
        }

        function atualizarTituloTabela(periodo = null, mes = null, ano = null) {
            if (!periodo) {
                periodo = document.getElementById('periodo').value;
            }
            if (!mes && periodo === 'mensal') {
                mes = parseInt(document.getElementById('mes').value);
            }
            if (!ano) {
                ano = periodo === 'mensal' ? document.getElementById('ano').value : document.getElementById('anoAnual').value;
            }
            
            let titulo = 'Fluxo de Caixa - ';
            
            if (periodo === 'mensal') {
                titulo += `${meses[mes]}/${ano}`;
            } else {
                titulo += `Ano/${ano}`;
            }
            
            document.getElementById('titulo-tabela').textContent = titulo;
        }

        function limparFiltros() {
            document.getElementById('periodo').value = 'mensal';
            
            // Atualizar filtros com base nos dados existentes
            atualizarFiltros();
            
            document.getElementById('categoria').value = '';
            document.getElementById('tipo').value = '';
            
            // Mostrar filtro mensal e esconder anual
            document.querySelector('.filtro-mensal').style.display = 'block';
            document.querySelector('.filtro-anual').style.display = 'none';
            
            // Aplicar filtros (que agora serão "sem filtro")
            aplicarFiltros();
        }

        function salvarLancamento() {
            // Obter valores do formulário
            const id = document.getElementById('lancamentoId').value;
            const data = document.getElementById('data').value;
            const descricao = document.getElementById('descricao').value;
            
            console.log(`🔍 DEBUG SALVAR LANÇAMENTO - Data obtida do formulário: "${data}"`);
            console.log(`🔍 DEBUG SALVAR LANÇAMENTO - Data convertida: ${new Date(data)}`);
            const categoria = document.getElementById('categoriaModal').value;
            const banco = document.getElementById('bancoModal').value;
            const conta = document.getElementById('contaModal').value;
            const tipo = document.querySelector('input[name="tipo"]:checked').value;
            const tipoTransacao = document.getElementById('tipoTransacao').value;
            const cartao = document.getElementById('cartaoModal').value;
            const contaDestino = document.getElementById('contaDestino').value;
            const valor = parseFloat(document.getElementById('valor').value);
            const status = document.querySelector('input[name="status"]:checked').value;
            
            if (!data || !descricao || !categoria || !banco || !conta || !tipoTransacao || !valor) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            // Validar se cartão foi selecionado quando tipo de transação for crédito
            if (tipoTransacao === 'credito' && !cartao) {
                alert('Por favor, selecione um cartão de crédito.');
                return;
            }
            
            // Validar se conta de destino foi preenchida quando for transferência entre contas
            if (tipoTransacao === 'transferencia_contas' && !contaDestino) {
                alert('Por favor, informe a conta de destino para a transferência.');
                return;
            }
            
            if (modoEdicao && id) {
                // Editar lançamento existente
                const index = lancamentos.findIndex(l => l.id == id);
                if (index !== -1) {
                    const lancamentoAntigo = lancamentos[index];
                    
                    // Reverter limite do cartão se era crédito antes
                    if (lancamentoAntigo.tipoTransacao === 'credito' && lancamentoAntigo.cartao) {
                        atualizarLimiteCartao(lancamentoAntigo.cartao, lancamentoAntigo.valor, 'adicionar');
                    }
                    
                    // Se for transferência, atualizar ambos os lançamentos
                    if (lancamentoAntigo.tipoTransacao === 'transferencia_contas') {
                        const timestamp = id.replace('_entrada', '').replace('_saida', '');
                        const idEntrada = timestamp + '_entrada';
                        const idSaida = timestamp + '_saida';
                        
                        // Atualizar lançamento de saída
                        const indexSaida = lancamentos.findIndex(l => l.id == idSaida);
                        if (indexSaida !== -1) {
                            lancamentos[indexSaida] = {
                                id: idSaida,
                                data,
                                descricao: `Transferência enviada: ${descricao}`,
                                categoria,
                                banco,
                                conta,
                                tipo: 'saida',
                                tipoTransacao: 'transferencia_contas',
                                cartao: '',
                                contaDestino,
                                valor,
                                status
                            };
                        }
                        
                        // Atualizar lançamento de entrada
                        const indexEntrada = lancamentos.findIndex(l => l.id == idEntrada);
                        if (indexEntrada !== -1) {
                            lancamentos[indexEntrada] = {
                                id: idEntrada,
                                data,
                                descricao: `Transferência recebida: ${descricao}`,
                                categoria,
                                banco,
                                conta: contaDestino,
                                tipo: 'entrada',
                                tipoTransacao: 'transferencia_contas',
                                cartao: '',
                                contaDestino: conta,
                                valor,
                                status
                            };
                        }
                    } else {
                        // Editar lançamento normal
                        lancamentos[index] = {
                            id: id,
                            data,
                            descricao,
                            categoria,
                            banco,
                            conta,
                            tipo,
                            tipoTransacao,
                            cartao,
                            contaDestino,
                            valor,
                            status
                        };
                    }
                }
            } else {
                // Não permitir criação de transferências através desta função
                // Transferências devem ser criadas apenas através da função específica
                if (tipoTransacao === 'transferencia_contas') {
                    alert('Use a função específica de transferência entre contas.');
                    return;
                } else {
                    // Adicionar novo lançamento normal (não transferência)
                    const novoLancamento = {
                        id: nextId++,
                        data,
                        descricao,
                        categoria,
                        banco,
                        conta,
                        tipo,
                        tipoTransacao,
                        cartao,
                        contaDestino,
                        valor,
                        status
                    };
                    
                    lancamentos.push(novoLancamento);
                }
            }
            
            // Atualizar limite do cartão se for transação de crédito
            if (tipoTransacao === 'credito' && cartao && tipo === 'saida') {
                atualizarLimiteCartao(cartao, valor, 'subtrair');
            }
            
            // Salvar dados no localStorage
            salvarDados();
            
            // Fechar o modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('lancamentoModal'));
            modal.hide();
            
            // Limpar o formulário e resetar modo
            document.getElementById('lancamentoForm').reset();
            modoEdicao = false;
            document.getElementById('modalLancamentoTitulo').textContent = 'Adicionar Lançamento';
            
            // Configurar data atual novamente
            document.getElementById('data').value = new Date().toISOString().split('T')[0];
            
            // Atualizar filtros com base nos novos dados
            atualizarFiltros();
            
            // Aplicar filtros para atualizar a visualização
            aplicarFiltros();
            
            // Verificar alertas de orçamento
            verificarAlertasOrcamento();
            
            // Atualizar fluxo de caixa em tempo real
            carregarFluxoCaixa();
            
            alert(`Lançamento ${modoEdicao ? 'atualizado' : 'adicionado'} com sucesso!`);
        }

        function confirmarExclusao(id) {
            console.log('=== FUNÇÃO CONFIRMAR EXCLUSÃO ===');
            console.log('ID recebido:', id);
            console.log('Tipo do ID:', typeof id);
            
            // Buscar com comparação mais flexível
            const lancamento = lancamentos.find(l => {
                const match = l.id == id || l.id === id || String(l.id) === String(id);
                if (match) {
                    console.log('Match encontrado para confirmação:', l.id, 'vs', id, 'tipo:', l.tipoTransacao);
                }
                return match;
            });
            
            console.log('Lançamento encontrado para confirmação:', lancamento);
            if (!lancamento) {
                console.log('ERRO: Lançamento não encontrado para confirmação!');
                return;
            }
            
            lancamentoParaExcluir = id;
            document.getElementById('lancamento-descricao').textContent = `${lancamento.descricao} - ${lancamento.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmacaoModal'));
            modal.show();
        }

        function excluirLancamento() {
            if (lancamentoParaExcluir === null) return;
            
            // Encontrar o lançamento para verificar se é transferência
            const lancamento = lancamentos.find(l => l.id == lancamentoParaExcluir);
            
            // Se for transferência, verificar se é do tipo novo ou antigo
            if (lancamento && lancamento.tipoTransacao === 'transferencia_contas') {
                if (lancamento.tipo === 'transferencia') {
                    // Nova lógica: transferência única - remover apenas este lançamento
                    console.log('Excluindo transferência única (novo formato):', lancamento.id);
                    lancamentos = lancamentos.filter(l => l.id != lancamentoParaExcluir);
                } else {
                    // Lógica antiga: transferência dupla (entrada e saída)
                    const timestamp = lancamentoParaExcluir.replace('_entrada', '').replace('_saida', '');
                    const idEntrada = timestamp + '_entrada';
                    const idSaida = timestamp + '_saida';
                    console.log('Excluindo transferência completa (formato antigo):', { idEntrada, idSaida });
                    lancamentos = lancamentos.filter(l => l.id != idEntrada && l.id != idSaida);
                }
            } else {
                // Remover apenas o lançamento específico
                lancamentos = lancamentos.filter(l => l.id != lancamentoParaExcluir);
            }
            
            // Salvar dados no localStorage
            salvarDados();
            
            // Fechar o modal de confirmação
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmacaoModal'));
            modal.hide();
            
            // Atualizar filtros com base nos dados atualizados
            atualizarFiltros();
            
            // Aplicar filtros para atualizar a visualização
            aplicarFiltros();
            
            // Atualizar fluxo de caixa em tempo real
            carregarFluxoCaixa();
            
            // Atualizar saldos por conta
            atualizarSaldosPorConta();
            
            alert('Lançamento excluído com sucesso!');
            lancamentoParaExcluir = null;
        }

        function excluirLancamentoDireto(id) {
            console.log('=== FUNÇÃO EXCLUIR LANÇAMENTO DIRETO ===');
            console.log('ID recebido:', id);
            console.log('Tipo do ID:', typeof id);
            console.log('Total de lançamentos:', lancamentos.length);
            console.log('IDs disponíveis:', lancamentos.map(l => ({ id: l.id, tipo: typeof l.id, tipoTransacao: l.tipoTransacao })));
            
            // Buscar com comparação mais flexível
            const lancamento = lancamentos.find(l => {
                const match = l.id == id || l.id === id || String(l.id) === String(id);
                if (match) {
                    console.log('Match encontrado para exclusão:', l.id, 'vs', id, 'tipo:', l.tipoTransacao);
                }
                return match;
            });
            
            console.log('Lançamento encontrado:', lancamento);
            if (!lancamento) {
                console.log('ERRO: Lançamento não encontrado!');
                console.log('Tentando busca alternativa...');
                // Busca alternativa para transferências
                const transferencia = lancamentos.find(l => l.tipoTransacao === 'transferencia_contas' && l.tipo === 'transferencia');
                console.log('Transferências disponíveis para exclusão:', transferencia);
                return;
            }
            
            if (confirm(`Deseja excluir o lançamento "${lancamento.descricao}" diretamente?`)) {
                // Se for transferência, verificar se é do tipo novo ou antigo
                if (lancamento.tipoTransacao === 'transferencia_contas') {
                    if (lancamento.tipo === 'transferencia') {
                        // Nova lógica: transferência única - remover apenas este lançamento
                        console.log('Excluindo transferência única (novo formato):', lancamento.id);
                        lancamentos = lancamentos.filter(l => l.id != id);
                    } else {
                        // Lógica antiga: transferência dupla (entrada e saída)
                        const timestamp = id.replace('_entrada', '').replace('_saida', '');
                        const idEntrada = timestamp + '_entrada';
                        const idSaida = timestamp + '_saida';
                        console.log('Excluindo transferência completa (formato antigo):', { idEntrada, idSaida });
                        lancamentos = lancamentos.filter(l => l.id != idEntrada && l.id != idSaida);
                    }
                } else {
                    // Remover apenas o lançamento específico
                    lancamentos = lancamentos.filter(l => l.id != id);
                }
                
                // Salvar dados no localStorage
                salvarDados();
                
                // Atualizar filtros com base nos dados atualizados
                atualizarFiltros();
                
                // Aplicar filtros para atualizar a visualização
                aplicarFiltros();
                
                // Atualizar fluxo de caixa em tempo real
                carregarFluxoCaixa();
                
                // Atualizar saldos por conta
                atualizarSaldosPorConta();
                
                alert('Lançamento excluído com sucesso!');
            }
        }

        function editarLancamento(id) {
            console.log('=== FUNÇÃO EDITAR LANÇAMENTO ===');
            console.log('ID recebido:', id);
            console.log('Tipo do ID:', typeof id);
            console.log('Total de lançamentos:', lancamentos.length);
            console.log('IDs disponíveis:', lancamentos.map(l => ({ id: l.id, tipo: typeof l.id, tipoTransacao: l.tipoTransacao })));
            
            // Buscar com comparação mais flexível
            const lancamento = lancamentos.find(l => {
                const match = l.id == id || l.id === id || String(l.id) === String(id);
                if (match) {
                    console.log('Match encontrado:', l.id, 'vs', id, 'tipo:', l.tipoTransacao);
                }
                return match;
            });
            
            console.log('Lançamento encontrado:', lancamento);
            if (!lancamento) {
                console.log('ERRO: Lançamento não encontrado!');
                console.log('Tentando busca alternativa...');
                // Busca alternativa para transferências
                const transferencia = lancamentos.find(l => l.tipoTransacao === 'transferencia_contas' && l.tipo === 'transferencia');
                console.log('Transferências disponíveis:', transferencia);
                return;
            }
            
            // Preencher o formulário com os dados do lançamento
            document.getElementById('lancamentoId').value = lancamento.id;
            document.getElementById('data').value = lancamento.data;
            document.getElementById('descricao').value = lancamento.descricao;
            document.getElementById('categoriaModal').value = lancamento.categoria;
            
            // Preencher banco e conta (se existirem)
            if (lancamento.banco) {
                document.getElementById('bancoModal').value = lancamento.banco;
                carregarContas(); // Carregar contas do banco selecionado
                setTimeout(() => {
                    if (lancamento.conta) {
                        document.getElementById('contaModal').value = lancamento.conta;
                    }
                }, 100);
            }
            
            // Para transferências, definir como saída por padrão (já que é uma movimentação de saída da conta origem)
            const tipoParaModal = lancamento.tipo === 'transferencia' ? 'saida' : lancamento.tipo;
            const inputTipo = document.querySelector(`input[name="tipo"][value="${tipoParaModal}"]`);
            if (inputTipo) {
                inputTipo.checked = true;
            } else {
                console.warn('Tipo não encontrado no modal:', tipoParaModal);
                // Fallback para saída
                document.querySelector(`input[name="tipo"][value="saida"]`).checked = true;
            }
            
            // Preencher tipo de transação (se existir)
            if (lancamento.tipoTransacao) {
                document.getElementById('tipoTransacao').value = lancamento.tipoTransacao;
                
                // Mostrar campo de cartão se for crédito
                if (lancamento.tipoTransacao === 'credito') {
                    document.getElementById('cartaoDiv').style.display = 'block';
                    document.getElementById('cartaoModal').required = true;
                    if (lancamento.cartao) {
                        document.getElementById('cartaoModal').value = lancamento.cartao;
                    }
                }
                
                // Mostrar campo de conta destino se for transferência entre contas
                if (lancamento.tipoTransacao === 'transferencia_contas') {
                    document.getElementById('contaDestinoDiv').style.display = 'block';
                    document.getElementById('contaDestino').required = true;
                    
                    // Para transferências do novo tipo (tipo === 'transferencia')
                    if (lancamento.tipo === 'transferencia') {
                        // Preencher banco e conta de destino
                        if (lancamento.bancoDestino && lancamento.contaDestino) {
                            // Criar valor no formato esperado pelo select
                            const valorDestino = `${lancamento.bancoDestino}_${lancamento.contaDestino}`;
                            document.getElementById('contaDestino').value = valorDestino;
                        }
                    } else {
                        // Lógica antiga para compatibilidade
                        if (lancamento.contaDestino) {
                            document.getElementById('contaDestino').value = lancamento.contaDestino;
                        }
                    }
                }
            }
            
            document.getElementById('valor').value = lancamento.valor;
            
            // Definir status (padrão para "realizado" se não existir)
            const status = lancamento.status || 'realizado';
            const inputStatus = document.querySelector(`input[name="status"][value="${status}"]`);
            if (inputStatus) {
                inputStatus.checked = true;
            } else {
                console.warn('Status não encontrado no modal:', status);
                // Fallback para realizado
                document.querySelector(`input[name="status"][value="realizado"]`).checked = true;
            }
            
            // Alterar para modo edição
            modoEdicao = true;
            document.getElementById('modalLancamentoTitulo').textContent = 'Editar Lançamento';
            
            // Abrir o modal
            const modal = new bootstrap.Modal(document.getElementById('lancamentoModal'));
            modal.show();
        }

        function marcarComoRealizado(id) {
            console.log('=== DEBUG marcarComoRealizado ===');
            console.log('usuarioAtual:', usuarioAtual);
            
            // Usar o mesmo padrão da função carregarDadosSalvos
            if (!usuarioAtual) {
                console.log('Usuário não está logado');
                alert('Erro: Usuário não está logado.');
                return;
            }
            
            const userPrefix = `financas_${usuarioAtual.email}_`;
            console.log('userPrefix:', userPrefix);
            
            const lancamentos = JSON.parse(localStorage.getItem(`${userPrefix}Lancamentos`)) || [];
            console.log('lancamentos carregados:', lancamentos);
            
            // Buscar lançamento usando comparação flexível
            const lancamento = lancamentos.find(l => l.id == id);
            
            if (!lancamento) {
                console.log('ID procurado:', id);
                console.log('IDs disponíveis:', lancamentos.map(l => l.id));
                console.log('Chaves do localStorage:', Object.keys(localStorage));
                alert('Lançamento não encontrado.');
                return;
            }
            
            if (lancamento.status !== 'previsto') {
                alert('Este lançamento não está marcado como previsto.');
                return;
            }
            
            // Confirmar a ação
            if (confirm('Deseja marcar este lançamento como realizado?')) {
                // Alterar status para realizado
                lancamento.status = 'realizado';
                
                // Salvar no localStorage com o prefixo do usuário
                localStorage.setItem(`${userPrefix}Lancamentos`, JSON.stringify(lancamentos));
                console.log('Dados salvos com sucesso');
                
                // Recarregar a tabela
                carregarLancamentos();
                
                // Atualizar fluxo de caixa em tempo real
                carregarFluxoCaixa();
                
                alert('Lançamento marcado como realizado com sucesso!');
            }
        }

        function adicionarCategoria() {
            const input = document.getElementById('nova-categoria');
            const categoria = input.value.trim();
            
            if (!categoria) {
                alert('Por favor, digite o nome da categoria.');
                return;
            }
            
            if (categorias.includes(categoria)) {
                alert('Esta categoria já existe.');
                return;
            }
            
            // Adicionar à lista de categorias
            categorias.push(categoria);
            
            // Salvar dados no localStorage
            salvarDados();
            
            // Atualizar os selects e a lista de categorias
            carregarCategorias();
            
            // Limpar o campo de entrada
            input.value = '';
            
            alert(`Categoria "${categoria}" adicionada com sucesso!`);
        }

        function removerCategoria(li) {
            const categoria = li.firstChild.textContent.trim();
            
            // Verificar se a categoria está em uso
            const categoriaEmUso = lancamentos.some(l => l.categoria === categoria);
            
            if (categoriaEmUso) {
                alert(`Não é possível remover a categoria "${categoria}" porque está sendo usada em lançamentos.`);
                return;
            }
            
            if (confirm(`Tem certeza que deseja remover a categoria "${categoria}"?`)) {
                // Remover da lista de categorias
                categorias = categorias.filter(c => c !== categoria);
                
                // Salvar dados no localStorage
                salvarDados();
                
                // Atualizar os selects e a lista de categorias
                carregarCategorias();
                
                alert(`Categoria "${categoria}" removida com sucesso!`);
            }
        }

        function salvarSaldoInicial() {
            const novoSaldo = parseFloat(document.getElementById('saldo-inicial-input').value) || 0;
            saldoInicial = novoSaldo;
            
            // Salvar dados no localStorage
            salvarDados();
            
            // Aplicar filtros para atualizar a visualização
            aplicarFiltros();
            
            alert('Saldo inicial atualizado com sucesso!');
        }

        function limparDados() {
            const confirmar = confirm(
                'ATENÇÃO: Esta ação irá remover TODOS os dados do sistema:\n\n' +
                '• Todos os lançamentos\n' +
                '• Todas as contas bancárias\n' +
                '• Todos os cartões\n' +
                '• Todas as categorias personalizadas\n' +
                '• Todos os orçamentos\n' +
                '• Todos os investimentos\n' +
                '• Todos os dividendos\n' +
                '• Todos os ativos e corretoras\n' +
                '• Saldo inicial\n\n' +
                'Esta ação NÃO PODE ser desfeita!\n\n' +
                'Deseja continuar?'
            );
            
            if (confirmar) {
                const confirmarNovamente = confirm(
                    'Última confirmação:\n\n' +
                    'Tem ABSOLUTA CERTEZA que deseja apagar todos os dados?\n\n' +
                    'Digite "SIM" na próxima caixa se quiser continuar.'
                );
                
                if (confirmarNovamente) {
                    const digitarSim = prompt('Digite "SIM" (em maiúsculas) para confirmar:');
                    
                    if (digitarSim === 'SIM') {
                        // Obter o prefixo do usuário atual
                        const userPrefix = `financas_${usuarioAtual.email}_`;
                        
                        // Limpar todos os dados do localStorage
                        localStorage.removeItem(`${userPrefix}Lancamentos`);
                        localStorage.removeItem(`${userPrefix}Bancos`);
                        localStorage.removeItem('bancos'); // Chave sem prefixo usada pelo sistema
                        localStorage.removeItem(`${userPrefix}Cartoes`);
                        localStorage.removeItem('cartoes'); // Chave sem prefixo usada pelo sistema
                        localStorage.removeItem(`${userPrefix}Categorias`);
                        localStorage.removeItem(`${userPrefix}SaldoInicial`);
                        localStorage.removeItem(`${userPrefix}Orcamentos`);
                        localStorage.removeItem(`${userPrefix}Investimentos`);
                        localStorage.removeItem(`${userPrefix}Dividendos`);
                        localStorage.removeItem(`${userPrefix}NextId`);
                        localStorage.removeItem(`${userPrefix}NextInvestimentoId`);
                        localStorage.removeItem(`${userPrefix}NextDividendoId`);
                        localStorage.removeItem(`${userPrefix}Ativos`);
                        localStorage.removeItem(`${userPrefix}Corretoras`);
                        
                        // Limpar dados legados (sem prefixo) para compatibilidade
                        localStorage.removeItem('lancamentos');
                        localStorage.removeItem('bancos');
                        localStorage.removeItem('cartoes');
                        localStorage.removeItem('categorias');
                        localStorage.removeItem('saldoInicial');
                        localStorage.removeItem('orcamentos');
                        
                        // Reinicializar arrays e variáveis
                        lancamentos = [];
                        bancos = [];
                        cartoes = [];
                        categorias = ['Alimentação', 'Transporte', 'Saúde', 'Educação', 'Lazer', 'Moradia', 'Outros'];
                        saldoInicial = 0;
                        nextId = 1;
                        orcamentos = [];
                        investimentos = [];
                        dividendos = [];
                        nextInvestimentoId = 1;
                        nextDividendoId = 1;
                        ativos = [];
                        corretoras = [];
                        
                        // Limpar o campo de saldo inicial
                        document.getElementById('saldo-inicial-input').value = '0';
                        
                        // Salvar dados no localStorage
                        salvarDados();
                        
                        // Recarregar todas as interfaces
                        carregarLancamentos();
                        carregarFluxoCaixa();
                        carregarTabelaBancos();
                        carregarBancos();
                        carregarCartoes();
                        carregarCategorias();
                        carregarInvestimentos();
                        
                        // Atualizar filtros
                        atualizarFiltros();
                        
                        // Aplicar filtros para atualizar a visualização
                        aplicarFiltros();
                        
                        // Atualizar tabela de orçamentos
                        atualizarTabelaOrcamentos();
                        
                        // Atualizar tabelas de investimentos
                        atualizarTabelaInvestimentos();
                        atualizarTabelaDividendos();
                        atualizarDashboardInvestimentos();
                        
                        alert('Todos os dados foram removidos com sucesso!\n\nO sistema foi resetado para o estado inicial.');
                    } else {
                        alert('Operação cancelada. Dados preservados.');
                    }
                } else {
                    alert('Operação cancelada. Dados preservados.');
                }
            }
        }
        
        function limparBancosTeste() {
            const confirmar = confirm(
                'Esta ação irá remover apenas os bancos com contas de teste.\n\n' +
                'Isso permitirá que você recadastre suas contas reais.\n\n' +
                'Deseja continuar?'
            );
            
            if (confirmar) {
                // Remover apenas os bancos do localStorage (ambas as chaves para garantir)
                localStorage.removeItem('bancos');
                if (typeof usuarioAtual !== 'undefined' && usuarioAtual.email) {
                    const userPrefix = `financas_${usuarioAtual.email}_`;
                    localStorage.removeItem(`${userPrefix}Bancos`);
                }
                
                // Reinicializar array de bancos
                bancos = [];
                
                // Recarregar interfaces relacionadas a bancos
                carregarTabelaBancos();
                carregarBancos();
                
                // Atualizar filtros
                atualizarFiltros();
                
                alert('Bancos de teste removidos com sucesso!\n\nAgora você pode recadastrar seus bancos e contas reais.');
            }
        }
        
        // Funções para gerenciar orçamentos
        function salvarOrcamento() {
            const categoria = document.getElementById('categoria-orcamento').value;
            const valor = parseFloat(document.getElementById('valor-orcamento').value);
            
            if (!categoria || !valor || isNaN(valor)) {
                alert('Por favor, selecione uma categoria e informe um valor válido!');
                return;
            }
            
            // Verificar se já existe orçamento para esta categoria
            const index = orcamentos.findIndex(o => o.categoria === categoria);
            
            if (index !== -1) {
                // Atualizar orçamento existente
                orcamentos[index].valor = valor;
            } else {
                // Adicionar novo orçamento
                orcamentos.push({
                    categoria: categoria,
                    valor: valor
                });
            }
            
            // Salvar dados
            salvarDados();
            
            // Limpar formulário
            document.getElementById('categoria-orcamento').value = '';
            document.getElementById('valor-orcamento').value = '';
            
            // Atualizar tabela de orçamentos
            atualizarTabelaOrcamentos();
            
            // Verificar alertas
            verificarAlertasOrcamento();
        }
        
        function removerOrcamento(categoria) {
            if (confirm(`Tem certeza que deseja remover o orçamento para a categoria ${categoria}?`)) {
                const index = orcamentos.findIndex(o => o.categoria === categoria);
                
                if (index !== -1) {
                    orcamentos.splice(index, 1);
                    salvarDados();
                    atualizarTabelaOrcamentos();
                }
            }
        }
        
        function atualizarTabelaOrcamentos() {
            const tbody = document.getElementById('tabela-orcamentos').querySelector('tbody');
            tbody.innerHTML = '';
            
            if (orcamentos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <p>Nenhum orçamento definido. Adicione limites para suas categorias de gastos.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Obter mês e ano atual para cálculo de gastos
            const dataAtual = new Date();
            const mesAtual = dataAtual.getMonth();
            const anoAtual = dataAtual.getFullYear();
            
            orcamentos.forEach(orcamento => {
                // Calcular gasto atual do mês para esta categoria
                const gastoAtual = calcularGastoCategoriaMesAtual(orcamento.categoria);
                
                // Calcular porcentagem do orçamento utilizado
                const porcentagem = (gastoAtual / orcamento.valor) * 100;
                
                // Definir classe de status baseado na porcentagem
                let statusClass = 'bg-success';
                if (porcentagem >= 90) {
                    statusClass = 'bg-danger';
                } else if (porcentagem >= 70) {
                    statusClass = 'bg-warning';
                }
                
                const tr = document.createElement('tr');
                tr.dataset.categoria = orcamento.categoria;
                tr.innerHTML = `
                    <td>${orcamento.categoria}</td>
                    <td>${orcamento.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td>${gastoAtual.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${Math.min(porcentagem, 100)}%" 
                                aria-valuenow="${porcentagem}" aria-valuemin="0" aria-valuemax="100">
                                ${porcentagem.toFixed(0)}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger remover-orcamento">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        function calcularGastoCategoriaMesAtual(categoria) {
            const dataAtual = new Date();
            const mesAtual = dataAtual.getMonth();
            const anoAtual = dataAtual.getFullYear();
            
            // Filtrar lançamentos do mês atual e da categoria específica
            const lancamentosFiltrados = lancamentos.filter(l => {
                const dataLancamento = new Date(l.data);
                return dataLancamento.getMonth() === mesAtual && 
                       dataLancamento.getFullYear() === anoAtual && 
                       l.categoria === categoria && 
                       l.tipo === 'saida';
            });
            
            // Somar valores
            return lancamentosFiltrados.reduce((total, l) => total + l.valor, 0);
        }
        
        function verificarAlertasOrcamento() {
            // Verificar se os alertas estão ativados
            if (!document.getElementById('alertas-orcamento').checked) {
                return;
            }
            
            // Obter mês e ano atual
            const dataAtual = new Date();
            const mesAtual = dataAtual.getMonth();
            const anoAtual = dataAtual.getFullYear();
            
            // Verificar cada orçamento
            orcamentos.forEach(orcamento => {
                const gastoAtual = calcularGastoCategoriaMesAtual(orcamento.categoria);
                const porcentagem = (gastoAtual / orcamento.valor) * 100;
                
                // Alertar se o gasto estiver acima de 90% do orçamento
                if (porcentagem >= 90) {
                    const mensagem = `Alerta: Você já utilizou ${porcentagem.toFixed(0)}% do orçamento para ${orcamento.categoria} este mês!`;
                    
                    // Verificar se já existe um alerta para esta categoria
                    const alertaExistente = document.querySelector(`[data-alerta-categoria="${orcamento.categoria}"]`);
                    
                    if (!alertaExistente) {
                        // Criar alerta
                        const alerta = document.createElement('div');
                        alerta.className = 'alert alert-danger alert-dismissible fade show';
                        alerta.setAttribute('role', 'alert');
                        alerta.dataset.alertaCategoria = orcamento.categoria;
                        alerta.innerHTML = `
                            ${mensagem}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        
                        // Adicionar alerta no topo da página
                        const container = document.querySelector('.container');
                        container.insertBefore(alerta, container.firstChild);
                    }
                }
            });
        }

        // ===== FUNÇÕES DE BACKUP SIMPLIFICADO =====
        
        // Função para criar backup completo em JSON (simples para usuário final)
        function criarBackupSimples() {
            try {
                // Coletar todos os dados disponíveis (independente de usuário)
                const dadosCompletos = {
                    versao: '2.0',
                    dataBackup: new Date().toISOString(),
                    usuario: usuarioAtual ? usuarioAtual.email : 'usuario_anonimo',
                    dados: {
                        lancamentos: lancamentos || [],
                        saldoInicial: saldoInicial || 0,
                        nextId: nextId || 1,
                        categorias: categorias || [],
                        orcamentos: orcamentos || [],
                        investimentos: investimentos || [],
                        dividendos: dividendos || [],
                        nextInvestimentoId: nextInvestimentoId || 1,
                        nextDividendoId: nextDividendoId || 1,
                        ativos: ativos || [],
                        corretoras: corretoras || [],
                        bancos: bancos || [],
                        cartoes: cartoes || [],
                        tema: tema || 'light'
                    }
                };
                
                // Converter para JSON
                const jsonString = JSON.stringify(dadosCompletos, null, 2);
                
                // Criar arquivo para download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Criar link de download
                const link = document.createElement('a');
                link.href = url;
                const dataFormatada = new Date().toISOString().split('T')[0];
                link.download = `backup-financas-${dataFormatada}.json`;
                
                // Fazer download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Mostrar confirmação
                const totalItens = (dadosCompletos.dados.lancamentos?.length || 0) + 
                                 (dadosCompletos.dados.investimentos?.length || 0) + 
                                 (dadosCompletos.dados.bancos?.length || 0);
                
                alert(`✅ Backup criado com sucesso!\n\n📁 Arquivo: backup-financas-${dataFormatada}.json\n📊 Total de itens: ${totalItens}\n\n💡 Guarde este arquivo em local seguro!`);
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                alert('❌ Erro ao criar backup!\n\nTente novamente ou contate o suporte.');
            }
        }
        
        // Função para restaurar backup simples
        function restaurarBackupSimples(arquivo) {
            
            if (!arquivo) {
                alert('❌ Nenhum arquivo selecionado!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Parse do JSON
                    const dadosBackup = JSON.parse(e.target.result);
                    
                    // Validar estrutura do backup
                    if (!dadosBackup.dados) {
                        throw new Error('Formato de backup inválido - propriedade "dados" não encontrada');
                    }
                    
                    // Verificar se tem pelo menos uma das propriedades esperadas
                    const temDadosValidos = dadosBackup.dados.lancamentos !== undefined || 
                                          dadosBackup.dados.investimentos !== undefined || 
                                          dadosBackup.dados.bancos !== undefined ||
                                          dadosBackup.dados.cartoes !== undefined;
                    
                    if (!temDadosValidos) {
                        throw new Error('Backup não contém dados válidos');
                    }
                    
                    // Confirmar restauração
                    const totalItens = (dadosBackup.dados.lancamentos?.length || 0) + 
                                     (dadosBackup.dados.investimentos?.length || 0) + 
                                     (dadosBackup.dados.bancos?.length || 0);
                    
                    const dataBackup = new Date(dadosBackup.dataBackup).toLocaleDateString('pt-BR');
                    
                    if (!confirm(`🔄 Confirmar Restauração?\n\n📅 Data do backup: ${dataBackup}\n📊 Total de itens: ${totalItens}\n\n⚠️ ATENÇÃO: Todos os dados atuais serão substituídos!\n\nDeseja continuar?`)) {
                        return;
                    }
                    
                    // Mostrar indicador de carregamento
                    mostrarIndicadorCarregamento('Restaurando backup...');
                    
                    // Restaurar dados
                    const dados = dadosBackup.dados;
                    lancamentos = dados.lancamentos || [];
                    saldoInicial = dados.saldoInicial || 0;
                    nextId = dados.nextId || 1;
                    categorias = dados.categorias || [];
                    orcamentos = dados.orcamentos || [];
                    investimentos = dados.investimentos || [];
                    dividendos = dados.dividendos || [];
                    nextInvestimentoId = dados.nextInvestimentoId || 1;
                    nextDividendoId = dados.nextDividendoId || 1;
                    ativos = dados.ativos || [];
                    corretoras = dados.corretoras || [];
                    bancos = dados.bancos || [];
                    cartoes = dados.cartoes || [];
                    tema = dados.tema || 'light';
                    
                    // Salvar no localStorage
                    salvarDados();
                    
                    // Atualizar interface
                    carregarLancamentos();
                    atualizarDashboard();
                    carregarInvestimentos();
                    atualizarTabelaInvestimentos();
                    atualizarTabelaDividendos();
                    carregarBancos();
                    carregarTabelaBancos();
                    carregarCartoes();
                    carregarTabelaCartoes();
                    carregarAtivos();
                    carregarCorretoras();
                    
                    // Ocultar indicador
                    ocultarIndicadorCarregamento();
                    
                    // Mostrar sucesso
                    alert(`✅ Backup restaurado com sucesso!\n\n📊 Dados restaurados:\n• ${lancamentos.length} lançamentos\n• ${investimentos.length} investimentos\n• ${bancos.length} bancos\n• ${cartoes.length} cartões\n• ${ativos.length} ativos\n• ${corretoras.length} corretoras`);
                    
                } catch (error) {
                    ocultarIndicadorCarregamento();
                    console.error('Erro ao restaurar backup:', error);
                    
                    let mensagemErro = '❌ Erro ao restaurar backup!\n\n';
                    
                    if (error.message.includes('JSON')) {
                        mensagemErro += 'O arquivo não é um JSON válido.';
                    } else if (error.message.includes('dados')) {
                        mensagemErro += 'Estrutura do backup inválida: ' + error.message;
                    } else {
                        mensagemErro += 'Verifique se o arquivo é um backup válido gerado por esta aplicação.\n\nDetalhes: ' + error.message;
                    }
                    
                    alert(mensagemErro);
                }
            };
            
            reader.onerror = function() {
                alert('❌ Erro ao ler o arquivo!\n\nTente novamente.');
            };
            
            reader.readAsText(arquivo);
        }

        function exportarCSV() {
            if (lancamentos.length === 0 && investimentos.length === 0 && bancos.length === 0) {
                alert('Não há dados para exportar.');
                return;
            }
            
            // Criar um ZIP com múltiplos CSVs para backup completo
            const zip = new JSZip();
            
            // 1. LANÇAMENTOS COMPLETOS
            if (lancamentos.length > 0) {
                let csvLancamentos = "ID,Data,Descrição,Categoria,Tipo,TipoTransacao,Banco,Conta,Cartao,ContaDestino,Valor,Status\n";
                
                lancamentos.forEach(lancamento => {
                    const partesData = lancamento.data.split('-');
                    const dataLocal = new Date(partesData[0], partesData[1] - 1, partesData[2]);
                    const dataFormatada = dataLocal.toLocaleDateString('pt-BR');
                    
                    // Buscar nomes dos bancos e contas
                    const bancoNome = obterNomeBanco(lancamento.banco);
                    const contaNome = obterNomeConta(lancamento.banco, lancamento.conta);
                    const cartaoNome = obterNomeCartao(lancamento.cartao);
                    
                    csvLancamentos += `"${lancamento.id || ''}","${dataFormatada}","${lancamento.descricao || ''}","${lancamento.categoria || ''}","${lancamento.tipo || ''}","${lancamento.tipoTransacao || ''}","${bancoNome}","${contaNome}","${cartaoNome}","${lancamento.contaDestino || ''}","${(lancamento.valor || 0).toFixed(2)}","${lancamento.status || ''}"\n`;
                });
                
                zip.file("lancamentos.csv", csvLancamentos);
            }
            
            // 2. BANCOS E CONTAS
            if (bancos.length > 0) {
                let csvBancos = "BancoID,BancoNome,ContaID,ContaNumero,ContaTipo\n";
                
                bancos.forEach(banco => {
                    if (banco.contas && banco.contas.length > 0) {
                        banco.contas.forEach(conta => {
                            csvBancos += `"${banco.id}","${banco.nome}","${conta.id}","${conta.numero}","${conta.tipo}"\n`;
                        });
                    } else {
                        csvBancos += `"${banco.id}","${banco.nome}","","",""\n`;
                    }
                });
                
                zip.file("bancos.csv", csvBancos);
            }
            
            // 3. CARTÕES DE CRÉDITO
            if (cartoes.length > 0) {
                let csvCartoes = "CartaoID,Nome,Banco,Limite,Usado\n";
                
                cartoes.forEach(cartao => {
                    csvCartoes += `"${cartao.id}","${cartao.nome}","${cartao.banco}","${(cartao.limite || 0).toFixed(2)}","${(cartao.usado || 0).toFixed(2)}"\n`;
                });
                
                zip.file("cartoes.csv", csvCartoes);
            }
            
            // 4. INVESTIMENTOS
            if (investimentos.length > 0) {
                let csvInvestimentos = "ID,Data,Ativo,Categoria,TipoLancamento,Quantidade,PrecoUnitario,ValorTotal,Corretora\n";
                
                investimentos.forEach(inv => {
                    const partesData = inv.data.split('-');
                    const dataLocal = new Date(partesData[0], partesData[1] - 1, partesData[2]);
                    const dataFormatada = dataLocal.toLocaleDateString('pt-BR');
                    
                    csvInvestimentos += `"${inv.id || ''}","${dataFormatada}","${inv.ativo || ''}","${inv.categoria || ''}","${inv.tipoLancamento || ''}","${(inv.quantidade || 0).toFixed(6)}","${(inv.precoUnitario || 0).toFixed(6)}","${(inv.valorTotal || 0).toFixed(2)}","${inv.corretora || ''}"\n`;
                });
                
                zip.file("investimentos.csv", csvInvestimentos);
            }
            
            // 5. DIVIDENDOS E RENDIMENTOS
            if (dividendos.length > 0) {
                let csvDividendos = "ID,Data,Ativo,Tipo,Valor\n";
                
                dividendos.forEach(div => {
                    const partesData = div.data.split('-');
                    const dataLocal = new Date(partesData[0], partesData[1] - 1, partesData[2]);
                    const dataFormatada = dataLocal.toLocaleDateString('pt-BR');
                    
                    csvDividendos += `"${div.id || ''}","${dataFormatada}","${div.ativo || ''}","${div.tipo || ''}","${(div.valor || 0).toFixed(2)}"\n`;
                });
                
                zip.file("dividendos.csv", csvDividendos);
            }
            
            // 6. CATEGORIAS
            if (categorias.length > 0) {
                let csvCategorias = "Categoria\n";
                categorias.forEach(cat => {
                    csvCategorias += `"${cat}"\n`;
                });
                zip.file("categorias.csv", csvCategorias);
            }
            
            // 7. ORÇAMENTOS
            if (orcamentos.length > 0) {
                let csvOrcamentos = "Categoria,Valor\n";
                orcamentos.forEach(orc => {
                    csvOrcamentos += `"${orc.categoria}","${(orc.valor || 0).toFixed(2)}"\n`;
                });
                zip.file("orcamentos.csv", csvOrcamentos);
            }
            
            // Gerar e baixar o ZIP
            zip.generateAsync({type:"blob"}).then(function(content) {
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `backup-financas-${new Date().toISOString().split('T')[0]}.zip`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Backup completo exportado com sucesso! O arquivo ZIP contém todos os seus dados financeiros.');
            });
        }
        
        // Função de teste para verificar lançamentos mensais
        function testarLancamentoMensal() {
            console.log('🧪 TESTE: Iniciando teste de lançamento mensal');
            
            // Verificar lançamentos atuais
            console.log(`🧪 TESTE: Total de lançamentos: ${lancamentos.length}`);
            
            // Mostrar TODOS os lançamentos para análise
            console.log('🧪 TESTE: TODOS OS LANÇAMENTOS:');
            lancamentos.forEach((l, index) => {
                const dataObj = new Date(l.data);
                console.log(`   ${index + 1}. ID: ${l.id} | Data: "${l.data}" | Parsed: ${dataObj.toISOString()} | Mês: ${dataObj.getMonth()} | Ano: ${dataObj.getFullYear()} | Desc: ${l.descricao}`);
            });
            
            // Filtrar lançamentos de outubro 2024
            const outubros = lancamentos.filter(l => {
                const data = new Date(l.data);
                return data.getMonth() === 9 && data.getFullYear() === 2024; // Outubro = mês 9
            });
            
            console.log(`🧪 TESTE: Lançamentos de outubro 2024: ${outubros.length}`);
            outubros.forEach(l => {
                console.log(`   ID: ${l.id} | Data: ${l.data} | Desc: ${l.descricao} | Valor: ${l.valor}`);
            });
            
            // Procurar lançamentos que contenham "2024-10" na string da data
            const outubro2024String = lancamentos.filter(l => l.data && l.data.includes('2024-10'));
            console.log(`🧪 TESTE: Lançamentos com "2024-10" na string: ${outubro2024String.length}`);
            outubro2024String.forEach(l => {
                console.log(`   ID: ${l.id} | Data: "${l.data}" | Desc: ${l.descricao}`);
            });
            
            // Testar filtro de fluxo de caixa para outubro
            const dataInicio = '2024-10-01';
            const dataFim = '2024-10-31';
            
            console.log(`🧪 TESTE: Testando filtro de ${dataInicio} a ${dataFim}`);
            
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            
            const filtrados = lancamentos.filter(lancamento => {
                const dataLancamento = new Date(lancamento.data);
                return dataLancamento >= inicio && dataLancamento <= fim;
            });
            
            console.log(`🧪 TESTE: Lançamentos filtrados: ${filtrados.length}`);
            filtrados.forEach(l => {
                console.log(`   ID: ${l.id} | Data: ${l.data} | Desc: ${l.descricao} | Valor: ${l.valor}`);
            });
        }
        
        // Função para criar lançamento de teste de outubro
        function criarLancamentoTesteOutubro() {
            console.log('🧪 TESTE: Criando lançamento de teste para outubro 2024');
            
            const novoLancamento = {
                id: Date.now(),
                data: '2024-10-15',
                descricao: 'TESTE - Lançamento Outubro',
                categoria: 'Teste',
                valor: 100.00,
                tipo: 'entrada',
                status: 'confirmado'
            };
            
            console.log('🧪 TESTE: Lançamento criado:', novoLancamento);
            
            // Adicionar ao array
            lancamentos.push(novoLancamento);
            
            // Salvar no localStorage
            const userPrefix = localStorage.getItem('usuarioAtual') || 'default';
            localStorage.setItem(`${userPrefix}Lancamentos`, JSON.stringify(lancamentos));
            
            console.log('🧪 TESTE: Lançamento adicionado e salvo no localStorage');
            console.log(`🧪 TESTE: Total de lançamentos agora: ${lancamentos.length}`);
            
            // Testar imediatamente se aparece no filtro
            const outubros = lancamentos.filter(l => {
                const data = new Date(l.data);
                return data.getMonth() === 9 && data.getFullYear() === 2024;
            });
            
            console.log(`🧪 TESTE: Lançamentos de outubro após criação: ${outubros.length}`);
            
            return novoLancamento;
        }

        // Função para testar filtro mensal completo
        function testarFiltroMensal() {
            console.log('🧪 TESTE FILTRO MENSAL - Iniciando...');
            
            // Criar lançamento de teste para outubro 2024
            const lancamentoTeste = {
                id: Date.now() + Math.random(),
                data: '2024-10-15',
                descricao: 'TESTE FILTRO - Lançamento Outubro 2024',
                categoria: 'Teste',
                valor: 500.00,
                tipo: 'entrada',
                status: 'realizado'
            };
            
            // Adicionar ao array
            lancamentos.push(lancamentoTeste);
            console.log('✅ Lançamento de teste criado:', lancamentoTeste);
            
            // Testar filtro aplicarFiltros
            console.log('🔍 Testando função aplicarFiltros...');
            
            // Simular seleção de outubro 2024
            document.getElementById('periodo').value = 'mensal';
            document.getElementById('mes').value = '9'; // Outubro = mês 9 (0-indexed)
            document.getElementById('ano').value = '2024';
            
            console.log('📅 Filtros configurados: Mensal - Outubro/2024');
            
            // Executar filtro
            const periodo = 'mensal';
            const mes = 9; // Outubro
            const ano = '2024';
            
            const lancamentosFiltrados = lancamentos.filter(l => {
                const dataLancamento = new Date(l.data);
                const anoLancamento = dataLancamento.getFullYear().toString();
                const mesLancamento = dataLancamento.getMonth();
                
                console.log(`   Testando lançamento: ${l.descricao} | Data: ${l.data} | Ano: ${anoLancamento} | Mês: ${mesLancamento}`);
                
                let passaFiltro = true;
                
                // Filtro por período
                if (periodo === 'mensal') {
                    const passaAno = anoLancamento === ano;
                    const passaMes = mesLancamento === mes;
                    passaFiltro = passaAno && passaMes;
                    console.log(`     Passa ano (${anoLancamento} === ${ano}): ${passaAno}`);
                    console.log(`     Passa mês (${mesLancamento} === ${mes}): ${passaMes}`);
                    console.log(`     Passa filtro final: ${passaFiltro}`);
                }
                
                return passaFiltro;
            });
            
            console.log(`🎯 RESULTADO: ${lancamentosFiltrados.length} lançamentos encontrados para outubro 2024`);
            lancamentosFiltrados.forEach(l => {
                console.log(`   ✅ ${l.descricao} - ${l.data} - R$ ${l.valor}`);
            });
            
            // Remover lançamento de teste
            const index = lancamentos.findIndex(l => l.id === lancamentoTeste.id);
            if (index > -1) {
                lancamentos.splice(index, 1);
                console.log('🗑️ Lançamento de teste removido');
            }
            
            return lancamentosFiltrados;
        }
         
         // Função para testar outubro 2025 (ano correto dos dados)
         function testarOutubro2025() {
             console.log('🧪 TESTE: Verificando lançamentos de outubro 2025');
             
             // Filtrar lançamentos de outubro 2025
             const outubro2025 = lancamentos.filter(l => {
                 const data = new Date(l.data);
                 return data.getMonth() === 9 && data.getFullYear() === 2025; // Outubro = mês 9
             });
             
             console.log(`🧪 TESTE: Lançamentos de outubro 2025: ${outubro2025.length}`);
             outubro2025.forEach(l => {
                 console.log(`   ID: ${l.id} | Data: ${l.data} | Desc: ${l.descricao} | Valor: ${l.valor}`);
             });
             
             // Testar filtro de fluxo de caixa para outubro 2025
             const dataInicio = '2025-10-01';
             const dataFim = '2025-10-31';
             
             console.log(`🧪 TESTE: Testando filtro de ${dataInicio} a ${dataFim}`);
             
             const inicio = new Date(dataInicio);
             const fim = new Date(dataFim);
             
             const filtrados = lancamentos.filter(lancamento => {
                 const dataLancamento = new Date(lancamento.data);
                 return dataLancamento >= inicio && dataLancamento <= fim;
             });
             
             console.log(`🧪 TESTE: Lançamentos filtrados para outubro 2025: ${filtrados.length}`);
             filtrados.forEach(l => {
                 console.log(`   ID: ${l.id} | Data: ${l.data} | Desc: ${l.descricao} | Valor: ${l.valor}`);
             });
         }

         // Função para testar especificamente o lançamento de transferência
         function testarTransferencia() {
             console.log('🧪 TESTE TRANSFERÊNCIA - Iniciando...');
             
             // Procurar o lançamento específico de 10/10/2025
             const lancamentoTransferencia = lancamentos.find(l => 
                 l.data === '2025-10-10' && 
                 l.descricao === 'teste' && 
                 l.categoria === 'Salário' &&
                 l.tipoTransacao === 'transferencia'
             );
             
             if (lancamentoTransferencia) {
                 console.log('✅ Lançamento de transferência encontrado:');
                 console.log(`   Data: ${lancamentoTransferencia.data}`);
                 console.log(`   Descrição: ${lancamentoTransferencia.descricao}`);
                 console.log(`   Categoria: ${lancamentoTransferencia.categoria}`);
                 console.log(`   Tipo: ${lancamentoTransferencia.tipo}`);
                 console.log(`   tipoTransacao: ${lancamentoTransferencia.tipoTransacao || 'undefined'}`);
                 console.log(`   Valor: R$ ${lancamentoTransferencia.valor.toFixed(2)}`);
                 console.log(`   Status: ${lancamentoTransferencia.status}`);
                 console.log(`   Banco: ${lancamentoTransferencia.banco}`);
                 
                 // Verificar se está sendo excluído como transferência interna
                 const isTransferenciaInterna = lancamentoTransferencia.tipoTransacao === 'transferencia_interna';
                 console.log(`   🔍 É transferência interna (excluída): ${isTransferenciaInterna}`);
                 
                 if (isTransferenciaInterna) {
                     console.log('   ❌ PROBLEMA ENCONTRADO: Está marcado como transferência interna!');
                     console.log('   💡 SOLUÇÃO: Precisa alterar o tipo ou categoria para aparecer no relatório');
                 } else {
                     console.log('   ✅ Não é transferência interna, deveria aparecer no relatório');
                 }
                 
                 // Testar se aparece no filtro de outubro 2025
                 const dataLancamento = new Date(lancamentoTransferencia.data);
                 const isOutubro2025 = dataLancamento.getMonth() === 9 && dataLancamento.getFullYear() === 2025;
                 console.log(`   Está em outubro 2025: ${isOutubro2025}`);
                 
                 // Testar filtro de período
                 const dataInicio = new Date('2025-10-01');
                 const dataFim = new Date('2025-10-31');
                 const dentroDoFiltro = dataLancamento >= dataInicio && dataLancamento <= dataFim;
                 console.log(`   Dentro do filtro mensal: ${dentroDoFiltro}`);
                 
                 // Verificar como o tipo 'Transferência' é processado no fluxo de caixa
                 console.log(`   Tipo de movimentação: ${lancamentoTransferencia.tipo}`);
                 
                 // Simular processamento no fluxo de caixa
                 if (lancamentoTransferencia.tipo === 'entrada') {
                     console.log('   ➡️ Seria contabilizado como ENTRADA');
                 } else if (lancamentoTransferencia.tipo === 'saida') {
                     console.log('   ⬅️ Seria contabilizado como SAÍDA');
                 } else {
                     console.log('   ❓ Tipo não reconhecido como entrada ou saída - PODE SER O PROBLEMA!');
                 }
                 
             } else {
                 console.log('❌ Lançamento de transferência NÃO encontrado!');
                 console.log('📋 Verificando todos os lançamentos de 10/10/2025:');
                 
                 const lancamentos10Out = lancamentos.filter(l => l.data === '2025-10-10');
                 lancamentos10Out.forEach((l, index) => {
                     console.log(`   ${index + 1}. ${l.descricao} - ${l.categoria} - ${l.tipo} - tipoTransacao: ${l.tipoTransacao || 'undefined'} - R$ ${l.valor.toFixed(2)}`);
                 });
             }
         }
         
         // Funções auxiliares para obter nomes
        function obterNomeBanco(bancoId) {
            if (!bancoId) return '';
            const banco = bancos.find(b => b.id == bancoId);
            return banco ? banco.nome : '';
        }
        
        function obterNomeConta(bancoId, contaId) {
            if (!bancoId || !contaId) return '';
            const banco = bancos.find(b => b.id == bancoId);
            if (!banco || !banco.contas) return '';
            const conta = banco.contas.find(c => c.id == contaId);
            return conta ? conta.numero : '';
        }
        
        function obterNomeCartao(cartaoId) {
            if (!cartaoId) return '';
            const cartao = cartoes.find(c => c.id == cartaoId);
            return cartao ? cartao.nome : '';
        }
        
        function importarCSV() {
            const fileInput = document.getElementById('input-importar-csv');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }

            // Validações melhoradas de arquivo
            const isZip = file.name.toLowerCase().endsWith('.zip');
            const isCsv = file.type === 'text/csv' || file.name.toLowerCase().endsWith('.csv');
            
            // Verificar tamanho do arquivo (máximo 50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                alert('❌ Arquivo muito grande!\n\nTamanho máximo permitido: 50MB\nTamanho do arquivo: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
                fileInput.value = '';
                return;
            }
            
            if (!isZip && !isCsv) {
                alert('❌ Formato de arquivo inválido!\n\nFormatos aceitos:\n• ZIP (backup completo)\n• CSV (dados específicos)\n\nArquivo selecionado: ' + file.name);
                fileInput.value = '';
                return;
            }

            // Mostrar indicador de carregamento
            mostrarIndicadorCarregamento('Processando arquivo...');
            
            if (isZip) {
                importarBackupCompleto(file);
            } else {
                importarCSVLegado(file);
            }
        }
        
        function importarBackupCompleto(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    atualizarMensagemCarregamento('Lendo arquivo ZIP...');
                    
                    // Validar tamanho do buffer antes de processar
                    if (!e.target.result || e.target.result.byteLength === 0) {
                        throw new Error('Arquivo ZIP vazio ou corrompido');
                    }
                    
                    if (e.target.result.byteLength > 100 * 1024 * 1024) { // 100MB
                        throw new Error('Arquivo ZIP muito grande (máximo 100MB)');
                    }
                    
                    JSZip.loadAsync(e.target.result).then(function(zip) {
                        atualizarMensagemCarregamento('Verificando conteúdo do backup...');
                        
                        // Verificar se o ZIP contém arquivos CSV
                        const csvFiles = Object.keys(zip.files).filter(filename => filename.endsWith('.csv'));
                        
                        if (csvFiles.length === 0) {
                            ocultarIndicadorCarregamento();
                            alert('❌ Backup inválido!\n\nO arquivo ZIP não contém arquivos CSV válidos.\n\nVerifique se o arquivo é um backup gerado pela aplicação.');
                            document.getElementById('input-importar-csv').value = '';
                            return;
                        }

                        // Validar integridade do backup
                        const arquivosEsperados = ['lancamentos.csv', 'categorias.csv', 'bancos.csv'];
                        const arquivosEncontrados = csvFiles.filter(arquivo => arquivosEsperados.some(esperado => arquivo.includes(esperado)));
                        
                        if (arquivosEncontrados.length === 0) {
                            ocultarIndicadorCarregamento();
                            if (!confirm('⚠️ Backup incompleto!\n\nNão foram encontrados os arquivos principais:\n• lancamentos.csv\n• categorias.csv\n• bancos.csv\n\nDeseja continuar mesmo assim?')) {
                                document.getElementById('input-importar-csv').value = '';
                                return;
                            }
                            mostrarIndicadorCarregamento('Processando backup incompleto...');
                        }
                        
                        ocultarIndicadorCarregamento();
                        
                        // Perguntar ao usuário se deseja substituir ou adicionar os dados
                        const opcao = confirm('Como deseja importar os dados?\n\n✅ OK = SUBSTITUIR todos os dados existentes\n❌ Cancelar = ADICIONAR aos dados existentes\n\nArquivos encontrados: ' + csvFiles.length);
                        
                        mostrarIndicadorCarregamento('Preparando importação...');
                        
                        let promises = [];
                        let resultados = {
                            lancamentos: 0,
                            bancos: 0,
                            cartoes: 0,
                            investimentos: 0,
                            dividendos: 0,
                            categorias: 0,
                            orcamentos: 0
                        };
                        
                        // Processar cada arquivo do ZIP
                        csvFiles.forEach(function(filename, index) {
                            promises.push(
                                zip.files[filename].async('string').then(function(content) {
                                    try {
                                        atualizarMensagemCarregamento(`Processando ${filename} (${index + 1}/${csvFiles.length})...`);
                                        
                                        // Validar conteúdo antes de processar
                                        if (!content || typeof content !== 'string') {
                                            throw new Error(`Conteúdo inválido ou vazio`);
                                        }
                                        
                                        if (content.length > 10 * 1024 * 1024) { // 10MB por arquivo
                                            throw new Error(`Arquivo muito grande (máximo 10MB por arquivo CSV)`);
                                        }
                                        
                                        return processarArquivoCSV(filename, content, opcao === 'substituir', resultados);
                                    } catch (error) {
                                        console.error(`Erro ao processar ${filename}:`, error);
                                        throw new Error(`Erro no arquivo ${filename}: ${error.message}`);
                                    }
                                }).catch(function(error) {
                                    console.error(`Erro ao ler ${filename}:`, error);
                                    throw new Error(`Falha ao ler ${filename}: ${error.message}`);
                                })
                            );
                        });
                        
                        Promise.all(promises).then(function() {
                            atualizarMensagemCarregamento('Salvando dados...');
                            
                            // Salvar dados no localStorage
                            salvarDados();
                            
                            atualizarMensagemCarregamento('Atualizando interface...');
                            
                            // Forçar atualização completa da interface
                            setTimeout(() => {
                                // Atualizar interface
                                atualizarFiltros();
                                aplicarFiltros();
                                carregarCategorias();
                                carregarBancos();
                                carregarCartoes();
                                carregarInvestimentos();
                                atualizarTabelaInvestimentos();
                                atualizarTabelaDividendos();
                                
                                // Atualizar saldos e resumos
                                if (typeof atualizarResumo === 'function') {
                                    atualizarResumo();
                                }
                                if (typeof atualizarSaldos === 'function') {
                                    atualizarSaldos();
                                }
                                
                                // Recarregar dados da página inicial
                                if (typeof carregarDados === 'function') {
                                    carregarDados();
                                }
                                
                                // CRÍTICO: Salvar todos os dados no localStorage antes do reload
                                console.log('💾 Salvando dados no localStorage...');
                                salvarDados();
                                console.log('✅ Dados salvos com sucesso!');
                            }, 100);
                            
                            // Limpar o input de arquivo
                            document.getElementById('input-importar-csv').value = '';
                            
                            ocultarIndicadorCarregamento();
                            
                            // Exibir mensagem de sucesso melhorada
                            let mensagem = '✅ Backup restaurado com sucesso!\n\n📊 Resumo da importação:\n';
                            let totalRegistros = 0;
                            Object.keys(resultados).forEach(tipo => {
                                if (resultados[tipo] > 0) {
                                    mensagem += `• ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}: ${resultados[tipo]} registros\n`;
                                    totalRegistros += resultados[tipo];
                                }
                            });
                            mensagem += `\n📁 Arquivos processados: ${csvFiles.length}`;
                            mensagem += `\n📈 Total de registros: ${totalRegistros}`;
                            mensagem += `\n🔄 Modo: ${opcao ? 'Substituição' : 'Adição'}`;
                            mensagem += `\n\n🔄 A página será recarregada para atualizar todos os dados.`;
                            
                            alert(mensagem);
                            
                            // Reinicializar a interface sem reload da página
                            setTimeout(() => {
                                console.log('🔄 Reinicializando interface após restore...');
                                
                                // Verificar se bancos e investimentos precisam ser reinicializados
                                if (bancos.length === 0) {
                                    console.log('🏦 Nenhum banco importado, inicializando bancos de exemplo...');
                                    inicializarBancosExemplo();
                                }
                                
                                // Recarregar dados salvos
                                carregarDadosSalvos();
                                
                                // Atualizar todas as interfaces
                                atualizarInterfaceUsuarioLogado();
                                aplicarFiltros();
                                carregarCategorias();
                                carregarBancos();
                                carregarCartoes();
                                carregarInvestimentos();
                                atualizarTabelaInvestimentos();
                                atualizarTabelaDividendos();
                                
                                // Atualizar saldos e resumos
                                if (typeof atualizarResumo === 'function') {
                                    atualizarResumo();
                                }
                                if (typeof atualizarSaldos === 'function') {
                                    atualizarSaldos();
                                }
                                
                                // Garantir que as abas estejam funcionando
                                const tabElements = document.querySelectorAll('[data-bs-toggle="tab"]');
                                tabElements.forEach(tab => {
                                    if (!tab.hasAttribute('data-bs-initialized')) {
                                        new bootstrap.Tab(tab);
                                        tab.setAttribute('data-bs-initialized', 'true');
                                    }
                                });
                                
                                console.log('✅ Interface reinicializada com sucesso!');
                            }, 500);
                        }).catch(function(error) {
                            ocultarIndicadorCarregamento();
                            console.error('Erro no processamento:', error);
                            alert(`❌ Erro durante a restauração!\n\n${error.message}\n\nAlguns dados podem ter sido importados parcialmente.\nVerifique os dados e tente novamente se necessário.`);
                            document.getElementById('input-importar-csv').value = '';
                        });
                    }).catch(function(error) {
                        ocultarIndicadorCarregamento();
                        console.error('Erro ao ler ZIP:', error);
                        alert(`❌ Erro ao ler o arquivo ZIP!\n\nPossíveis causas:\n• Arquivo corrompido\n• Formato inválido\n• Arquivo muito grande\n\nDetalhes: ${error.message}`);
                        document.getElementById('input-importar-csv').value = '';
                    });
                } catch (error) {
                    ocultarIndicadorCarregamento();
                    console.error('Erro geral:', error);
                    alert(`❌ Erro inesperado!\n\n${error.message}\n\nTente novamente ou contate o suporte.`);
                    document.getElementById('input-importar-csv').value = '';
                }
            };
            
            reader.onerror = function() {
                ocultarIndicadorCarregamento();
                alert('❌ Erro ao ler o arquivo!\n\nVerifique se:\n• O arquivo não está corrompido\n• Você tem permissão para acessá-lo\n• Há espaço suficiente em disco');
                document.getElementById('input-importar-csv').value = '';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processarArquivoCSV(filename, content, substituir, resultados) {
            try {
                console.log(`=== Processando arquivo: ${filename} ===`);
                console.log(`Parâmetro substituir: ${substituir} (tipo: ${typeof substituir})`);
                console.log(`Tamanho do conteúdo: ${content ? content.length : 'null'} caracteres`);
                
                if (!content || typeof content !== 'string') {
                    throw new Error(`Conteúdo inválido no arquivo ${filename}`);
                }
                
                // Validar tamanho do conteúdo
                if (content.length > 50 * 1024 * 1024) { // 50MB por arquivo CSV
                    throw new Error(`Arquivo ${filename} muito grande (máximo 50MB)`);
                }
                
                const lines = content.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    console.warn(`Arquivo ${filename} vazio ou só com cabeçalho`);
                    return; // Arquivo vazio ou só cabeçalho
                }
                
                // Validar número de linhas
                if (lines.length > 50000) {
                    throw new Error(`Arquivo ${filename} com muitas linhas (máximo 50.000)`);
                }
                
                const header = parsearLinhaCSV(lines[0]);
                
                if (!header || header.length === 0) {
                    throw new Error(`Cabeçalho inválido no arquivo ${filename}`);
                }
                
                // Validar número de colunas
                if (header.length > 50) {
                    throw new Error(`Arquivo ${filename} com muitas colunas (máximo 50)`);
                }
            
                switch (filename) {
                    case 'lancamentos.csv':
                        console.log(`Processando ${filename}: ${lines.length} linhas, substituir: ${substituir}`);
                        if (substituir) {
                            lancamentos = [];
                            nextId = 1;
                            console.log('Lançamentos limpos para substituição');
                        }
                        const lancamentosImportados = processarLancamentos(lines, header);
                        resultados.lancamentos += lancamentosImportados;
                        console.log(`${lancamentosImportados} lançamentos importados. Total atual: ${lancamentos.length}`);
                        break;
                        
                    case 'bancos.csv':
                        console.log(`Processando ${filename}: ${lines.length} linhas, substituir: ${substituir}`);
                        if (substituir) {
                            bancos = [];
                            console.log('Bancos limpos para substituição');
                        }
                        const bancosImportados = processarBancos(lines, header);
                        resultados.bancos += bancosImportados;
                        console.log(`${bancosImportados} bancos importados. Total atual: ${bancos.length}`);
                        break;
                        
                    case 'cartoes.csv':
                        console.log(`Processando ${filename}: ${lines.length} linhas, substituir: ${substituir}`);
                        if (substituir) {
                            cartoes = [];
                            console.log('Cartões limpos para substituição');
                        }
                        const cartoesImportados = processarCartoes(lines, header);
                        resultados.cartoes += cartoesImportados;
                        console.log(`${cartoesImportados} cartões importados. Total atual: ${cartoes.length}`);
                        break;
                        
                    case 'investimentos.csv':
                        console.log(`Processando ${filename}: ${lines.length} linhas, substituir: ${substituir}`);
                        if (substituir) {
                            investimentos = [];
                            console.log('Investimentos limpos para substituição');
                        }
                        const investimentosImportados = processarInvestimentos(lines, header);
                        resultados.investimentos += investimentosImportados;
                        console.log(`${investimentosImportados} investimentos importados. Total atual: ${investimentos.length}`);
                        break;
                        
                    case 'dividendos.csv':
                        console.log(`Processando ${filename}: ${lines.length} linhas, substituir: ${substituir}`);
                        if (substituir) {
                            dividendos = [];
                            console.log('Dividendos limpos para substituição');
                        }
                        const dividendosImportados = processarDividendos(lines, header);
                        resultados.dividendos += dividendosImportados;
                        console.log(`${dividendosImportados} dividendos importados. Total atual: ${dividendos.length}`);
                        break;
                        
                    case 'categorias.csv':
                        console.log(`Processando ${filename}: ${lines.length} linhas, substituir: ${substituir}`);
                        if (substituir) {
                            categorias = [];
                            console.log('Categorias limpas para substituição');
                        }
                        const categoriasImportadas = processarCategorias(lines, header);
                        resultados.categorias += categoriasImportadas;
                        console.log(`${categoriasImportadas} categorias importadas. Total atual: ${categorias.length}`);
                        break;
                        
                    case 'orcamentos.csv':
                        if (substituir) orcamentos = [];
                        resultados.orcamentos += processarOrcamentos(lines, header);
                        break;
                        
                    default:
                        console.warn(`Arquivo não reconhecido: ${filename}`);
                        break;
                }
            } catch (error) {
                console.error(`Erro ao processar arquivo ${filename}:`, error);
                throw new Error(`Falha ao processar ${filename}: ${error.message}`);
            }
        }
        
        function processarLancamentos(lines, header) {
            let importados = 0;
            console.log(`Iniciando processamento de lançamentos: ${lines.length} linhas`);
            console.log(`Cabeçalho: ${header.join(', ')}`);
            
            // Verificar se os campos obrigatórios existem no cabeçalho
            const camposObrigatorios = ['Data', 'Descrição', 'Categoria', 'Tipo', 'Valor'];
            const camposFaltando = camposObrigatorios.filter(campo => header.indexOf(campo) === -1);
            
            if (camposFaltando.length > 0) {
                throw new Error(`Campos obrigatórios faltando no arquivo de lançamentos: ${camposFaltando.join(', ')}`);
            }
            
            for (let i = 1; i < lines.length && i < 10000; i++) { // Limitar a 10k linhas por segurança
                try {
                    const campos = parsearLinhaCSV(lines[i]);
                    if (!campos || campos.length === 0) continue; // Linha vazia ou inválida
                    
                    // Verificar se há campos suficientes
                    const dataIdx = header.indexOf('Data');
                    const descricaoIdx = header.indexOf('Descrição');
                    const categoriaIdx = header.indexOf('Categoria');
                    const tipoIdx = header.indexOf('Tipo');
                    const valorIdx = header.indexOf('Valor');
                    
                    // Validar índices antes de usar
                    if (dataIdx === -1 || descricaoIdx === -1 || categoriaIdx === -1 || 
                        tipoIdx === -1 || valorIdx === -1) {
                        console.warn(`Campos obrigatórios não encontrados no cabeçalho`);
                        continue;
                    }
                    
                    if (dataIdx >= campos.length || descricaoIdx >= campos.length || 
                        categoriaIdx >= campos.length || tipoIdx >= campos.length || 
                        valorIdx >= campos.length) {
                        console.warn(`Linha ${i + 1} com campos insuficientes, pulando...`);
                        continue;
                    }
                    
                    // Processar e validar data
                    let dataProcessada = (campos[dataIdx] || '').replace(/"/g, '').trim();
                    if (dataProcessada) {
                        try {
                            // Verificar formato DD/MM/YYYY (brasileiro)
                            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dataProcessada)) {
                                const [dia, mes, ano] = dataProcessada.split('/');
                                const dataObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                                if (!isNaN(dataObj.getTime()) && 
                                    dataObj.getDate() == parseInt(dia) && 
                                    dataObj.getMonth() == parseInt(mes) - 1 && 
                                    dataObj.getFullYear() == parseInt(ano)) {
                                    dataProcessada = dataObj.toISOString().split('T')[0]; // YYYY-MM-DD
                                } else {
                                    throw new Error('Data DD/MM/YYYY inválida');
                                }
                            }
                            // Verificar formato DD-MM-YYYY
                            else if (/^\d{2}-\d{2}-\d{4}$/.test(dataProcessada)) {
                                const [dia, mes, ano] = dataProcessada.split('-');
                                const dataObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                                if (!isNaN(dataObj.getTime()) && 
                                    dataObj.getDate() == parseInt(dia) && 
                                    dataObj.getMonth() == parseInt(mes) - 1 && 
                                    dataObj.getFullYear() == parseInt(ano)) {
                                    dataProcessada = dataObj.toISOString().split('T')[0]; // YYYY-MM-DD
                                } else {
                                    throw new Error('Data DD-MM-YYYY inválida');
                                }
                            }
                            // Verificar formato YYYY-MM-DD (ISO)
                            else if (/^\d{4}-\d{2}-\d{2}$/.test(dataProcessada)) {
                                const dataObj = new Date(dataProcessada + 'T00:00:00');
                                if (isNaN(dataObj.getTime())) {
                                    throw new Error('Data YYYY-MM-DD inválida');
                                }
                                // Já está no formato correto
                            }
                            // Tentar outros formatos
                            else {
                                const dataObj = new Date(dataProcessada);
                                if (!isNaN(dataObj.getTime())) {
                                    dataProcessada = dataObj.toISOString().split('T')[0]; // YYYY-MM-DD
                                } else {
                                    throw new Error('Formato de data não reconhecido');
                                }
                            }
                        } catch (error) {
                            console.warn(`Data inválida na linha ${i + 1}: "${dataProcessada}" - ${error.message}, usando data atual`);
                            dataProcessada = new Date().toISOString().split('T')[0];
                        }
                    } else {
                        // Se não há data, usar data atual
                        console.warn(`Data vazia na linha ${i + 1}, usando data atual`);
                        dataProcessada = new Date().toISOString().split('T')[0];
                    }

                    const lancamento = {
                        id: nextId++,
                        data: dataProcessada,
                        descricao: (campos[descricaoIdx] || '').replace(/"/g, '').trim(),
                        categoria: (campos[categoriaIdx] || '').replace(/"/g, '').trim(),
                        tipo: (campos[tipoIdx] || '').replace(/"/g, '').trim(),
                        valor: parseFloat((campos[valorIdx] || '0').replace(/"/g, '').replace(',', '.'))
                    };
                    
                    // Campos opcionais
                    const bancoIdx = header.indexOf('Banco');
                    const contaIdx = header.indexOf('Conta');
                    const cartaoIdx = header.indexOf('Cartão');
                    const tipoTransacaoIdx = header.indexOf('Tipo Transação');
                    const contaDestinoIdx = header.indexOf('Conta Destino');
                    const statusIdx = header.indexOf('Status');
                    
                    if (bancoIdx >= 0) lancamento.banco = campos[bancoIdx].replace(/"/g, '');
                    if (contaIdx >= 0) lancamento.conta = campos[contaIdx].replace(/"/g, '');
                    if (cartaoIdx >= 0) lancamento.cartao = campos[cartaoIdx].replace(/"/g, '');
                    if (tipoTransacaoIdx >= 0) lancamento.tipoTransacao = campos[tipoTransacaoIdx].replace(/"/g, '');
                    if (contaDestinoIdx >= 0) lancamento.contaDestino = campos[contaDestinoIdx].replace(/"/g, '');
                    if (statusIdx >= 0) lancamento.status = campos[statusIdx].replace(/"/g, '');
                    
                    if (!isNaN(lancamento.valor) && lancamento.valor !== 0) {
                        lancamentos.push(lancamento);
                        importados++;
                        
                        // Adicionar categoria se não existir
                        if (lancamento.categoria && !categorias.includes(lancamento.categoria)) {
                            categorias.push(lancamento.categoria);
                        }
                    } else {
                        console.warn(`Lançamento rejeitado - valor inválido: ${lancamento.valor}, linha ${i + 1}`);
                    }
                } catch (error) {
                    console.warn('Erro ao processar lançamento:', error);
                }
            }
            
            console.log(`Processamento de lançamentos concluído: ${importados} importados de ${lines.length - 1} linhas`);
            return importados;
        }
        
        function processarBancos(lines, header) {
            let importados = 0;
            console.log(`🏦 processarBancos: Iniciando processamento de ${lines.length} linhas`);
            console.log(`🏦 processarBancos: Cabeçalho: ${header.join(', ')}`);
            
            for (let i = 1; i < lines.length && i < 1000; i++) { // Limitar a 1k bancos
                try {
                    const campos = parsearLinhaCSV(lines[i]);
                    if (!campos || campos.length < header.length) {
                        console.warn(`🏦 processarBancos: Linha ${i + 1} com campos insuficientes`);
                        continue;
                    }
                    
                    const idIdx = header.indexOf('ID');
                    const nomeIdx = header.indexOf('Nome');
                    const contasIdx = header.indexOf('Contas');
                    
                    if (idIdx === -1 || nomeIdx === -1) {
                        console.warn(`🏦 processarBancos: Campos obrigatórios não encontrados no cabeçalho`);
                        continue;
                    }
                    
                    const banco = {
                        id: campos[idIdx] ? campos[idIdx].replace(/"/g, '').trim() : '',
                        nome: campos[nomeIdx] ? campos[nomeIdx].replace(/"/g, '').trim() : '',
                        contas: contasIdx >= 0 && campos[contasIdx] ? 
                               JSON.parse(campos[contasIdx].replace(/"/g, '') || '[]') : []
                    };
                    
                    console.log(`🏦 processarBancos: Processando banco - ID: ${banco.id}, Nome: ${banco.nome}`);
                    
                    if (banco.id && banco.nome) {
                        bancos.push(banco);
                        importados++;
                        console.log(`✅ processarBancos: Banco ${banco.nome} importado com sucesso`);
                    } else {
                        console.warn(`⚠️ processarBancos: Banco rejeitado - ID: ${banco.id}, Nome: ${banco.nome}`);
                    }
                } catch (error) {
                    console.warn(`❌ processarBancos: Erro ao processar linha ${i + 1}:`, error);
                }
            }
            
            console.log(`🏦 processarBancos: Concluído - ${importados} bancos importados`);
            return importados;
        }
        
        function processarCartoes(lines, header) {
            let importados = 0;
            
            for (let i = 1; i < lines.length && i < 1000; i++) { // Limitar a 1k cartões
                try {
                    const campos = parsearLinhaCSV(lines[i]);
                    if (!campos || campos.length < header.length) continue;
                    
                    const cartao = {
                        id: parseInt(campos[header.indexOf('ID')].replace(/"/g, '')),
                        nome: campos[header.indexOf('Nome')].replace(/"/g, ''),
                        limite: parseFloat(campos[header.indexOf('Limite')].replace(/"/g, '').replace(',', '.')),
                        limiteDisponivel: parseFloat(campos[header.indexOf('Limite Disponível')].replace(/"/g, '').replace(',', '.'))
                    };
                    
                    if (cartao.id && cartao.nome) {
                        cartoes.push(cartao);
                        importados++;
                    }
                } catch (error) {
                    console.warn('Erro ao processar cartão:', error);
                }
            }
            
            return importados;
        }
        
        function processarInvestimentos(lines, header) {
            let importados = 0;
            
            for (let i = 1; i < lines.length && i < 5000; i++) { // Limitar a 5k investimentos
                try {
                    const campos = parsearLinhaCSV(lines[i]);
                    if (!campos || campos.length < header.length) continue;
                    
                    const investimento = {
                        id: parseInt(campos[header.indexOf('ID')].replace(/"/g, '')),
                        ativo: campos[header.indexOf('Ativo')].replace(/"/g, ''),
                        quantidade: parseFloat(campos[header.indexOf('Quantidade')].replace(/"/g, '').replace(',', '.')),
                        precoMedio: parseFloat(campos[header.indexOf('Preço Médio')].replace(/"/g, '').replace(',', '.')),
                        corretora: campos[header.indexOf('Corretora')].replace(/"/g, ''),
                        tipo: campos[header.indexOf('Tipo')].replace(/"/g, ''),
                        data: campos[header.indexOf('Data')].replace(/"/g, '')
                    };
                    
                    if (investimento.id && investimento.ativo) {
                        investimentos.push(investimento);
                        importados++;
                    }
                } catch (error) {
                    console.warn('Erro ao processar investimento:', error);
                }
            }
            
            return importados;
        }
        
        function processarDividendos(lines, header) {
            let importados = 0;
            
            for (let i = 1; i < lines.length && i < 5000; i++) { // Limitar a 5k dividendos
                try {
                    const campos = parsearLinhaCSV(lines[i]);
                    if (!campos || campos.length < header.length) continue;
                    
                    const dividendo = {
                        id: parseInt(campos[header.indexOf('ID')].replace(/"/g, '')),
                        ativo: campos[header.indexOf('Ativo')].replace(/"/g, ''),
                        valor: parseFloat(campos[header.indexOf('Valor')].replace(/"/g, '').replace(',', '.')),
                        data: campos[header.indexOf('Data')].replace(/"/g, ''),
                        tipo: campos[header.indexOf('Tipo')].replace(/"/g, '')
                    };
                    
                    if (dividendo.id && dividendo.ativo) {
                        dividendos.push(dividendo);
                        importados++;
                    }
                } catch (error) {
                    console.warn('Erro ao processar dividendo:', error);
                }
            }
            
            return importados;
        }
        
        function processarCategorias(lines, header) {
            let importados = 0;
            console.log(`📂 processarCategorias: Iniciando processamento de ${lines.length} linhas`);
            console.log(`📂 processarCategorias: Cabeçalho: ${header.join(', ')}`);
            console.log(`📂 processarCategorias: Categorias atuais: ${categorias.length}`);
            
            for (let i = 1; i < lines.length && i < 1000; i++) { // Limitar a 1k categorias
                try {
                    const campos = parsearLinhaCSV(lines[i]);
                    if (!campos || campos.length < 1) {
                        console.warn(`📂 processarCategorias: Linha ${i + 1} vazia ou inválida`);
                        continue;
                    }
                    
                    const categoria = campos[0].replace(/"/g, '').trim();
                    console.log(`📂 processarCategorias: Processando categoria: "${categoria}"`);
                    
                    if (categoria && !categorias.includes(categoria)) {
                        categorias.push(categoria);
                        importados++;
                        console.log(`✅ processarCategorias: Categoria "${categoria}" importada`);
                    } else if (categoria && categorias.includes(categoria)) {
                        console.log(`⚠️ processarCategorias: Categoria "${categoria}" já existe`);
                    } else {
                        console.warn(`⚠️ processarCategorias: Categoria vazia ou inválida na linha ${i + 1}`);
                    }
                } catch (error) {
                    console.warn(`❌ processarCategorias: Erro ao processar linha ${i + 1}:`, error);
                }
            }
            
            console.log(`📂 processarCategorias: Concluído - ${importados} categorias importadas. Total: ${categorias.length}`);
            return importados;
        }
        
        function processarOrcamentos(lines, header) {
            let importados = 0;
            
            for (let i = 1; i < lines.length && i < 1000; i++) { // Limitar a 1k orçamentos
                try {
                    const campos = parsearLinhaCSV(lines[i]);
                    if (!campos || campos.length < header.length) continue;
                    
                    const orcamento = {
                        id: parseInt(campos[header.indexOf('ID')].replace(/"/g, '')),
                        categoria: campos[header.indexOf('Categoria')].replace(/"/g, ''),
                        valor: parseFloat(campos[header.indexOf('Valor')].replace(/"/g, '').replace(',', '.')),
                        mes: campos[header.indexOf('Mês')].replace(/"/g, ''),
                        ano: parseInt(campos[header.indexOf('Ano')].replace(/"/g, ''))
                    };
                    
                    if (orcamento.id && orcamento.categoria) {
                        orcamentos.push(orcamento);
                        importados++;
                    }
                } catch (error) {
                    console.warn('Erro ao processar orçamento:', error);
                }
            }
            
            return importados;
        }
        
        function parsearLinhaCSV(linha) {
            if (!linha || typeof linha !== 'string') {
                return [];
            }
            
            linha = linha.trim();
            if (linha === '') {
                return [];
            }
            
            let campos = [];
            let campo = '';
            let dentroDeAspas = false;
            
            try {
                for (let i = 0; i < linha.length; i++) {
                    const char = linha[i];
                    
                    if (char === '"') {
                        dentroDeAspas = !dentroDeAspas;
                    } else if (char === ',' && !dentroDeAspas) {
                        campos.push(campo.trim());
                        campo = '';
                    } else {
                        campo += char;
                    }
                }
                
                // Adicionar o último campo
                campos.push(campo.trim());
                
                // Validar se o array não está muito grande (proteção contra dados corrompidos)
                if (campos.length > 50) {
                    console.warn('Linha CSV com muitos campos, possível corrupção:', linha.substring(0, 100));
                    return [];
                }
                
                return campos;
            } catch (error) {
                console.error('Erro ao parsear linha CSV:', error, linha.substring(0, 100));
                return [];
            }
        }
        
        function importarCSVLegado(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    atualizarMensagemCarregamento('Processando arquivo CSV...');
                    
                    const csvData = e.target.result;
                    const lines = csvData.split('\n');
                    
                    if (lines.length < 2) {
                        throw new Error('O arquivo CSV está vazio ou mal formatado.');
                    }
                    
                    const header = lines[0].split(',');
                    const expectedHeaders = ['Data', 'Descrição', 'Categoria', 'Tipo', 'Valor'];
                    
                    const headersValid = expectedHeaders.every(expectedHeader => {
                        return header.some(h => {
                            const cleanHeader = h.replace(/["\s]/g, '');
                            return cleanHeader.toLowerCase() === expectedHeader.toLowerCase();
                        });
                    });
                    
                    if (!headersValid) {
                        throw new Error('O formato do cabeçalho do CSV não é compatível.');
                    }
                    
                    const opcao = confirm('Deseja substituir os dados existentes? Clique em OK para substituir ou Cancelar para adicionar aos dados existentes.');
                    
                    if (opcao) {
                        lancamentos = [];
                        nextId = 1;
                    }
                    
                    let lancamentosImportados = 0;
                    let lancamentosInvalidos = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const campos = parsearLinhaCSV(lines[i]);
                        
                        if (campos.length < 5) {
                            lancamentosInvalidos++;
                            continue;
                        }
                        
                        let dataStr = campos[0].replace(/"/g, '');
                        const descricao = campos[1].replace(/"/g, '');
                        const categoria = campos[2].replace(/"/g, '');
                        const tipo = campos[3].replace(/"/g, '').toLowerCase();
                        const valorStr = campos[4].replace(/"/g, '').replace(',', '.');
                        
                        if (tipo !== 'entrada' && tipo !== 'saida') {
                            lancamentosInvalidos++;
                            continue;
                        }
                        
                        const valor = parseFloat(valorStr);
                        if (isNaN(valor) || valor <= 0) {
                            lancamentosInvalidos++;
                            continue;
                        }
                        
                        let data;
                        try {
                            if (dataStr.includes('/')) {
                                const partes = dataStr.split('/');
                                if (partes.length === 3) {
                                    const dia = parseInt(partes[0]);
                                    const mes = parseInt(partes[1]) - 1;
                                    const ano = parseInt(partes[2]);
                                    data = new Date(ano, mes, dia).toISOString().split('T')[0];
                                }
                            } else {
                                data = new Date(dataStr).toISOString().split('T')[0];
                            }
                            
                            if (!data || data === 'Invalid Date') {
                                throw new Error('Data inválida');
                            }
                        } catch (error) {
                            lancamentosInvalidos++;
                            continue;
                        }
                        
                        if (!categorias.includes(categoria)) {
                            categorias.push(categoria);
                        }
                        
                        const novoLancamento = {
                            id: nextId++,
                            data,
                            descricao,
                            categoria,
                            tipo,
                            valor
                        };
                        
                        lancamentos.push(novoLancamento);
                        lancamentosImportados++;
                    }
                    
                    atualizarMensagemCarregamento('Salvando dados...');
                    
                    salvarDados();
                    atualizarFiltros();
                    aplicarFiltros();
                    carregarCategorias();
                    
                    document.getElementById('input-importar-csv').value = '';
                    
                    ocultarIndicadorCarregamento();
                    
                    alert(`✅ Importação CSV concluída!\n\n📊 Resumo:\n• Lançamentos importados: ${lancamentosImportados}\n• Lançamentos ignorados: ${lancamentosInvalidos}\n• Arquivo: ${file.name}`);
                    
                } catch (error) {
                    ocultarIndicadorCarregamento();
                    alert(`❌ Erro ao importar CSV!\n\nArquivo: ${file.name}\nErro: ${error.message}\n\nVerifique o formato do arquivo.`);
                    document.getElementById('input-importar-csv').value = '';
                }
            };
            
            reader.onerror = function() {
                ocultarIndicadorCarregamento();
                alert('❌ Erro ao ler o arquivo!\n\nVerifique se o arquivo não está corrompido.');
                document.getElementById('input-importar-csv').value = '';
            };
            
            reader.readAsText(file);
        }

        // Funções para relatórios avançados
        function inicializarRelatorios() {
            // Inicializar datepickers
            const dataInicioInput = document.getElementById('data-inicio-relatorio');
            const dataFimInput = document.getElementById('data-fim-relatorio');
            
            // Definir data inicial como primeiro dia do mês atual
            const hoje = new Date();
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            dataInicioInput.value = primeiroDiaMes.toISOString().split('T')[0];
            
            // Definir data final como hoje
            dataFimInput.value = hoje.toISOString().split('T')[0];
            
            // Inicializar o gráfico de relatório vazio
            inicializarGraficoRelatorio();
        }
        

        
        function inicializarGraficoRelatorio() {
            const ctx = document.getElementById('relatorioChart').getContext('2d');
            window.relatorioChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'R$ ' + context.raw.toFixed(2);
                                }
                            }
                        },
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Relatório Financeiro'
                        }
                    }
                }
            });
        }
        
        function gerarRelatorio() {
            // Verificar se há atualizações pendentes do fluxo de caixa
            verificarAtualizacaoFluxoCaixa();
            
            const tipoRelatorio = document.getElementById('tipo-relatorio').value;
            const dataInicio = document.getElementById('data-inicio-relatorio').value;
            const dataFim = document.getElementById('data-fim-relatorio').value;
            const filtroStatus = document.getElementById('filtro-status').value;
            const bancoRelatorio = document.getElementById('banco-relatorio').value;
            const compararStatus = document.getElementById('comparar-status').checked;
            
            // Validar datas
            if (!dataInicio || !dataFim) {
                alert('Por favor, selecione as datas de início e fim.');
                return;
            }
            
            if (new Date(dataInicio) > new Date(dataFim)) {
                alert('A data de início não pode ser posterior à data de fim.');
                return;
            }
            
            // Filtrar lançamentos pelo período selecionado
            let lancamentosFiltrados = lancamentos.filter(lancamento => {
                const dataLancamento = lancamento.data;
                return dataLancamento >= dataInicio && dataLancamento <= dataFim;
            });
            
            // Aplicar filtro de status se não for "todos"
            if (filtroStatus !== 'todos') {
                lancamentosFiltrados = lancamentosFiltrados.filter(lancamento => {
                    const status = lancamento.status || 'realizado';
                    return status === filtroStatus;
                });
            }
            
            // Aplicar filtro por banco se selecionado
            if (bancoRelatorio) {
                lancamentosFiltrados = lancamentosFiltrados.filter(lancamento => {
                    return lancamento.banco === bancoRelatorio;
                });
            }
            
            if (lancamentosFiltrados.length === 0) {
                alert('Não há lançamentos no período selecionado.');
                return;
            }
            
            // Se comparação está ativa, gerar relatório comparativo
            if (compararStatus) {
                gerarRelatorioComparativo(lancamentosFiltrados, tipoRelatorio, dataInicio, dataFim);
            } else {
                // Gerar relatório de acordo com o tipo selecionado
                switch(tipoRelatorio) {
                    case 'fluxo-caixa':
                        gerarRelatorioFluxoCaixa(lancamentosFiltrados, dataInicio, dataFim);
                        break;
                        
                    case 'categoria':
                        gerarRelatorioCategoria(lancamentosFiltrados, dataInicio, dataFim);
                        break;
                        
                    case 'tendencia':
                        gerarRelatorioTendencia(lancamentosFiltrados, dataInicio, dataFim);
                        break;
                        
                    case 'investimentos':
                        gerarRelatorioInvestimentos(dataInicio, dataFim);
                        break;
                        
                    default:
                        alert('Selecione um tipo de relatório válido.');
                        break;
                }
            }
            
            // Atualizar estatísticas
            atualizarEstatisticasRelatorio(lancamentosFiltrados);
        }
        
        function gerarRelatorioComparativo(lancamentos, tipoRelatorio, dataInicio, dataFim) {
            // Ocultar tabela do fluxo de caixa
            document.getElementById('fluxo-caixa-tabela').style.display = 'none';
            
            // Separar lançamentos por status
            const lancamentosRealizados = lancamentos.filter(l => (l.status || 'realizado') === 'realizado');
            const lancamentosPrevistos = lancamentos.filter(l => l.status === 'previsto');
            
            // Calcular totais por status
            const totaisRealizados = calcularTotaisPorStatus(lancamentosRealizados);
            const totaisPrevistos = calcularTotaisPorStatus(lancamentosPrevistos);
            
            // Preparar dados para o gráfico comparativo
            const labels = ['Entradas', 'Saídas', 'Saldo'];
            const dadosRealizados = [
                totaisRealizados.entradas,
                totaisRealizados.saidas,
                totaisRealizados.entradas - totaisRealizados.saidas
            ];
            const dadosPrevistos = [
                totaisPrevistos.entradas,
                totaisPrevistos.saidas,
                totaisPrevistos.entradas - totaisPrevistos.saidas
            ];
            
            // Atualizar gráfico comparativo
            atualizarGrafico('bar', 'Comparação: Previsto vs Realizado', labels, [
                {
                    label: 'Realizado',
                    data: dadosRealizados,
                    backgroundColor: 'rgba(40, 167, 69, 0.6)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Previsto',
                    data: dadosPrevistos,
                    backgroundColor: 'rgba(255, 193, 7, 0.6)',
                    borderColor: 'rgba(255, 193, 7, 1)',
                    borderWidth: 1
                }
            ]);
            
            // Atualizar estatísticas comparativas
            atualizarEstatisticasComparativas(totaisRealizados, totaisPrevistos);
        }
        
        function calcularTotaisPorStatus(lancamentos) {
            return lancamentos.reduce((totais, lancamento) => {
                if (lancamento.tipo === 'entrada') {
                    totais.entradas += lancamento.valor;
                } else {
                    totais.saidas += lancamento.valor;
                }
                return totais;
            }, { entradas: 0, saidas: 0 });
        }
        
        function atualizarEstatisticasComparativas(totaisRealizados, totaisPrevistos) {
            // Atualizar estatísticas com dados comparativos
            document.getElementById('estatistica-total-entradas').textContent = 
                `Realizado: R$ ${totaisRealizados.entradas.toFixed(2).replace('.', ',')} | Previsto: R$ ${totaisPrevistos.entradas.toFixed(2).replace('.', ',')}`;
            
            document.getElementById('estatistica-total-saidas').textContent = 
                `Realizado: R$ ${totaisRealizados.saidas.toFixed(2).replace('.', ',')} | Previsto: R$ ${totaisPrevistos.saidas.toFixed(2).replace('.', ',')}`;
            
            const saldoRealizado = totaisRealizados.entradas - totaisRealizados.saidas;
            const saldoPrevisto = totaisPrevistos.entradas - totaisPrevistos.saidas;
            
            document.getElementById('estatistica-saldo').textContent = 
                `Realizado: R$ ${saldoRealizado.toFixed(2).replace('.', ',')} | Previsto: R$ ${saldoPrevisto.toFixed(2).replace('.', ',')}`;
            
            // Calcular diferenças
            const diferencaEntradas = totaisPrevistos.entradas - totaisRealizados.entradas;
            const diferencaSaidas = totaisPrevistos.saidas - totaisRealizados.saidas;
            const diferencaSaldo = saldoPrevisto - saldoRealizado;
            
            document.getElementById('estatistica-maior-entrada').textContent = 
                `Diferença: R$ ${diferencaEntradas.toFixed(2).replace('.', ',')}`;
            
            document.getElementById('estatistica-maior-saida').textContent = 
                `Diferença: R$ ${diferencaSaidas.toFixed(2).replace('.', ',')}`;
            
            document.getElementById('estatistica-categoria-mais-gastos').textContent = 
                `Diferença no Saldo: R$ ${diferencaSaldo.toFixed(2).replace('.', ',')}`;
        }
        
        // Flag para indicar se o fluxo de caixa precisa ser atualizado
        let fluxoCaixaPrecisaAtualizar = false;
        
        // Função para carregar/atualizar o fluxo de caixa automaticamente
        function carregarFluxoCaixa() {
            try {
                // Verificar se o elemento da tabela de fluxo de caixa existe na página
                const tabelaFluxoCaixa = document.getElementById('fluxo-caixa-tabela');
                
                // Se a tabela existe e está visível, significa que o fluxo de caixa foi gerado
                if (tabelaFluxoCaixa && tabelaFluxoCaixa.style.display !== 'none') {
                    // Gerar dados do fluxo de caixa
                    const dadosFluxoCaixa = gerarDadosFluxoCaixa();
                    
                    if (dadosFluxoCaixa) {
                        // Exibir tabela atualizada
                        exibirTabelaFluxoCaixa(dadosFluxoCaixa);
                        console.log('Fluxo de caixa atualizado automaticamente');
                        fluxoCaixaPrecisaAtualizar = false;
                    }
                } else {
                    // Se a tabela não está visível, marcar para atualizar quando for exibida
                    fluxoCaixaPrecisaAtualizar = true;
                    console.log('Fluxo de caixa marcado para atualização quando for exibido');
                }
            } catch (error) {
                console.log('Erro ao atualizar fluxo de caixa:', error);
            }
        }
        
        // Função para verificar e atualizar o fluxo de caixa quando necessário
        function verificarAtualizacaoFluxoCaixa() {
            if (fluxoCaixaPrecisaAtualizar) {
                carregarFluxoCaixa();
            }
        }
        
        // Função para recarregar o fluxo de caixa na página inicial
        function recarregarFluxoCaixaInicial() {
            try {
                // Forçar recarregamento dos dados do localStorage
                if (!usuarioAtual) {
                    alert('Usuário não autenticado.');
                    return;
                }
                
                const userPrefix = `financas_${usuarioAtual.email}_`;
                
                // Recarregar lançamentos do localStorage
                const lancamentosSalvos = localStorage.getItem(`${userPrefix}Lancamentos`);
                if (lancamentosSalvos) {
                    lancamentos = JSON.parse(lancamentosSalvos);
                } else {
                    lancamentos = [];
                }
                
                // Recarregar saldo inicial do localStorage
                const saldoInicialSalvo = localStorage.getItem(`${userPrefix}SaldoInicial`);
                if (saldoInicialSalvo) {
                    saldoInicial = parseFloat(saldoInicialSalvo);
                } else {
                    saldoInicial = 0;
                }
                
                // Atualizar a tabela de lançamentos
                carregarLancamentos();
                
                // Mostrar mensagem de sucesso
                const toast = document.createElement('div');
                toast.className = 'toast align-items-center text-white bg-success border-0';
                toast.style.position = 'fixed';
                toast.style.top = '20px';
                toast.style.right = '20px';
                toast.style.zIndex = '9999';
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-check-circle me-2"></i>
                            Fluxo de caixa atualizado com sucesso!
                        </div>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                // Remover o toast após 3 segundos
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
                
                console.log('Fluxo de caixa recarregado na página inicial - dados atualizados do localStorage');
            } catch (error) {
                console.error('Erro ao recarregar fluxo de caixa:', error);
                alert('Erro ao recarregar o fluxo de caixa.');
            }
        }
        
        function gerarRelatorioFluxoCaixa(lancamentos, dataInicio, dataFim) {
            // Gerar dados do fluxo de caixa usando a função dedicada
            const dadosFluxoCaixa = gerarDadosFluxoCaixa();
            
            if (!dadosFluxoCaixa) {
                return; // Erro já foi mostrado na função gerarDadosFluxoCaixa
            }
            
            // Preparar dados para o gráfico
            const labels = dadosFluxoCaixa.periodos;
            const entradasData = [];
            const saidasData = [];
            const saldoData = [];
            
            labels.forEach(periodo => {
                const dados = dadosFluxoCaixa.dados[periodo];
                entradasData.push(dados.entradas);
                saidasData.push(dados.saidas);
                saldoData.push(dados.saldoFinal);
            });
            
            // Atualizar gráfico
            atualizarGrafico('bar', 'Fluxo de Caixa', labels, [
                {
                    label: 'Entradas',
                    data: entradasData,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Saídas',
                    data: saidasData,
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Saldo',
                    data: saldoData,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    type: 'line',
                    fill: false,
                    yAxisID: 'y1',
                    order: 0
                }
            ]);
            
            // Exibir tabela detalhada
            exibirTabelaFluxoCaixa(dadosFluxoCaixa);
            
            // Marcar que o fluxo de caixa não precisa mais ser atualizado
            fluxoCaixaPrecisaAtualizar = false;
        }
        
        function gerarRelatorioCategoria(lancamentos, tipoGrafico) {
            // Ocultar tabela do fluxo de caixa
            document.getElementById('fluxo-caixa-tabela').style.display = 'none';
            
            // Agrupar lançamentos por categoria
            const dadosPorCategoria = {};
            
            lancamentos.forEach(lancamento => {
                const categoria = lancamento.categoria;
                const valor = lancamento.valor;
                
                if (!dadosPorCategoria[categoria]) {
                    dadosPorCategoria[categoria] = {
                        entradas: 0,
                        saidas: 0
                    };
                }
                
                if (lancamento.tipo === 'entrada') {
                    dadosPorCategoria[categoria].entradas += valor;
                } else {
                    dadosPorCategoria[categoria].saidas += valor;
                }
            });
            
            // Preparar dados para o gráfico
            const labels = Object.keys(dadosPorCategoria);
            const entradasData = [];
            const saidasData = [];
            
            labels.forEach(categoria => {
                entradasData.push(dadosPorCategoria[categoria].entradas);
                saidasData.push(dadosPorCategoria[categoria].saidas);
            });
            
            // Definir tipo de gráfico
            const tipo = tipoGrafico === 'pizza' ? 'pie' : 'bar';
            
            // Atualizar gráfico
            if (tipo === 'pie') {
                // Para gráfico de pizza, mostrar apenas saídas por categoria
                const cores = gerarCoresAleatorias(labels.length);
                
                // Filtrar categorias que têm despesas
                const categoriasFiltradas = [];
                const saidasFiltradas = [];
                const coresFiltradas = [];
                
                for (let i = 0; i < labels.length; i++) {
                    if (saidasData[i] > 0) {
                        categoriasFiltradas.push(labels[i]);
                        saidasFiltradas.push(saidasData[i]);
                        coresFiltradas.push(cores[i]);
                    }
                }
                
                atualizarGrafico('pie', 'Despesas por Categoria', categoriasFiltradas, [
                    {
                        data: saidasFiltradas,
                        backgroundColor: coresFiltradas,
                        borderColor: coresFiltradas.map(cor => cor.replace('0.5', '1')),
                        borderWidth: 1
                    }
                ]);
            } else {
                // Para gráfico de barras, mostrar entradas e saídas por categoria
                atualizarGrafico('bar', 'Análise por Categoria', labels, [
                    {
                        label: 'Entradas',
                        data: entradasData,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Saídas',
                        data: saidasData,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]);
            }
        }
        
        function gerarRelatorioTendencia(lancamentos, periodo) {
            // Ocultar tabela do fluxo de caixa
            document.getElementById('fluxo-caixa-tabela').style.display = 'none';
            
            // Agrupar lançamentos por período para análise de tendência
            const dadosAgrupados = agruparLancamentosPorPeriodo(lancamentos, periodo);
            
            // Preparar dados para o gráfico
            const labels = Object.keys(dadosAgrupados);
            const saldoData = [];
            const mediaMovel = [];
            
            // Primeiro, calcular todos os saldos
            labels.forEach((label) => {
                const dados = dadosAgrupados[label];
                const saldo = dados.entradas - dados.saidas;
                saldoData.push(saldo);
            });
            
            // Depois, calcular a média móvel
            for (let i = 0; i < labels.length; i++) {
                if (i >= 2) {
                    // Média móvel de 3 períodos
                    const media = (saldoData[i] + saldoData[i-1] + saldoData[i-2]) / 3;
                    mediaMovel.push(media);
                } else if (i === 1) {
                    // Para o segundo período, usar média de 2 períodos
                    const media = (saldoData[i] + saldoData[i-1]) / 2;
                    mediaMovel.push(media);
                } else {
                    // Para o primeiro período, usar o próprio valor
                    mediaMovel.push(saldoData[i]);
                }
            }
            
            // Atualizar gráfico
            atualizarGrafico('line', 'Análise de Tendência', labels, [
                {
                    label: 'Saldo',
                    data: saldoData,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    tension: 0.1
                },
                {
                    label: 'Tendência (Média Móvel)',
                    data: mediaMovel,
                    backgroundColor: 'rgba(255, 159, 64, 0.5)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 3,
                    borderDash: [5, 5],
                    tension: 0.1,
                    fill: false,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgba(255, 159, 64, 1)'
                }
            ]);
        }
        
        function agruparLancamentosPorPeriodo(lancamentos, periodo) {
            const dadosAgrupados = {};
            
            lancamentos.forEach(lancamento => {
                const data = new Date(lancamento.data);
                let chave;
                
                // Definir a chave de agrupamento com base no período
                switch(periodo) {
                    case 'diario':
                        chave = lancamento.data;
                        break;
                        
                    case 'semanal':
                        // Obter o primeiro dia da semana (domingo)
                        const primeiroDiaSemana = new Date(data);
                        primeiroDiaSemana.setDate(data.getDate() - data.getDay());
                        chave = `Semana ${primeiroDiaSemana.toISOString().split('T')[0]}`;
                        break;
                        
                    case 'mensal':
                        chave = `${data.getFullYear()}-${(data.getMonth() + 1).toString().padStart(2, '0')}`;
                        break;
                        
                    case 'trimestral':
                        const trimestre = Math.floor(data.getMonth() / 3) + 1;
                        chave = `${data.getFullYear()} T${trimestre}`;
                        break;
                        
                    case 'anual':
                        chave = data.getFullYear().toString();
                        break;
                        
                    default:
                        chave = lancamento.data;
                }
                
                // Inicializar o objeto para a chave se não existir
                if (!dadosAgrupados[chave]) {
                    dadosAgrupados[chave] = {
                        entradas: 0,
                        saidas: 0
                    };
                }
                
                // Somar valores
                if (lancamento.tipo === 'entrada') {
                    dadosAgrupados[chave].entradas += lancamento.valor;
                } else {
                    dadosAgrupados[chave].saidas += lancamento.valor;
                }
            });
            
            // Ordenar as chaves
            const chavesOrdenadas = Object.keys(dadosAgrupados).sort();
            const resultado = {};
            
            chavesOrdenadas.forEach(chave => {
                resultado[chave] = dadosAgrupados[chave];
            });
            
            return resultado;
        }
        
        function gerarRelatorioInvestimentos(periodo) {
            // Ocultar tabela do fluxo de caixa
            document.getElementById('fluxo-caixa-tabela').style.display = 'none';
            
            if (investimentos.length === 0) {
                alert('Não há investimentos cadastrados para gerar o relatório.');
                return;
            }
            
            // Calcular dados dos investimentos
            const valorTotalInvestido = investimentos.reduce((total, inv) => total + inv.valorTotal, 0);
            const totalDividendos = dividendos.reduce((total, div) => total + div.valor, 0);
            
            // Agrupar por categoria
            const distribuicaoPorCategoria = {};
            investimentos.forEach(inv => {
                if (!distribuicaoPorCategoria[inv.categoria]) {
                    distribuicaoPorCategoria[inv.categoria] = 0;
                }
                distribuicaoPorCategoria[inv.categoria] += inv.valorTotal;
            });
            
            // Preparar dados para o gráfico de distribuição por categoria
            const labels = Object.keys(distribuicaoPorCategoria);
            const valores = Object.values(distribuicaoPorCategoria);
            const cores = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)'
            ];
            
            // Atualizar gráfico
            atualizarGrafico('doughnut', 'Distribuição de Investimentos por Categoria', labels, [{
                label: 'Valor Investido',
                data: valores,
                backgroundColor: cores.slice(0, labels.length),
                borderColor: cores.slice(0, labels.length).map(cor => cor.replace('0.8', '1')),
                borderWidth: 2
            }]);
            
            // Atualizar estatísticas específicas de investimentos
            atualizarEstatisticasInvestimentos(valorTotalInvestido, totalDividendos);
        }
        
        function atualizarEstatisticasInvestimentos(valorTotal, totalDividendos) {
            const estatisticasDiv = document.getElementById('estatisticas-relatorio');
            const rentabilidade = valorTotal > 0 ? (totalDividendos / valorTotal) * 100 : 0;
            
            estatisticasDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-primary">Patrimônio Total</h5>
                                <h3 class="card-text">${valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">Dividendos Recebidos</h5>
                                <h3 class="card-text">${totalDividendos.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-info">Rentabilidade</h5>
                                <h3 class="card-text ${rentabilidade >= 0 ? 'text-success' : 'text-danger'}">${rentabilidade.toFixed(2)}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-warning">Total de Ativos</h5>
                                <h3 class="card-text">${investimentos.length}</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Resumo por Categoria</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Categoria</th>
                                                <th>Quantidade de Ativos</th>
                                                <th>Valor Investido</th>
                                                <th>Participação</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(investimentos.reduce((acc, inv) => {
                                                if (!acc[inv.categoria]) {
                                                    acc[inv.categoria] = { quantidade: 0, valor: 0 };
                                                }
                                                acc[inv.categoria].quantidade++;
                                                acc[inv.categoria].valor += inv.valorTotal;
                                                return acc;
                                            }, {})).map(([categoria, dados]) => `
                                                <tr>
                                                    <td>${categoria}</td>
                                                    <td>${dados.quantidade}</td>
                                                    <td>${dados.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                                    <td>${((dados.valor / valorTotal) * 100).toFixed(1)}%</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function atualizarGrafico(tipo, titulo, labels, datasets) {
            // Destruir o gráfico anterior se existir
            if (window.relatorioChart) {
                window.relatorioChart.destroy();
            }
            
            // Criar novo gráfico
            const ctx = document.getElementById('relatorioChart').getContext('2d');
            window.relatorioChart = new Chart(ctx, {
                type: tipo,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: tipo !== 'pie' ? {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Entradas e Saídas'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Saldo'
                            }
                        }
                    } : {},
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (tipo === 'pie') {
                                        return context.label + ': R$ ' + context.raw.toFixed(2);
                                    } else {
                                        return context.dataset.label + ': R$ ' + context.raw.toFixed(2);
                                    }
                                }
                            }
                        },
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: titulo
                        }
                    }
                }
            });
        }
        
        function gerarCoresAleatorias(quantidade) {
            const cores = [];
            const coresPredefinidas = [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(153, 102, 255, 0.5)',
                'rgba(255, 159, 64, 0.5)',
                'rgba(199, 199, 199, 0.5)',
                'rgba(83, 102, 255, 0.5)',
                'rgba(40, 159, 64, 0.5)',
                'rgba(210, 199, 199, 0.5)'
            ];
            
            for (let i = 0; i < quantidade; i++) {
                if (i < coresPredefinidas.length) {
                    cores.push(coresPredefinidas[i]);
                } else {
                    // Gerar cor aleatória se precisar de mais cores
                    const r = Math.floor(Math.random() * 255);
                    const g = Math.floor(Math.random() * 255);
                    const b = Math.floor(Math.random() * 255);
                    cores.push(`rgba(${r}, ${g}, ${b}, 0.5)`);
                }
            }
            
            return cores;
        }
        
        function atualizarEstatisticasRelatorio(lancamentos) {
            // Calcular estatísticas
            let totalEntradas = 0;
            let totalSaidas = 0;
            let maiorEntrada = 0;
            let maiorSaida = 0;
            let categoriasMaisGastos = {};
            
            lancamentos.forEach(lancamento => {
                if (lancamento.tipo === 'entrada') {
                    totalEntradas += lancamento.valor;
                    if (lancamento.valor > maiorEntrada) {
                        maiorEntrada = lancamento.valor;
                    }
                } else {
                    totalSaidas += lancamento.valor;
                    if (lancamento.valor > maiorSaida) {
                        maiorSaida = lancamento.valor;
                    }
                    
                    // Contabilizar gastos por categoria
                    if (!categoriasMaisGastos[lancamento.categoria]) {
                        categoriasMaisGastos[lancamento.categoria] = 0;
                    }
                    categoriasMaisGastos[lancamento.categoria] += lancamento.valor;
                }
            });
            
            // Encontrar categoria com mais gastos
            let categoriaMaisGastos = '';
            let valorMaisGastos = 0;
            
            for (const categoria in categoriasMaisGastos) {
                if (categoriasMaisGastos[categoria] > valorMaisGastos) {
                    categoriaMaisGastos = categoria;
                    valorMaisGastos = categoriasMaisGastos[categoria];
                }
            }
            
            // Atualizar elementos HTML
            document.getElementById('estatistica-total-entradas').textContent = formatarMoeda(totalEntradas);
            document.getElementById('estatistica-total-saidas').textContent = formatarMoeda(totalSaidas);
            document.getElementById('estatistica-saldo').textContent = formatarMoeda(totalEntradas - totalSaidas);
            document.getElementById('estatistica-maior-entrada').textContent = formatarMoeda(maiorEntrada);
            document.getElementById('estatistica-maior-saida').textContent = formatarMoeda(maiorSaida);
            document.getElementById('estatistica-categoria-mais-gastos').textContent = 
                categoriaMaisGastos ? `${categoriaMaisGastos} (${formatarMoeda(valorMaisGastos)})` : 'Nenhuma';
        }
        
        function formatarMoeda(valor) {
            return 'R$ ' + valor.toFixed(2).replace('.', ',');
        }
        
        // Configurar eventos relacionados ao gráfico
        function configurarEventosGrafico() {
            // Eventos para troca de tipo de gráfico
            document.querySelectorAll('.tipo-grafico').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tipoGrafico = this.getAttribute('data-tipo');
                    mudarTipoGrafico(tipoGrafico);
                });
            });
            
            // Evento para comparar períodos
            document.getElementById('comparar-periodos').addEventListener('change', function() {
                const comparar = this.checked;
                compararPeriodos(comparar);
            });
        }
        
        // Função para mudar o tipo de gráfico
        function mudarTipoGrafico(tipo) {
            // Atualizar ícone do botão dropdown
            const icone = document.querySelector('#tipoGraficoDropdown i');
            switch(tipo) {
                case 'doughnut':
                    icone.className = 'bi bi-pie-chart';
                    break;
                case 'pie':
                    icone.className = 'bi bi-pie-chart-fill';
                    break;
                case 'bar':
                    icone.className = 'bi bi-bar-chart';
                    break;
                case 'polarArea':
                    icone.className = 'bi bi-bullseye';
                    break;
            }
            
            // Salvar preferência do usuário
            localStorage.setItem('tipoGraficoPreferido', tipo);
            
            // Recarregar gráfico com o novo tipo
            comparativoChart.config.type = tipo;
            
            // Ajustar opções específicas para cada tipo de gráfico
            if (tipo === 'bar') {
                comparativoChart.options.indexAxis = 'y'; // Barras horizontais
                comparativoChart.options.scales = {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('pt-BR', {
                                    style: 'currency',
                                    currency: 'BRL'
                                }).format(value);
                            }
                        }
                    }
                };
            } else {
                // Remover escalas para gráficos de pizza/rosca/polar
                comparativoChart.options.scales = {};
            }
            
            // Atualizar o gráfico
            comparativoChart.update();
        }
        
        // Função para comparar com período anterior
        function compararPeriodos(comparar) {
            if (comparar) {
                // Obter período atual
                const periodoAtual = document.getElementById('periodo').value;
                const mesAtual = periodoAtual === 'mensal' ? parseInt(document.getElementById('mes').value) : null;
                const anoAtual = periodoAtual === 'mensal' ? document.getElementById('ano').value : document.getElementById('anoAnual').value;
                
                // Calcular período anterior
                let mesAnterior, anoAnterior;
                
                if (periodoAtual === 'mensal') {
                    if (mesAtual === 0) { // Janeiro
                        mesAnterior = 11; // Dezembro
                        anoAnterior = (parseInt(anoAtual) - 1).toString();
                    } else {
                        mesAnterior = mesAtual - 1;
                        anoAnterior = anoAtual;
                    }
                } else {
                    // Período anual
                    anoAnterior = (parseInt(anoAtual) - 1).toString();
                }
                
                // Filtrar lançamentos do período anterior
                const lancamentosAnteriores = lancamentos.filter(l => {
                    const dataLancamento = new Date(l.data);
                    const anoLancamento = dataLancamento.getFullYear().toString();
                    const mesLancamento = dataLancamento.getMonth();
                    
                    if (periodoAtual === 'mensal') {
                        return anoLancamento === anoAnterior && mesLancamento === mesAnterior;
                    } else {
                        return anoLancamento === anoAnterior;
                    }
                });
                
                // Calcular totais do período anterior
                const entradasAnteriores = lancamentosAnteriores
                    .filter(l => l.tipo === 'entrada')
                    .reduce((total, l) => total + l.valor, 0);
                    
                const saidasAnteriores = lancamentosAnteriores
                    .filter(l => l.tipo === 'saida')
                    .reduce((total, l) => total + l.valor, 0);
                
                // Obter dados atuais
                const totalEntradas = comparativoChart.data.datasets[0].data[0];
                const totalSaidas = comparativoChart.data.datasets[0].data[1];
                
                // Calcular saldos
                const saldoAtual = totalEntradas - totalSaidas;
                const saldoAnterior = entradasAnteriores - saidasAnteriores;
                
                // Atualizar gráfico para mostrar comparação
                comparativoChart.data.labels = ['Entradas Atual', 'Entradas Anterior', 'Saídas Atual', 'Saídas Anterior'];
                comparativoChart.data.datasets[0].data = [totalEntradas, entradasAnteriores, totalSaidas, saidasAnteriores];
                comparativoChart.data.datasets[0].backgroundColor = ['#28a745', '#8bc34a', '#dc3545', '#ff9800'];
                
                // Atualizar informações adicionais
                const variacaoEntradas = ((totalEntradas - entradasAnteriores) / (entradasAnteriores || 1) * 100).toFixed(1);
                const variacaoSaidas = ((totalSaidas - saidasAnteriores) / (saidasAnteriores || 1) * 100).toFixed(1);
                
                document.getElementById('valor-entrada').innerHTML = `${new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(totalEntradas)} <small class="${variacaoEntradas >= 0 ? 'text-success' : 'text-danger'}">(<i class="bi bi-${variacaoEntradas >= 0 ? 'arrow-up' : 'arrow-down'}"></i> ${Math.abs(variacaoEntradas)}%)</small>`;
                
                document.getElementById('valor-saida').innerHTML = `${new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(totalSaidas)} <small class="${variacaoSaidas >= 0 ? 'text-danger' : 'text-success'}">(<i class="bi bi-${variacaoSaidas >= 0 ? 'arrow-up' : 'arrow-down'}"></i> ${Math.abs(variacaoSaidas)}%)</small>`;
                
                // Forçar tipo de gráfico para barras na comparação
                mudarTipoGrafico('bar');
            } else {
                // Voltar para visualização normal
                aplicarFiltros();
            }
        }

        // Funções para gerenciar foto de perfil
        function abrirModalPerfil() {
            if (!usuarioAtual) return;
            
            // Atualizar informações do usuário no modal
            document.getElementById('modal-user-name').textContent = usuarioAtual.nome;
            document.getElementById('modal-user-email').textContent = usuarioAtual.email;
            
            // Carregar foto de perfil salva
            const fotoSalva = localStorage.getItem(`foto_perfil_${usuarioAtual.email}`);
            if (fotoSalva) {
                document.getElementById('modal-profile-photo').src = fotoSalva;
            }
            
            // Abrir modal
            new bootstrap.Modal(document.getElementById('perfilModal')).show();
        }

        function configurarUploadFoto() {
            const uploadArea = document.getElementById('profile-upload-area');
            const fileInput = document.getElementById('profile-photo-input');
            const modalPhoto = document.getElementById('modal-profile-photo');
            const navbarPhoto = document.getElementById('navbar-profile-photo');
            
            // Clique na área de upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'var(--bs-light)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processarArquivoFoto(files[0]);
                }
            });
            
            // Seleção de arquivo
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    processarArquivoFoto(e.target.files[0]);
                }
            });
            
            // Botão remover foto
            document.getElementById('remover-foto').addEventListener('click', () => {
                const fotoDefault = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z'/%3E%3C/svg%3E";
                modalPhoto.src = fotoDefault;
                navbarPhoto.src = fotoDefault.replace('120', '40');
            });
            
            // Botão salvar foto
            document.getElementById('salvar-foto').addEventListener('click', () => {
                if (!usuarioAtual) return;
                
                // Salvar foto no localStorage
                localStorage.setItem(`foto_perfil_${usuarioAtual.email}`, modalPhoto.src);
                
                // Atualizar foto na navbar
                navbarPhoto.src = modalPhoto.src;
                
                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('perfilModal')).hide();
                
                // Mostrar mensagem de sucesso
                mostrarMensagem('Foto de perfil atualizada com sucesso!', 'success');
            });
        }

        function processarArquivoFoto(arquivo) {
            // Validar tipo de arquivo
            if (!arquivo.type.startsWith('image/')) {
                mostrarMensagem('Por favor, selecione um arquivo de imagem válido.', 'danger');
                return;
            }
            
            // Validar tamanho (2MB)
            if (arquivo.size > 2 * 1024 * 1024) {
                mostrarMensagem('A imagem deve ter no máximo 2MB.', 'danger');
                return;
            }
            
            // Ler arquivo e converter para base64
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('modal-profile-photo').src = e.target.result;
            };
            reader.readAsDataURL(arquivo);
        }

        function carregarFotoPerfil() {
            if (!usuarioAtual) return;
            
            const fotoSalva = localStorage.getItem(`foto_perfil_${usuarioAtual.email}`);
            if (fotoSalva) {
                document.getElementById('navbar-profile-photo').src = fotoSalva;
            }
        }

        // Função para exportar relatório em PDF
        function exportarRelatorioPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Configurações do PDF
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            
            // Cabeçalho
            pdf.setFontSize(20);
            pdf.setFont(undefined, 'bold');
            pdf.text('Relatório Financeiro', margin, 30);
            
            // Informações do usuário
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Usuário: ${usuarioAtual.nome}`, margin, 45);
            pdf.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')}`, margin, 55);
            
            // Período do relatório
            const dataInicio = document.getElementById('data-inicio-relatorio').value;
            const dataFim = document.getElementById('data-fim-relatorio').value;
            const tipoRelatorio = document.getElementById('tipo-relatorio').value;
            
            if (dataInicio && dataFim) {
                // Corrigir problema de fuso horário para as datas do período
                const partesDataInicio = dataInicio.split('-');
                const dataInicioLocal = new Date(partesDataInicio[0], partesDataInicio[1] - 1, partesDataInicio[2]);
                const partesDataFim = dataFim.split('-');
                const dataFimLocal = new Date(partesDataFim[0], partesDataFim[1] - 1, partesDataFim[2]);
                pdf.text(`Período: ${dataInicioLocal.toLocaleDateString('pt-BR')} a ${dataFimLocal.toLocaleDateString('pt-BR')}`, margin, 65);
            }
            pdf.text(`Tipo de relatório: ${tipoRelatorio.charAt(0).toUpperCase() + tipoRelatorio.slice(1)}`, margin, 75);
            
            // Linha separadora
            pdf.line(margin, 85, pageWidth - margin, 85);
            
            // Estatísticas
            let yPosition = 100;
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Resumo Financeiro', margin, yPosition);
            
            yPosition += 15;
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            
            // Obter dados das estatísticas
            const totalEntradas = document.querySelector('#relatorio-estatisticas tr:nth-child(1) td:nth-child(2)')?.textContent || 'R$ 0,00';
            const totalSaidas = document.querySelector('#relatorio-estatisticas tr:nth-child(2) td:nth-child(2)')?.textContent || 'R$ 0,00';
            const saldoFinal = document.querySelector('#relatorio-estatisticas tr:nth-child(3) td:nth-child(2)')?.textContent || 'R$ 0,00';
            const numeroTransacoes = document.querySelector('#relatorio-estatisticas tr:nth-child(4) td:nth-child(2)')?.textContent || '0';
            
            pdf.text(`Total de Entradas: ${totalEntradas}`, margin, yPosition);
            yPosition += 12;
            pdf.text(`Total de Saídas: ${totalSaidas}`, margin, yPosition);
            yPosition += 12;
            pdf.text(`Saldo Final: ${saldoFinal}`, margin, yPosition);
            yPosition += 12;
            pdf.text(`Número de Transações: ${numeroTransacoes}`, margin, yPosition);
            
            // Capturar gráfico
            const canvas = document.getElementById('relatorioChart');
            if (canvas) {
                yPosition += 25;
                
                // Verificar se há espaço suficiente na página
                if (yPosition + 120 > pageHeight - margin) {
                    pdf.addPage();
                    yPosition = margin + 20;
                }
                
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('Gráfico do Relatório', margin, yPosition);
                yPosition += 15;
                
                // Converter canvas para imagem
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = pageWidth - (margin * 2);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', margin, yPosition, imgWidth, imgHeight);
            }
            
            // Salvar PDF
            const nomeArquivo = `relatorio_financeiro_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(nomeArquivo);
            
            mostrarMensagem('Relatório exportado com sucesso!', 'success');
        }

        // Função para exibir tabela do fluxo de caixa na interface
        function exibirTabelaFluxoCaixa(dadosFluxoCaixa) {
            const tabelaDiv = document.getElementById('fluxo-caixa-tabela');
            const tbody = document.getElementById('fluxo-caixa-tbody');
            
            // Limpar tabela anterior
            tbody.innerHTML = '';
            
            // Preencher tabela com dados
            dadosFluxoCaixa.periodos.forEach(periodoChave => {
                const dados = dadosFluxoCaixa.dados[periodoChave];
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td><strong>${periodoChave}</strong></td>
                    <td class="text-end">R$ ${dados.saldoInicial.toFixed(2).replace('.', ',')}</td>
                    <td class="text-end text-success">R$ ${dados.entradas.toFixed(2).replace('.', ',')}</td>
                    <td class="text-end text-danger">R$ ${dados.saidas.toFixed(2).replace('.', ',')}</td>
                    <td class="text-end ${dados.movimento >= 0 ? 'text-success' : 'text-danger'}">
                        R$ ${dados.movimento.toFixed(2).replace('.', ',')}
                    </td>
                    <td class="text-end ${dados.saldoFinal >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>R$ ${dados.saldoFinal.toFixed(2).replace('.', ',')}</strong>
                    </td>
                `;
                
                // Se for período diário, mostrar detalhes das transações
                if (periodo === 'diario' && dados.transacoes.length > 0) {
                    dados.transacoes.forEach(transacao => {
                        const detailRow = tbody.insertRow();
                        detailRow.className = 'table-light';
                        detailRow.innerHTML = `
                            <td style="padding-left: 30px;">
                                <small><i class="bi bi-arrow-return-right"></i> ${transacao.descricao}</small>
                            </td>
                            <td class="text-end"><small>${transacao.categoria}</small></td>
                            <td class="text-end ${transacao.tipo === 'entrada' ? 'text-success' : ''}">
                                <small>${transacao.tipo === 'entrada' ? 'R$ ' + transacao.valor.toFixed(2).replace('.', ',') : '-'}</small>
                            </td>
                            <td class="text-end ${transacao.tipo === 'saida' ? 'text-danger' : ''}">
                                <small>${transacao.tipo === 'saida' ? 'R$ ' + transacao.valor.toFixed(2).replace('.', ',') : '-'}</small>
                            </td>
                            <td></td>
                            <td></td>
                        `;
                    });
                }
            });
            
            // Adicionar linha de totais
            const totalRow = tbody.insertRow();
            totalRow.className = 'table-warning';
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td class="text-end"><strong>R$ ${dadosFluxoCaixa.saldoInicial.toFixed(2).replace('.', ',')}</strong></td>
                <td class="text-end text-success"><strong>R$ ${dadosFluxoCaixa.totalEntradas.toFixed(2).replace('.', ',')}</strong></td>
                <td class="text-end text-danger"><strong>R$ ${dadosFluxoCaixa.totalSaidas.toFixed(2).replace('.', ',')}</strong></td>
                <td class="text-end ${(dadosFluxoCaixa.totalEntradas - dadosFluxoCaixa.totalSaidas) >= 0 ? 'text-success' : 'text-danger'}">
                    <strong>R$ ${(dadosFluxoCaixa.totalEntradas - dadosFluxoCaixa.totalSaidas).toFixed(2).replace('.', ',')}</strong>
                </td>
                <td class="text-end ${dadosFluxoCaixa.saldoFinal >= 0 ? 'text-success' : 'text-danger'}">
                    <strong>R$ ${dadosFluxoCaixa.saldoFinal.toFixed(2).replace('.', ',')}</strong>
                </td>
            `;
            
            // Mostrar a tabela
            tabelaDiv.style.display = 'block';
        }

        // Função para gerar dados do fluxo de caixa
        function gerarDadosFluxoCaixa() {
            const dataInicio = document.getElementById('data-inicio-relatorio').value;
            const dataFim = document.getElementById('data-fim-relatorio').value;
            
            if (!dataInicio || !dataFim) {
                mostrarMensagem('Por favor, selecione as datas de início e fim.', 'warning');
                return null;
            }
            
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            
            // Filtrar lançamentos no período
            console.log(`🔍 DEBUG FILTRO - Início: ${inicio} | Fim: ${fim}`);
            console.log(`🔍 DEBUG FILTRO - Total de lançamentos disponíveis: ${lancamentos.length}`);
            
            const lancamentosFiltrados = lancamentos.filter(lancamento => {
                const dataLancamento = new Date(lancamento.data);
                const dentroDoFiltro = dataLancamento >= inicio && dataLancamento <= fim;
                
                console.log(`   Lançamento ID ${lancamento.id}: Data ${lancamento.data} -> ${dataLancamento} | Dentro do filtro: ${dentroDoFiltro}`);
                
                return dentroDoFiltro;
            });
            
            console.log(`🔍 DEBUG FILTRO - Lançamentos filtrados: ${lancamentosFiltrados.length}`);
            
            // Calcular saldo acumulado de todos os lançamentos anteriores ao período
            // Garantir que estamos usando o saldo inicial correto do localStorage
            const saldoInicialSalvo = localStorage.getItem(`${userPrefix}SaldoInicial`);
            const saldoInicialAtual = saldoInicialSalvo ? parseFloat(saldoInicialSalvo) : 0;
            let saldoAcumulado = saldoInicialAtual;
            
            // Somar todos os lançamentos anteriores ao período de início
            lancamentos.forEach(lancamento => {
                const dataLancamento = new Date(lancamento.data);
                if (dataLancamento < inicio) {
                    if (lancamento.tipo === 'entrada' || lancamento.tipo === 'Transferência') {
                        saldoAcumulado += lancamento.valor;
                    } else if (lancamento.tipo === 'saida') {
                        saldoAcumulado -= lancamento.valor;
                    }
                }
            });
            
            // Organizar por período mensal
            const fluxoCaixa = {};
            
            // Formato da chave: MM/AAAA
            const formatarChave = (data) => {
                return `${String(data.getMonth() + 1).padStart(2, '0')}/${data.getFullYear()}`;
            };
            
            // Não inicializar períodos vazios - apenas criar quando houver movimentação
            
            // Processar lançamentos
            lancamentosFiltrados.forEach(lancamento => {
                const dataLancamento = new Date(lancamento.data);
                
                // Verificar se a data do lançamento está dentro do intervalo
                if (dataLancamento >= inicio && dataLancamento <= fim) {
                    const chave = formatarChave(dataLancamento);
                    
                    // Criar período se não existir (para casos onde não foi inicializado)
                    if (!fluxoCaixa[chave]) {
                        fluxoCaixa[chave] = {
                            periodo: chave,
                            entradas: 0,
                            saidas: 0,
                            saldoInicial: 0,
                            saldoFinal: 0,
                            transacoes: []
                        };
                    }
                    
                    if (lancamento.tipo === 'entrada' || lancamento.tipo === 'Transferência') {
                        fluxoCaixa[chave].entradas += lancamento.valor;
                    } else if (lancamento.tipo === 'saida') {
                        fluxoCaixa[chave].saidas += lancamento.valor;
                    }
                    
                    fluxoCaixa[chave].transacoes.push({
                        data: lancamento.data,
                        descricao: lancamento.descricao,
                        categoria: lancamento.categoria,
                        tipo: lancamento.tipo,
                        valor: lancamento.valor
                    });
                }
            });
            
            // Calcular saldos finais
            // Ordenar períodos cronologicamente (formato MM/AAAA)
            const periodosOrdenados = Object.keys(fluxoCaixa).sort((a, b) => {
                const [mesA, anoA] = a.split('/');
                const [mesB, anoB] = b.split('/');
                if (anoA !== anoB) return anoA - anoB;
                return mesA - mesB;
            });
            let saldoCorrente = saldoAcumulado;
            
            console.log('DEBUG Fluxo Caixa - Saldo acumulado inicial:', saldoAcumulado);
            console.log('DEBUG Fluxo Caixa - Períodos ordenados:', periodosOrdenados);
            
            // Filtrar períodos válidos e calcular saldos
            const periodosValidos = [];
            periodosOrdenados.forEach(periodoChave => {
                // Primeiro verificar se há movimentação (entradas ou saídas)
                const temMovimentacao = fluxoCaixa[periodoChave].entradas > 0 || fluxoCaixa[periodoChave].saidas > 0;
                
                if (!temMovimentacao) {
                    return; // Pular períodos sem movimentação
                }
                
                // Verificar se o período está dentro do intervalo (agrupamento mensal)
                const [mes, ano] = periodoChave.split('/');
                const dataPeriodo = new Date(ano, mes - 1, 1);
                const fimMes = new Date(ano, mes, 0);
                
                // Sempre processar períodos até o fim do filtro para calcular saldo corretamente
                const periodoValido = dataPeriodo <= fim;
                
                // Mas só incluir no relatório os períodos dentro do filtro
                const incluirNoRelatorio = (dataPeriodo <= fim && fimMes >= inicio);
                
                if (periodoValido) {
                    // Sempre calcular o saldo para manter a sequência correta
                    fluxoCaixa[periodoChave].saldoInicial = saldoCorrente;
                    const movimento = fluxoCaixa[periodoChave].entradas - fluxoCaixa[periodoChave].saidas;
                    saldoCorrente += movimento;
                    fluxoCaixa[periodoChave].saldoFinal = saldoCorrente;
                    fluxoCaixa[periodoChave].movimento = movimento;
                    
                    // Só incluir no relatório se estiver dentro do filtro
                    if (incluirNoRelatorio) {
                        periodosValidos.push(periodoChave);
                        console.log(`DEBUG Período ${periodoChave} (INCLUÍDO):`, {
                            saldoInicial: fluxoCaixa[periodoChave].saldoInicial,
                            entradas: fluxoCaixa[periodoChave].entradas,
                            saidas: fluxoCaixa[periodoChave].saidas,
                            movimento: movimento,
                            saldoFinal: fluxoCaixa[periodoChave].saldoFinal
                        });
                    } else {
                        console.log(`DEBUG Período ${periodoChave} (PROCESSADO mas não incluído):`, {
                            saldoInicial: fluxoCaixa[periodoChave].saldoInicial,
                            entradas: fluxoCaixa[periodoChave].entradas,
                            saidas: fluxoCaixa[periodoChave].saidas,
                            movimento: movimento,
                            saldoFinal: fluxoCaixa[periodoChave].saldoFinal
                        });
                    }
                }
            });
            
            return {
                dados: fluxoCaixa,
                periodos: periodosValidos,
                totalEntradas: lancamentosFiltrados.filter(l => l.tipo === 'entrada').reduce((sum, l) => sum + l.valor, 0),
                totalSaidas: lancamentosFiltrados.filter(l => l.tipo === 'saida').reduce((sum, l) => sum + l.valor, 0),
                saldoInicial: saldoAcumulado, // Saldo que inclui todos os lançamentos anteriores
                saldoFinal: saldoCorrente
            };
        }

        // Função para exportar fluxo de caixa em PDF
        function exportarFluxoCaixaPDF() {
            const dadosFluxo = gerarDadosFluxoCaixa();
            if (!dadosFluxo) return;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Configurações do PDF
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            let yPosition = 30;
            
            // Cabeçalho
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('FLUXO DE CAIXA', margin, yPosition);
            
            yPosition += 15;
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Usuário: ${usuarioAtual.nome}`, margin, yPosition);
            
            yPosition += 10;
            pdf.text(`Período: ${document.getElementById('data-inicio-relatorio').value} a ${document.getElementById('data-fim-relatorio').value}`, margin, yPosition);
            
            yPosition += 10;
            pdf.text(`Agrupamento: Mensal`, margin, yPosition);
            
            yPosition += 10;
            pdf.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')}`, margin, yPosition);
            
            // Linha separadora
            yPosition += 10;
            pdf.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 15;
            
            // Resumo geral
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('RESUMO GERAL', margin, yPosition);
            
            yPosition += 15;
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            
            pdf.text(`Saldo Inicial: R$ ${dadosFluxo.saldoInicial.toFixed(2).replace('.', ',')}`, margin, yPosition);
            yPosition += 10;
            pdf.text(`Total de Entradas: R$ ${dadosFluxo.totalEntradas.toFixed(2).replace('.', ',')}`, margin, yPosition);
            yPosition += 10;
            pdf.text(`Total de Saídas: R$ ${dadosFluxo.totalSaidas.toFixed(2).replace('.', ',')}`, margin, yPosition);
            yPosition += 10;
            pdf.text(`Saldo Final: R$ ${dadosFluxo.saldoFinal.toFixed(2).replace('.', ',')}`, margin, yPosition);
            
            yPosition += 20;
            
            // Tabela do fluxo de caixa
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('DEMONSTRATIVO DO FLUXO DE CAIXA', margin, yPosition);
            
            yPosition += 15;
            
            // Cabeçalho da tabela
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'bold');
            
            const colWidths = [30, 35, 35, 35, 35];
            const colPositions = [margin, margin + colWidths[0], margin + colWidths[0] + colWidths[1], 
                                margin + colWidths[0] + colWidths[1] + colWidths[2], 
                                margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3]];
            
            pdf.text('Período', colPositions[0], yPosition);
            pdf.text('Entradas', colPositions[1], yPosition);
            pdf.text('Saídas', colPositions[2], yPosition);
            pdf.text('Movimento', colPositions[3], yPosition);
            pdf.text('Saldo Final', colPositions[4], yPosition);
            
            yPosition += 5;
            pdf.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;
            
            // Dados da tabela
            pdf.setFont(undefined, 'normal');
            
            dadosFluxo.periodos.forEach(periodo => {
                const dados = dadosFluxo.dados[periodo];
                
                // Verificar se precisa de nova página
                if (yPosition > pageHeight - 30) {
                    pdf.addPage();
                    yPosition = 30;
                }
                
                pdf.text(periodo, colPositions[0], yPosition);
                pdf.text(`R$ ${dados.entradas.toFixed(2).replace('.', ',')}`, colPositions[1], yPosition);
                pdf.text(`R$ ${dados.saidas.toFixed(2).replace('.', ',')}`, colPositions[2], yPosition);
                
                const movimento = dados.movimento;
                const movimentoTexto = `R$ ${Math.abs(movimento).toFixed(2).replace('.', ',')}`;
                pdf.text(movimento >= 0 ? `+${movimentoTexto}` : `-${movimentoTexto}`, colPositions[3], yPosition);
                pdf.text(`R$ ${dados.saldoFinal.toFixed(2).replace('.', ',')}`, colPositions[4], yPosition);
                
                yPosition += 12;
            });
            
            // Linha final
            yPosition += 5;
            pdf.line(margin, yPosition, pageWidth - margin, yPosition);
            
            // Salvar PDF
            const nomeArquivo = `fluxo_caixa_${tipoPeriodo.toLowerCase()}_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(nomeArquivo);
            
            mostrarMensagem('Fluxo de caixa exportado com sucesso!', 'success');
        }

        // Event listeners para exportação de PDF
        document.getElementById('exportar-pdf').addEventListener('click', exportarRelatorioPDF);
            document.getElementById('exportar-fluxo-caixa').addEventListener('click', exportarFluxoCaixaPDF);
            document.getElementById('recarregar-fluxo-caixa-inicial').addEventListener('click', recarregarFluxoCaixaInicial);
        
        // Habilitar botões de exportar quando relatório for gerado
        document.getElementById('gerar-relatorio').addEventListener('click', () => {
            setTimeout(() => {
                document.getElementById('exportar-pdf').disabled = false;
                document.getElementById('exportar-fluxo-caixa').disabled = false;
            }, 500);
        });

        // ===== GERENCIAMENTO DE BANCOS E CARTÕES =====
        
        // Logos dos bancos em SVG
        const logosbancos = {
            'nubank': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#8A05BE"/><path d="M12 6L18 12L12 18L6 12L12 6Z" fill="white"/></svg>',
            'inter': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#FF7A00"/><path d="M8 8H16V16H8V8Z" fill="white"/></svg>',
            'bradesco': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#CC092F"/><circle cx="12" cy="12" r="6" fill="white"/></svg>',
            'itau': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#EC7000"/><path d="M6 12L12 6L18 12L12 18L6 12Z" fill="white"/></svg>',
            'santander': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#EC0000"/><path d="M8 8L16 8L12 16L8 8Z" fill="white"/></svg>',
            'caixa': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#0066CC"/><rect x="8" y="8" width="8" height="8" fill="white"/></svg>',
            'bb': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#FFDD00"/><path d="M8 8H16V16H8V8Z" fill="#003366"/></svg>',
            'c6': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#000000"/><text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">C6</text></svg>',
            'picpay': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#21C25E"/><circle cx="12" cy="12" r="4" fill="white"/></svg>',
            'neon': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#00D4FF"/><path d="M8 8L16 16M16 8L8 16" stroke="white" stroke-width="2"/></svg>',
            'original': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#00A859"/><circle cx="12" cy="12" r="5" fill="white"/></svg>',
            'next': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#00D4AA"/><path d="M8 8L16 12L8 16V8Z" fill="white"/></svg>',
            'default': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#6C757D"/><path d="M8 8H16V16H8V8Z" fill="white"/></svg>'
        };
         
         // Função para obter logo do banco
         function obterLogoBanco(nomeBanco) {
             if (!nomeBanco) return logosbancos.default;
             
             const nomeNormalizado = nomeBanco.toLowerCase()
                 .replace(/\s+/g, '')
                 .replace(/banco/g, '')
                 .replace(/do/g, '')
                 .replace(/brasil/g, 'bb')
                 .replace(/itaú/g, 'itau')
                 .replace(/bradesco/g, 'bradesco')
                 .replace(/santander/g, 'santander')
                 .replace(/caixa/g, 'caixa')
                 .replace(/nubank/g, 'nubank')
                 .replace(/inter/g, 'inter')
                 .replace(/c6bank/g, 'c6')
                 .replace(/picpay/g, 'picpay')
                 .replace(/neon/g, 'neon')
                 .replace(/original/g, 'original')
                 .replace(/next/g, 'next');
             
             return logosbancos[nomeNormalizado] || logosbancos.default;
        }
        
        function obterIconeBanco(nomeBanco) {
            if (!nomeBanco) return '<i class="bi bi-bank"></i>';
            
            const nomeNormalizado = nomeBanco.toLowerCase()
                .replace(/\s+/g, '')
                .replace(/banco/g, '')
                .replace(/do/g, '')
                .replace(/brasil/g, 'bb')
                .replace(/itaú/g, 'itau')
                .replace(/bradesco/g, 'bradesco')
                .replace(/santander/g, 'santander')
                .replace(/caixa/g, 'caixa')
                .replace(/nubank/g, 'nubank')
                .replace(/inter/g, 'inter')
                .replace(/c6bank/g, 'c6')
                .replace(/picpay/g, 'picpay')
                .replace(/neon/g, 'neon')
                .replace(/original/g, 'original')
                .replace(/next/g, 'next');
            
            const logoSvg = logosbancos[nomeNormalizado] || logosbancos.default;
            return `<div class="banco-logo-tabela">${logoSvg}</div>`;
        }
        
        // Função para formatar banco/conta na tabela com logo e conta abreviada
         function formatarBancoContaTabela(bancoId, contaId) {
             if (!bancoId) return '-';
             
             // Buscar banco pelo ID
             const banco = bancos.find(b => b.id == bancoId);
             if (!banco) return '-';
             
             // Obter logo do banco
             const logoSvg = obterLogoBanco(banco.nome);
             
             // Formatar conta (apenas 3 últimos dígitos se for número)
             let contaFormatada = '';
             if (contaId && banco.contas) {
                 const conta = banco.contas.find(c => c.id == contaId);
                 if (conta && conta.numero) {
                     // Extrair apenas números da conta
                     const numerosConta = conta.numero.replace(/\D/g, '');
                     if (numerosConta.length >= 3) {
                         contaFormatada = `***${numerosConta.slice(-3)}`;
                     } else {
                         contaFormatada = conta.numero;
                     }
                     // Removido a exibição do tipo de conta
                 }
             }
             
             // Retornar HTML com logo e conta abreviada
             return `
                 <div class="d-flex align-items-center">
                     <div class="banco-logo-tabela me-2">${logoSvg}</div>
                     <div class="banco-info-tabela">
                         <div class="banco-nome-tabela">${banco.nome}</div>
                         ${contaFormatada ? `<small class="text-muted">${contaFormatada}</small>` : ''}
                     </div>
                 </div>
             `;
         }
         
         // Função para aplicar logo do banco selecionado
         function aplicarLogoBanco(selectElement) {
             const bancoSelecionado = selectElement.value;
             const container = selectElement.closest('.banco-select-wrapper') || selectElement.parentElement;
             
             // Remover classes anteriores
             container.classList.remove('banco-select-container', 'banco-nubank', 'banco-inter', 'banco-bradesco', 'banco-itau', 'banco-santander', 'banco-caixa', 'banco-bb', 'banco-c6', 'banco-picpay', 'banco-neon', 'banco-original', 'banco-next', 'banco-default');
             
             if (bancoSelecionado) {
                 const banco = bancos.find(b => b.id == bancoSelecionado);
                 if (banco) {
                     const nomeNormalizado = banco.nome.toLowerCase()
                         .replace(/\s+/g, '')
                         .replace(/banco/g, '')
                         .replace(/do/g, '')
                         .replace(/brasil/g, 'bb')
                         .replace(/itaú/g, 'itau')
                         .replace(/c6bank/g, 'c6');
                     
                     container.classList.add('banco-select-container');
                     
                     if (logosbancos[nomeNormalizado]) {
                         container.classList.add(`banco-${nomeNormalizado}`);
                     } else {
                         container.classList.add('banco-default');
                     }
                 }
             }
         }
         
         // Função para carregar bancos nos selects
        function carregarBancos() {
            // Carregar bancos no select do modal de lançamentos
            const selectBanco = document.getElementById('bancoModal');
            if (selectBanco) {
                selectBanco.innerHTML = '<option value="">Selecione um banco</option>';
                
                // Filtrar apenas bancos válidos
                const bancosValidos = bancos.filter(banco => {
                    return banco && 
                           banco.nome && 
                           banco.nome !== 'undefined' && 
                           banco.id && 
                           banco.contas && 
                           Array.isArray(banco.contas) &&
                           banco.contas.length > 0;
                });
                
                bancosValidos.forEach(banco => {
                    const option = document.createElement('option');
                    option.value = banco.id;
                    option.textContent = banco.nome;
                    option.setAttribute('data-logo', obterLogoBanco(banco.nome));
                    selectBanco.appendChild(option);
                });
                
                // Adicionar classe para estilização customizada
                selectBanco.classList.add('select-com-logo');
                
                // Adicionar event listener para aplicar logo
                selectBanco.addEventListener('change', function() {
                    aplicarLogoBanco(this);
                });
            }
            
            // Carregar bancos no select da página de configurações
            const selectBancoConfig = document.getElementById('select-banco-config');
            if (selectBancoConfig) {
                // Manter as opções padrão e adicionar os bancos criados pelo usuário
                const opcoesPadrao = `
                    <option value="">Selecione um banco</option>
                    <option value="Nubank" data-logo="nubank">Nubank</option>
                    <option value="Inter" data-logo="inter">Inter</option>
                    <option value="Bradesco" data-logo="bradesco">Bradesco</option>
                    <option value="Itaú" data-logo="itau">Itaú</option>
                    <option value="Santander" data-logo="santander">Santander</option>
                    <option value="Caixa Econômica Federal" data-logo="caixa">Caixa Econômica Federal</option>
                    <option value="Banco do Brasil" data-logo="bb">Banco do Brasil</option>
                    <option value="C6 Bank" data-logo="c6">C6 Bank</option>
                    <option value="PicPay" data-logo="picpay">PicPay</option>
                    <option value="Neon" data-logo="neon">Neon</option>
                `;
                
                selectBancoConfig.innerHTML = opcoesPadrao;
                
                // Adicionar bancos criados pelo usuário que não estão na lista padrão
                const bancosValidos = bancos.filter(banco => {
                    return banco && 
                           banco.nome && 
                           banco.nome !== 'undefined' && 
                           banco.id;
                });
                
                const bancosExistentes = ['Nubank', 'Inter', 'Bradesco', 'Itaú', 'Santander', 'Caixa Econômica Federal', 'Banco do Brasil', 'C6 Bank', 'PicPay', 'Neon'];
                
                bancosValidos.forEach(banco => {
                    if (!bancosExistentes.includes(banco.nome)) {
                        const option = document.createElement('option');
                        option.value = banco.nome;
                        option.textContent = banco.nome;
                        option.setAttribute('data-logo', obterLogoBanco(banco.nome));
                        selectBancoConfig.appendChild(option);
                    }
                });
            }
        }
        
        // Função para carregar contas baseadas no banco selecionado
        function carregarContas() {
            const bancoSelecionado = document.getElementById('bancoModal').value;
            const selectConta = document.getElementById('contaModal');
            selectConta.innerHTML = '<option value="">Selecione uma conta</option>';
            
            if (bancoSelecionado) {
                const banco = bancos.find(b => b.id == bancoSelecionado);
                if (banco && banco.contas) {
                    // Filtrar apenas contas válidas
                    const contasValidas = banco.contas.filter(conta => {
                        return conta && 
                               conta.numero && 
                               conta.numero !== 'undefined' && 
                               conta.tipo && 
                               conta.tipo !== 'undefined' && 
                               conta.id;
                    });
                    
                    contasValidas.forEach(conta => {
                        const option = document.createElement('option');
                        option.value = conta.id;
                        option.textContent = `${conta.numero} (${conta.tipo})`;
                        selectConta.appendChild(option);
                    });
                }
            }
        }
        
        // Função para carregar cartões no select
        function carregarCartoes() {
            const selectCartao = document.getElementById('cartaoModal');
            selectCartao.innerHTML = '<option value="">Selecione um cartão</option>';
            
            cartoes.forEach(cartao => {
                const option = document.createElement('option');
                option.value = cartao.id;
                option.textContent = `${cartao.nome} - ${cartao.banco}`;
                selectCartao.appendChild(option);
            });
        }
        
        // Função para mostrar/ocultar campo de cartão baseado no tipo de transação
        function configurarTipoTransacao() {
            const tipoTransacao = document.getElementById('tipoTransacao');
            const cartaoDiv = document.getElementById('cartaoDiv');
            const contaDestinoDiv = document.getElementById('contaDestinoDiv');
            
            tipoTransacao.addEventListener('change', function() {
                // Controle do campo de cartão de crédito
                if (this.value === 'credito') {
                    cartaoDiv.style.display = 'block';
                    document.getElementById('cartaoModal').required = true;
                } else {
                    cartaoDiv.style.display = 'none';
                    document.getElementById('cartaoModal').required = false;
                    document.getElementById('cartaoModal').value = '';
                }
                
                // Controle do campo de conta de destino
                if (this.value === 'transferencia_contas') {
                    contaDestinoDiv.style.display = 'block';
                    document.getElementById('contaDestino').required = true;
                } else {
                    contaDestinoDiv.style.display = 'none';
                    document.getElementById('contaDestino').required = false;
                    document.getElementById('contaDestino').value = '';
                }
            });
        }
        
        // Função para aplicar cores do banco no formulário
        function aplicarCorBancoFormulario() {
            const selectBanco = document.getElementById('select-banco-config');
            const formulario = document.getElementById('form-adicionar-banco');
            const bancoSelecionado = selectBanco.value;
            
            // Remover todas as classes de banco anteriores
            formulario.className = formulario.className.replace(/\bbanco-\w+/g, '');
            
            if (bancoSelecionado) {
                const bancoNormalizado = normalizarNomeBanco(bancoSelecionado);
                formulario.classList.add('banco-selecionado', `banco-${bancoNormalizado}`);
            } else {
                formulario.classList.remove('banco-selecionado');
            }
        }
        
        // Função para adicionar banco
        function adicionarBanco() {
            const nomeBanco = document.getElementById('select-banco-config').value.trim();
            const numeroConta = document.getElementById('nova-conta').value.trim();
            const tipoConta = document.getElementById('tipo-conta').value.trim();
            
            if (!nomeBanco || !numeroConta || !tipoConta) {
                alert('Por favor, preencha todos os campos do banco.');
                return;
            }
            
            // Verificar se o banco já existe
            let banco = bancos.find(b => b.nome === nomeBanco);
            
            if (!banco) {
                banco = {
                    id: Date.now(),
                    nome: nomeBanco,
                    contas: []
                };
                bancos.push(banco);
            }
            
            // Adicionar conta ao banco
            const novaConta = {
                id: Date.now() + Math.random(),
                numero: numeroConta,
                tipo: tipoConta
            };
            
            banco.contas.push(novaConta);
            
            // Salvar no localStorage usando a função centralizada
            salvarDados();
            
            // Limpar campos
            document.getElementById('select-banco-config').value = '';
            document.getElementById('nova-conta').value = '';
            document.getElementById('tipo-conta').value = '';
            
            // Remover cores do formulário
            const formulario = document.getElementById('form-adicionar-banco');
            formulario.className = formulario.className.replace(/\bbanco-\w+/g, '');
            formulario.classList.remove('banco-selecionado');
            
            // Atualizar tabela e selects
            carregarTabelaBancos();
            carregarBancos();
            
            alert('Banco e conta adicionados com sucesso!');
        }
        
        // Função para carregar tabela de bancos
        function carregarTabelaBancos() {
            const tbody = document.querySelector('#tabela-bancos tbody');
            tbody.innerHTML = '';
            
            // Filtrar e validar dados antes de exibir
            const bancosValidos = bancos.filter(banco => {
                return banco && 
                       banco.nome && 
                       banco.nome !== 'undefined' && 
                       banco.id && 
                       banco.contas && 
                       Array.isArray(banco.contas);
            });
            
            bancosValidos.forEach(banco => {
                // Filtrar contas válidas
                const contasValidas = banco.contas.filter(conta => {
                    return conta && 
                           conta.numero && 
                           conta.numero !== 'undefined' && 
                           conta.tipo && 
                           conta.tipo !== 'undefined' && 
                           conta.id;
                });
                
                contasValidas.forEach(conta => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${banco.nome}</td>
                        <td>${conta.numero}</td>
                        <td>${conta.tipo}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="excluirConta('${banco.id}', '${conta.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                });
            });
            
            // Se encontramos dados inválidos, limpar automaticamente
            if (bancos.length !== bancosValidos.length) {
                console.log('Dados inválidos encontrados, limpando automaticamente...');
                bancos = bancosValidos;
                salvarDados();
            }
        }
        
        // Função para limpar dados inválidos automaticamente
        function limparDadosInvalidos() {
            console.log('Iniciando limpeza de dados inválidos...');
            
            // Filtrar bancos válidos
            const bancosOriginais = bancos.length;
            bancos = bancos.filter(banco => {
                if (!banco || !banco.nome || banco.nome === 'undefined' || !banco.id) {
                    return false;
                }
                
                // Filtrar contas válidas dentro do banco
                if (banco.contas && Array.isArray(banco.contas)) {
                    banco.contas = banco.contas.filter(conta => {
                        return conta && 
                               conta.numero && 
                               conta.numero !== 'undefined' && 
                               conta.tipo && 
                               conta.tipo !== 'undefined' && 
                               conta.id;
                    });
                }
                
                return true;
            });
            
            // Remover bancos sem contas válidas
            bancos = bancos.filter(banco => banco.contas && banco.contas.length > 0);
            
            // Filtrar lançamentos válidos
            const lancamentosOriginais = lancamentos.length;
            lancamentos = lancamentos.filter(lancamento => {
                return lancamento && 
                       lancamento.banco && 
                       lancamento.banco !== 'undefined' && 
                       lancamento.conta && 
                       lancamento.conta !== 'undefined';
            });
            
            // Salvar dados limpos usando a função centralizada
            salvarDados();
            
            // Recarregar interfaces
            carregarTabelaBancos();
            carregarBancos();
            carregarLancamentos();
            carregarFluxoCaixa();
            
            const bancosRemovidos = bancosOriginais - bancos.length;
            const lancamentosRemovidos = lancamentosOriginais - lancamentos.length;
            
            if (bancosRemovidos > 0 || lancamentosRemovidos > 0) {
                alert(`Limpeza concluída!\n\nDados inválidos removidos:\n• ${bancosRemovidos} banco(s)/conta(s)\n• ${lancamentosRemovidos} lançamento(s)`);
            }
        }
        
        // Função para excluir conta
        function excluirConta(bancoId, contaId) {
            // Validar parâmetros
            if (!bancoId || !contaId || bancoId === 'undefined' || contaId === 'undefined') {
                alert('Erro: Dados da conta inválidos. A conta será removida automaticamente.');
                // Limpar dados inválidos e recarregar
                limparDadosInvalidos();
                return;
            }
            
            // Verificar se existem lançamentos vinculados a esta conta
            const lancamentosVinculados = lancamentos.filter(l => l.banco == bancoId && l.conta == contaId);
            
            if (lancamentosVinculados.length > 0) {
                const confirmarExclusao = confirm(
                    `Esta conta possui ${lancamentosVinculados.length} lançamento(s) vinculado(s).\n\n` +
                    `Se você excluir a conta, todos os lançamentos vinculados também serão removidos.\n\n` +
                    `Deseja continuar com a exclusão?`
                );
                
                if (!confirmarExclusao) {
                    return;
                }
                
                // Remover todos os lançamentos vinculados
                lancamentos = lancamentos.filter(l => !(l.banco == bancoId && l.conta == contaId));
                const userPrefix = localStorage.getItem('currentUser') || 'default';
                localStorage.setItem(`${userPrefix}Lancamentos`, JSON.stringify(lancamentos));
            } else {
                if (!confirm('Tem certeza que deseja excluir esta conta?')) {
                    return;
                }
            }
            
            const banco = bancos.find(b => b.id == bancoId);
            if (banco) {
                banco.contas = banco.contas.filter(c => c.id != contaId);
                
                // Se o banco não tem mais contas, remover o banco
                if (banco.contas.length === 0) {
                    bancos = bancos.filter(b => b.id != bancoId);
                }
                
                salvarDados();
                carregarTabelaBancos();
                carregarBancos();
                
                // Recarregar a página inicial se estivermos nela
                if (document.getElementById('inicio').style.display !== 'none') {
                    carregarLancamentos();
                    carregarFluxoCaixa();
                }
                
                alert('Conta excluída com sucesso!');
            }
        }
        
        // Função para adicionar cartão
        function adicionarCartao() {
            const nomeCartao = document.getElementById('novo-cartao').value.trim();
            const bancoCartao = document.getElementById('banco-cartao').value.trim();
            const limiteCartao = parseFloat(document.getElementById('limite-cartao').value);
            
            if (!nomeCartao || !bancoCartao || !limiteCartao) {
                alert('Por favor, preencha todos os campos do cartão.');
                return;
            }
            
            const novoCartao = {
                id: Date.now(),
                nome: nomeCartao,
                banco: bancoCartao,
                limite: limiteCartao,
                usado: 0
            };
            
            cartoes.push(novoCartao);
            salvarDados();
            
            // Limpar campos
            document.getElementById('novo-cartao').value = '';
            document.getElementById('banco-cartao').value = '';
            document.getElementById('limite-cartao').value = '';
            
            // Atualizar tabela e selects
            carregarTabelaCartoes();
            carregarCartoes();
            
            alert('Cartão adicionado com sucesso!');
        }
        
        // Função para carregar tabela de cartões
        function carregarTabelaCartoes() {
            const tbody = document.querySelector('#tabela-cartoes tbody');
            tbody.innerHTML = '';
            
            cartoes.forEach(cartao => {
                const disponivel = cartao.limite - cartao.usado;
                const percentualUsado = (cartao.usado / cartao.limite) * 100;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${cartao.nome}</td>
                    <td>${cartao.banco}</td>
                    <td>R$ ${cartao.limite.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>R$ ${cartao.usado.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>
                        <span class="${disponivel < cartao.limite * 0.1 ? 'text-danger' : disponivel < cartao.limite * 0.3 ? 'text-warning' : 'text-success'}">
                            R$ ${disponivel.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                        </span>
                        <div class="progress mt-1" style="height: 5px;">
                            <div class="progress-bar ${percentualUsado > 90 ? 'bg-danger' : percentualUsado > 70 ? 'bg-warning' : 'bg-success'}" 
                                 style="width: ${percentualUsado}%"></div>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="excluirCartao('${cartao.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        // Função para excluir cartão
        function excluirCartao(cartaoId) {
            if (confirm('Tem certeza que deseja excluir este cartão?')) {
                cartoes = cartoes.filter(c => c.id != cartaoId);
                salvarDados();
                carregarTabelaCartoes();
                carregarCartoes();
            }
        }
        
        // Função para atualizar limite do cartão
        function atualizarLimiteCartao(cartaoId, valor, operacao) {
            const cartao = cartoes.find(c => c.id == cartaoId);
            if (cartao) {
                if (operacao === 'subtrair') {
                    cartao.usado += valor;
                } else if (operacao === 'adicionar') {
                    cartao.usado -= valor;
                }
                
                // Garantir que o usado não seja negativo
                cartao.usado = Math.max(0, cartao.usado);
                
                salvarDados();
                carregarTabelaCartoes();
            }
        }
        
        // Event listeners para bancos e cartões
        document.getElementById('adicionar-banco').addEventListener('click', adicionarBanco);
        document.getElementById('adicionar-cartao').addEventListener('click', adicionarCartao);
        document.getElementById('bancoModal').addEventListener('change', carregarContas);
        
        // Configurar tipo de transação
        configurarTipoTransacao();
        
        // Função para atualizar dashboard de cartões
        function atualizarDashboardCartoes() {
            const cartoesSection = document.getElementById('cartoes-section');
            const cartoesDashboard = document.getElementById('cartoes-dashboard');
            
            if (!cartoes || cartoes.length === 0) {
                cartoesSection.style.display = 'none';
                return;
            }
            
            cartoesSection.style.display = 'block';
            cartoesDashboard.innerHTML = '';
            
            cartoes.forEach(cartao => {
                const percentualUsado = (cartao.usado / cartao.limite) * 100;
                const limiteDisponivel = cartao.limite - cartao.usado;
                
                let corBarra = 'bg-success';
                if (percentualUsado > 80) {
                    corBarra = 'bg-danger';
                } else if (percentualUsado > 60) {
                    corBarra = 'bg-warning';
                }
                
                const cartaoCard = document.createElement('div');
                cartaoCard.className = 'col-md-4 mb-3';
                cartaoCard.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-credit-card me-1"></i>
                                    ${cartao.nome}
                                </h6>
                                <small class="text-muted">${cartao.bandeira}</small>
                            </div>
                            
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <small>Usado: ${cartao.usado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</small>
                                    <small>Limite: ${cartao.limite.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</small>
                                </div>
                                <div class="progress mt-1" style="height: 8px;">
                                    <div class="progress-bar ${corBarra}" role="progressbar" 
                                         style="width: ${percentualUsado}%" 
                                         aria-valuenow="${percentualUsado}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <h5 class="mb-0 ${limiteDisponivel >= 0 ? 'text-success' : 'text-danger'}">
                                    ${limiteDisponivel.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                                </h5>
                                <small class="text-muted">Disponível</small>
                            </div>
                        </div>
                    </div>
                `;
                
                cartoesDashboard.appendChild(cartaoCard);
            });
        }
        
        // ===== FUNÇÕES DE INVESTIMENTOS =====
        
        // Funções para gerenciar ativos
        function carregarAtivos() {
            const ativoSelect = document.getElementById('ativo-select');
            if (!ativoSelect) return;
            
            // Limpar opções existentes (exceto as padrão)
            ativoSelect.innerHTML = `
                <option value="">Selecione um ativo</option>
                <option value="novo">+ Cadastrar novo ativo</option>
            `;
            
            // Adicionar ativos cadastrados
            ativos.forEach(ativo => {
                const option = document.createElement('option');
                option.value = ativo;
                option.textContent = ativo;
                ativoSelect.appendChild(option);
            });
        }
        
        function selecionarAtivo() {
            const ativoSelect = document.getElementById('ativo-select');
            const ativoInput = document.getElementById('ativo');
            
            if (ativoSelect.value === 'novo') {
                // Mostrar campo de input para novo ativo
                ativoSelect.classList.add('d-none');
                ativoInput.classList.remove('d-none');
                ativoInput.focus();
            } else if (ativoSelect.value) {
                // Ativo selecionado da lista
                ativoInput.value = ativoSelect.value;
            }
        }
        
        function adicionarNovoAtivo(ticker) {
            if (ticker && !ativos.includes(ticker.toUpperCase())) {
                ativos.push(ticker.toUpperCase());
                salvarDados();
                carregarAtivos();
            }
        }
        
        // Funções para gerenciar corretoras
        function carregarCorretoras() {
            const corretoraSelect = document.getElementById('corretora-select');
            if (!corretoraSelect) return;
            
            // Limpar opções existentes (exceto as padrão)
            corretoraSelect.innerHTML = `
                <option value="">Selecione uma corretora</option>
                <option value="nova">+ Cadastrar nova corretora</option>
            `;
            
            // Adicionar corretoras cadastradas
            corretoras.forEach(corretora => {
                const option = document.createElement('option');
                option.value = corretora;
                option.textContent = corretora;
                corretoraSelect.appendChild(option);
            });
        }
        
        function selecionarCorretora() {
            const corretoraSelect = document.getElementById('corretora-select');
            const corretoraInput = document.getElementById('corretora');
            
            if (corretoraSelect.value === 'nova') {
                // Mostrar campo de input para nova corretora
                corretoraSelect.classList.add('d-none');
                corretoraInput.classList.remove('d-none');
                corretoraInput.focus();
            } else if (corretoraSelect.value) {
                // Corretora selecionada da lista
                corretoraInput.value = corretoraSelect.value;
            }
        }
        
        function adicionarNovaCorretora(nome) {
            if (nome && !corretoras.includes(nome)) {
                corretoras.push(nome);
                salvarDados();
                carregarCorretoras();
            }
        }
        
        function carregarInvestimentos() {
            atualizarTabelaInvestimentos();
            atualizarTabelaDividendos();
            atualizarDashboardInvestimentos();
            atualizarResumoAtivos();
            carregarAtivos();
            carregarCorretoras();
        }
        
        function salvarInvestimento() {
            const ativo = document.getElementById('ativo').value.trim().toUpperCase();
            const categoria = document.getElementById('categoria-investimento').value;
            const corretora = document.getElementById('corretora').value.trim();
            const data = document.getElementById('data-compra').value;
            const tipoLancamento = document.getElementById('tipo-lancamento').value;
            
            let quantidade, preco, valorTotal, percentualCdi;
            
            if (categoria === 'renda-fixa') {
                // Para renda fixa: usar valor investido e % do CDI
                const valorInvestido = parseFloat(document.getElementById('valor-investido').value);
                percentualCdi = parseFloat(document.getElementById('percentual-cdi').value);
                
                if (!ativo || !categoria || !corretora || !valorInvestido || !percentualCdi || !data || !tipoLancamento) {
                    alert('Por favor, preencha todos os campos!');
                    return;
                }
                
                if (isNaN(valorInvestido) || valorInvestido <= 0) {
                    alert('Valor investido deve ser um número positivo!');
                    return;
                }
                
                if (isNaN(percentualCdi) || percentualCdi <= 0) {
                    alert('Percentual do CDI deve ser um número positivo!');
                    return;
                }
                
                // Para renda fixa: quantidade = 1 (representa o investimento), preço = valor investido
                quantidade = 1;
                preco = valorInvestido;
                valorTotal = valorInvestido;
                
            } else if (categoria === 'criptomoedas') {
                // Para criptomoedas: usar valor investido e cotação
                const valorInvestido = parseFloat(document.getElementById('valor-investido').value);
                const cotacaoCompra = parseFloat(document.getElementById('cotacao-compra').value);
                
                if (!ativo || !categoria || !corretora || !valorInvestido || !cotacaoCompra || !data || !tipoLancamento) {
                    alert('Por favor, preencha todos os campos!');
                    return;
                }
                
                if (isNaN(valorInvestido) || valorInvestido <= 0) {
                    alert('Valor investido deve ser um número positivo!');
                    return;
                }
                
                if (isNaN(cotacaoCompra) || cotacaoCompra <= 0) {
                    alert('Cotação na compra deve ser um número positivo!');
                    return;
                }
                
                // Calcular quantidade baseada no valor investido
                quantidade = valorInvestido / cotacaoCompra;
                preco = cotacaoCompra;
                valorTotal = valorInvestido;
                
            } else {
                // Para outros investimentos: usar quantidade e preço unitário
                quantidade = parseFloat(document.getElementById('quantidade').value);
                preco = parseFloat(document.getElementById('preco-compra').value);
                
                if (!ativo || !categoria || !corretora || !quantidade || !preco || !data || !tipoLancamento) {
                    alert('Por favor, preencha todos os campos!');
                    return;
                }
                
                if (isNaN(quantidade) || quantidade <= 0) {
                    alert('Quantidade deve ser um número positivo!');
                    return;
                }
                
                if (isNaN(preco) || preco <= 0) {
                    alert('Preço deve ser um número positivo!');
                    return;
                }
                
                valorTotal = quantidade * preco;
            }
            
            // Adicionar novo ativo se não existir
            adicionarNovoAtivo(ativo);
            
            // Adicionar nova corretora se não existir
            adicionarNovaCorretora(corretora);
            
            if (modoEdicaoInvestimento) {
                // Editar investimento existente
                const index = investimentos.findIndex(inv => inv.id === parseInt(document.getElementById('investimentoId').value));
                if (index !== -1) {
                    const investimentoAtualizado = {
                        ...investimentos[index],
                        ativo,
                        categoria,
                        corretora,
                        quantidade,
                        preco,
                        data,
                        tipoLancamento,
                        valorTotal
                    };
                    
                    // Adicionar percentualCdi apenas para renda fixa
                    if (categoria === 'renda-fixa') {
                        investimentoAtualizado.percentualCdi = percentualCdi;
                    }
                    
                    investimentos[index] = investimentoAtualizado;
                }
            } else {
                // Adicionar novo lançamento de investimento
                const novoInvestimento = {
                    id: nextInvestimentoId++,
                    ativo,
                    categoria,
                    corretora,
                    quantidade,
                    preco,
                    data,
                    tipoLancamento,
                    valorTotal
                };
                
                // Adicionar percentualCdi apenas para renda fixa
                if (categoria === 'renda-fixa') {
                    novoInvestimento.percentualCdi = percentualCdi;
                }
                
                investimentos.push(novoInvestimento);
            }
            
            // Salvar dados
            salvarDados();
            
            // Fechar modal e limpar formulário
            const modal = bootstrap.Modal.getInstance(document.getElementById('investimentoModal'));
            modal.hide();
            limparFormularioInvestimento();
            
            // Atualizar tabela e dashboard
            atualizarTabelaInvestimentos();
            atualizarDashboardInvestimentos();
            atualizarResumoAtivos();
        }
        
        function salvarDividendo() {
            const ativo = document.getElementById('ativo-dividendo').value.trim();
            const valor = parseFloat(document.getElementById('valor-dividendo').value);
            const data = document.getElementById('data-dividendo').value;
            const tipo = document.getElementById('tipo-rendimento').value;
            
            if (!ativo || !valor || !data || !tipo) {
                alert('Por favor, preencha todos os campos!');
                return;
            }
            
            if (isNaN(valor) || valor <= 0) {
                alert('Valor deve ser um número positivo!');
                return;
            }
            
            const novoDividendo = {
                id: nextDividendoId++,
                ativo,
                valor,
                data,
                tipo
            };
            
            dividendos.push(novoDividendo);
            
            // Salvar dados
            salvarDados();
            
            // Fechar modal e limpar formulário
            const modal = bootstrap.Modal.getInstance(document.getElementById('dividendoModal'));
            modal.hide();
            limparFormularioDividendo();
            
            // Atualizar tabela e dashboard
            atualizarTabelaDividendos();
            atualizarDashboardInvestimentos();
        }
        
        

        
        function atualizarTabelaInvestimentos() {
            const tbody = document.getElementById('tabela-investimentos').querySelector('tbody');
            tbody.innerHTML = '';
            
            if (investimentos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">
                            <p>Nenhum lançamento cadastrado. Clique em "Novo Lançamento" para começar.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Filtrar investimentos
            const filtroCategoria = document.getElementById('filtro-categoria-investimento')?.value || '';
            const filtroTipoLancamento = document.getElementById('filtro-tipo-lancamento')?.value || '';
            const filtroCorretora = document.getElementById('filtro-corretora-investimento')?.value || '';
            const filtroDataInicio = document.getElementById('filtro-data-inicio')?.value || '';
            const filtroDataFim = document.getElementById('filtro-data-fim')?.value || '';
            
            let investimentosFiltrados = investimentos.filter(inv => {
                const categoriaMatch = !filtroCategoria || inv.categoria === filtroCategoria;
                const tipoLancamentoMatch = !filtroTipoLancamento || inv.tipoLancamento === filtroTipoLancamento;
                const corretoraMatch = !filtroCorretora || inv.corretora.toLowerCase().includes(filtroCorretora.toLowerCase());
                
                // Filtro de data
                let dataMatch = true;
                if (filtroDataInicio || filtroDataFim) {
                    const dataInvestimento = new Date(inv.data);
                    if (filtroDataInicio) {
                        const dataInicio = new Date(filtroDataInicio);
                        dataMatch = dataMatch && dataInvestimento >= dataInicio;
                    }
                    if (filtroDataFim) {
                        const dataFim = new Date(filtroDataFim);
                        dataMatch = dataMatch && dataInvestimento <= dataFim;
                    }
                }
                
                return categoriaMatch && tipoLancamentoMatch && corretoraMatch && dataMatch;
            });
            
            investimentosFiltrados.forEach(investimento => {
                // Obter dados do ativo para preço médio e valorização
                const dadosAtivo = obterDadosAtivo(investimento.ativo);
                
                // Formatação da valorização
                let valorizacaoHtml = '';
                if (dadosAtivo.valorizacao.percentual !== 0) {
                    const cor = dadosAtivo.valorizacao.percentual > 0 ? 'text-success' : 'text-danger';
                    const sinal = dadosAtivo.valorizacao.percentual > 0 ? '+' : '';
                    valorizacaoHtml = `
                        <span class="${cor}">
                            ${sinal}${dadosAtivo.valorizacao.percentual.toFixed(2)}%<br>
                            <small>${sinal}${dadosAtivo.valorizacao.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</small>
                        </span>
                    `;
                } else {
                    valorizacaoHtml = '<span class="text-muted">-</span>';
                }
                
                const row = document.createElement('tr');
                // Corrigir problema de fuso horário para data do investimento
                const partesDataInv = investimento.data.split('-');
                const dataInvLocal = new Date(partesDataInv[0], partesDataInv[1] - 1, partesDataInv[2]);
                
                // Para renda fixa, exibir informações específicas
                let quantidadeDisplay = investimento.quantidade.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                let precoDisplay = investimento.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                if (investimento.categoria === 'renda-fixa') {
                    quantidadeDisplay = `Valor Investido`;
                    precoDisplay = `${investimento.percentualCdi || 100}% CDI`;
                }
                
                row.innerHTML = `
                    <td>${investimento.ativo}</td>
                    <td>${dataInvLocal.toLocaleDateString('pt-BR')}</td>
                    <td><span class="badge bg-primary">${investimento.categoria}</span></td>
                    <td>${investimento.corretora}</td>
                    <td>${quantidadeDisplay}</td>
                    <td>${precoDisplay}</td>
                    <td>${investimento.valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td><span class="badge ${investimento.tipoLancamento === 'compra' ? 'bg-success' : 'bg-danger'}">${investimento.tipoLancamento === 'compra' ? 'Compra' : 'Venda'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editarInvestimento(${investimento.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmarExclusaoInvestimento(${investimento.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function atualizarTabelaDividendos() {
            const tbody = document.getElementById('tabela-dividendos').querySelector('tbody');
            tbody.innerHTML = '';
            
            // Verificar se há dividendos cadastrados
            if (dividendos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <p>Nenhum dividendo/rendimento cadastrado.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Obter valores dos filtros
            const filtroCorretora = document.getElementById('filtro-corretora-investimento').value.toLowerCase();
            const filtroDataInicio = document.getElementById('filtro-data-inicio').value;
            const filtroDataFim = document.getElementById('filtro-data-fim').value;
            
            // Filtrar dividendos
            const dividendosFiltrados = dividendos.filter(dividendo => {
                // Filtro por corretora (verificar se o ativo está em algum investimento da corretora)
                let corretoraMatch = true;
                if (filtroCorretora && filtroCorretora.trim() !== '') {
                    const investimentosDoAtivo = investimentos.filter(inv => inv.ativo === dividendo.ativo);
                    if (investimentosDoAtivo.length > 0) {
                        corretoraMatch = investimentosDoAtivo.some(inv => 
                            inv.corretora.toLowerCase().includes(filtroCorretora)
                        );
                    } else {
                        // Se não há investimentos do ativo, não mostrar o dividendo quando há filtro de corretora
                        corretoraMatch = false;
                    }
                }
                
                // Filtro por data
                let dataMatch = true;
                if (filtroDataInicio || filtroDataFim) {
                    const dataDividendo = new Date(dividendo.data);
                    if (filtroDataInicio && filtroDataInicio.trim() !== '') {
                        const dataInicio = new Date(filtroDataInicio);
                        dataMatch = dataMatch && dataDividendo >= dataInicio;
                    }
                    if (filtroDataFim && filtroDataFim.trim() !== '') {
                        const dataFim = new Date(filtroDataFim);
                        dataMatch = dataMatch && dataDividendo <= dataFim;
                    }
                }
                
                return corretoraMatch && dataMatch;
            });
            
            if (dividendosFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <p>Nenhum dividendo/rendimento encontrado com os filtros aplicados.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar dividendos por data (mais recente primeiro)
            const dividendosOrdenados = [...dividendosFiltrados].sort((a, b) => new Date(b.data) - new Date(a.data));
            
            dividendosOrdenados.forEach(dividendo => {
                // Corrigir problema de fuso horário para data do dividendo
                const partesDataDiv = dividendo.data.split('-');
                const dataDivLocal = new Date(partesDataDiv[0], partesDataDiv[1] - 1, partesDataDiv[2]);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dataDivLocal.toLocaleDateString('pt-BR')}</td>
                    <td>${dividendo.ativo}</td>
                    <td><span class="badge bg-info">${dividendo.tipo}</span></td>
                    <td>${dividendo.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirDividendo(${dividendo.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function atualizarResumoAtivos() {
            // Calcular resumo de renda variável, criptomoedas e renda fixa
            const tbodyRendaVariavel = document.getElementById('tabela-resumo-renda-variavel').querySelector('tbody');
            const tbodyRendaFixa = document.getElementById('tabela-resumo-renda-fixa').querySelector('tbody');
            const tbodyCriptomoedas = document.getElementById('tabela-resumo-criptomoedas').querySelector('tbody');
            
            tbodyRendaVariavel.innerHTML = '';
            tbodyRendaFixa.innerHTML = '';
            tbodyCriptomoedas.innerHTML = '';
            
            // Agrupar investimentos por ativo
            const resumoAtivos = {};
            
            investimentos.forEach(inv => {
                if (!resumoAtivos[inv.ativo]) {
                    resumoAtivos[inv.ativo] = {
                        ativo: inv.ativo,
                        categoria: inv.categoria,
                        quantidade: 0,
                        valorTotal: 0,
                        dividendos: 0
                    };
                }
                
                if (inv.tipoLancamento === 'compra') {
                    resumoAtivos[inv.ativo].quantidade += inv.quantidade;
                    resumoAtivos[inv.ativo].valorTotal += inv.valorTotal;
                } else {
                    resumoAtivos[inv.ativo].quantidade -= inv.quantidade;
                    resumoAtivos[inv.ativo].valorTotal -= inv.valorTotal;
                }
            });
            
            // Calcular dividendos por ativo
            dividendos.forEach(div => {
                if (resumoAtivos[div.ativo]) {
                    resumoAtivos[div.ativo].dividendos += div.valor;
                }
            });
            
            // Separar por categoria
            const rendaVariavel = [];
            const rendaFixa = [];
            const criptomoedas = [];
            
            Object.values(resumoAtivos).forEach(ativo => {
                if (ativo.quantidade > 0) { // Só mostrar ativos com quantidade positiva
                    if (ativo.categoria === 'renda-fixa') {
                        rendaFixa.push(ativo);
                    } else if (ativo.categoria === 'criptomoedas') {
                        criptomoedas.push(ativo);
                    } else {
                        rendaVariavel.push(ativo);
                    }
                }
            });
            
            // Preencher tabela de renda variável
            if (rendaVariavel.length === 0) {
                tbodyRendaVariavel.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">Nenhum ativo de renda variável</td>
                    </tr>
                `;
            } else {
                rendaVariavel.forEach(ativo => {
                    // Obter dados do ativo para preço médio e valorização
                    const dadosAtivo = obterDadosAtivo(ativo.ativo);
                    
                    // Formatação da valorização
                    let valorizacaoHtml = '';
                    if (dadosAtivo.valorizacao.percentual !== 0) {
                        const cor = dadosAtivo.valorizacao.percentual > 0 ? 'text-success' : 'text-danger';
                        const sinal = dadosAtivo.valorizacao.percentual > 0 ? '+' : '';
                        valorizacaoHtml = `
                            <span class="${cor}">
                                ${sinal}${dadosAtivo.valorizacao.percentual.toFixed(2)}%
                            </span>
                        `;
                    } else {
                        valorizacaoHtml = '<span class="text-muted">-</span>';
                    }
                    
                    // Calcular total geral: valor atual (com valorização) + dividendos
                    const valorAtual = dadosAtivo.precoAtual > 0 ? ativo.quantidade * dadosAtivo.precoAtual : ativo.valorTotal;
                    const totalGeral = valorAtual + ativo.dividendos;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${ativo.ativo}</strong></td>
                        <td>${ativo.quantidade.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>${ativo.valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td>${dadosAtivo.precoMedio > 0 ? dadosAtivo.precoMedio.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '<span class="text-muted">-</span>'}</td>
                        <td>${dadosAtivo.precoAtual > 0 ? dadosAtivo.precoAtual.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '<span class="text-muted">-</span>'}</td>
                        <td>${valorizacaoHtml}</td>
                        <td class="text-success">${ativo.dividendos.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td><strong>${totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></td>
                    `;
                    tbodyRendaVariavel.appendChild(row);
                });
            }
            
            // Preencher tabela de criptomoedas
            if (criptomoedas.length === 0) {
                tbodyCriptomoedas.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">Nenhuma criptomoeda</td>
                    </tr>
                `;
            } else {
                criptomoedas.forEach(ativo => {
                    // Obter dados do ativo para preço médio e valorização
                    const dadosAtivo = obterDadosAtivo(ativo.ativo);
                    
                    // Formatação da valorização
                    let valorizacaoHtml = '';
                    if (dadosAtivo.valorizacao.percentual !== 0) {
                        const cor = dadosAtivo.valorizacao.percentual > 0 ? 'text-success' : 'text-danger';
                        const sinal = dadosAtivo.valorizacao.percentual > 0 ? '+' : '';
                        valorizacaoHtml = `
                            <span class="${cor}">
                                ${sinal}${dadosAtivo.valorizacao.percentual.toFixed(2)}%
                            </span>
                        `;
                    } else {
                        valorizacaoHtml = '<span class="text-muted">-</span>';
                    }
                    
                    // Calcular total geral: valor investido + valorização
                    const valorAtual = dadosAtivo.precoAtual > 0 ? ativo.quantidade * dadosAtivo.precoAtual : ativo.valorTotal;
                    const totalGeral = valorAtual;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${ativo.ativo}</strong></td>
                        <td>${ativo.quantidade.toLocaleString('pt-BR', { minimumFractionDigits: 8 })}</td>
                        <td>${ativo.valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td>${dadosAtivo.precoMedio > 0 ? dadosAtivo.precoMedio.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '<span class="text-muted">-</span>'}</td>
                        <td>${dadosAtivo.precoAtual > 0 ? dadosAtivo.precoAtual.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '<span class="text-muted">-</span>'}</td>
                        <td>${valorizacaoHtml}</td>
                        <td><strong>${totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></td>
                    `;
                    tbodyCriptomoedas.appendChild(row);
                });
            }
            
            // Preencher tabela de renda fixa
            if (rendaFixa.length === 0) {
                tbodyRendaFixa.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">Nenhum ativo de renda fixa</td>
                    </tr>
                `;
            } else {
                rendaFixa.forEach(ativo => {
                    const totalGeral = ativo.valorTotal + ativo.dividendos;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${ativo.ativo}</strong></td>
                        <td>${ativo.quantidade.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>${ativo.valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td class="text-success">${ativo.dividendos.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td><strong>${totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></td>
                    `;
                    tbodyRendaFixa.appendChild(row);
                });
            }
        }
        
        function atualizarDashboardInvestimentos() {
            // Calcular totais
            const valorTotalInvestido = investimentos.reduce((total, inv) => total + inv.valorTotal, 0);
            const totalDividendos = dividendos.reduce((total, div) => total + div.valor, 0);

            const totalAtivos = investimentos.length;
            
            // Calcular distribuição por categoria
            const distribuicaoPorCategoria = {};
            investimentos.forEach(inv => {
                if (!distribuicaoPorCategoria[inv.categoria]) {
                    distribuicaoPorCategoria[inv.categoria] = 0;
                }
                distribuicaoPorCategoria[inv.categoria] += inv.valorTotal;
            });
            
            // Calcular valor atual da carteira (baseado no preço médio pago)
            const resumoAtivos = {};
            investimentos.forEach(inv => {
                if (!resumoAtivos[inv.ativo]) {
                    resumoAtivos[inv.ativo] = {
                        quantidade: 0,
                        valorTotal: 0
                    };
                }
                
                if (inv.tipoLancamento === 'compra') {
                    resumoAtivos[inv.ativo].quantidade += inv.quantidade;
                    resumoAtivos[inv.ativo].valorTotal += inv.valorTotal;
                } else {
                    resumoAtivos[inv.ativo].quantidade -= inv.quantidade;
                    resumoAtivos[inv.ativo].valorTotal -= inv.valorTotal;
                }
            });
            
            // Calcular valor atual baseado na quantidade atual e cotação da API (ou preço médio como fallback)
            let valorAtualCarteira = 0;
            let temCotacoesAtualizadas = false;
            const cotacoes = carregarCotacoes();
            
            Object.entries(resumoAtivos).forEach(([nomeAtivo, ativo]) => {
                if (ativo.quantidade > 0) {
                    // Verificar se é renda fixa para calcular rendimento baseado no CDI
                    const investimentosDoAtivo = investimentos.filter(inv => inv.ativo === nomeAtivo);
                    const isRendaFixa = investimentosDoAtivo.some(inv => inv.categoria === 'renda-fixa');
                    
                    if (isRendaFixa) {
                        // Para renda fixa, usar valor investido + rendimentos manuais
                        let valorAtualRendaFixa = 0;
                        investimentosDoAtivo.forEach(inv => {
                            if (inv.categoria === 'renda-fixa' && inv.tipoLancamento === 'compra') {
                                valorAtualRendaFixa += inv.valorTotal;
                            }
                        });
                        
                        // Não somar rendimentos aqui para evitar duplicação
                        // Os rendimentos de RF são contabilizados separadamente nos dividendos
                        
                        valorAtualCarteira += valorAtualRendaFixa;
                    } else {
                        // Para outros ativos, usar cotação da API ou preço médio
                        const precoMedio = ativo.valorTotal / ativo.quantidade;
                        const precoAtual = obterPrecoAtual(nomeAtivo, precoMedio);
                        
                        // Verificar se há cotação atualizada para este ativo
                        if (cotacoes[nomeAtivo] && cotacoes[nomeAtivo].preco) {
                            temCotacoesAtualizadas = true;
                        }
                        
                        valorAtualCarteira += ativo.quantidade * precoAtual;
                    }
                }
            });
            
            // Atualizar cards do dashboard de investimentos (se existirem)
            const totalInvestidoEl = document.getElementById('total-investido');
            const totalDividendosEl = document.getElementById('total-dividendos');
            const totalAtivosEl = document.getElementById('total-ativos');
            const rendimentoTotalEl = document.getElementById('rendimento-total');
            const valorAtualEl = document.getElementById('valor-atual-investimentos');
            
            if (totalInvestidoEl) {
                totalInvestidoEl.textContent = valorTotalInvestido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            if (totalDividendosEl) {
                totalDividendosEl.textContent = totalDividendos.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            if (totalAtivosEl) {
                totalAtivosEl.textContent = totalAtivos;
            }
            if (valorAtualEl) {
                valorAtualEl.textContent = valorAtualCarteira.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            
            // Calcular rendimento (apenas valorização) e rentabilidade total (valorização + dividendos)
            let ganhoCapital = 0;
            let rendimentoTotal = 0;
            let rendimentoPercentual = 0;
            
            if (temCotacoesAtualizadas) {
                // Se há cotações atualizadas, calcular ganho de capital
                ganhoCapital = valorAtualCarteira - valorTotalInvestido;
                // Rendimento = apenas valorização (ganho de capital)
                rendimentoTotal = ganhoCapital;
                // Rentabilidade = valorização + dividendos
                const rentabilidadeTotal = ganhoCapital + totalDividendos;
                rendimentoPercentual = valorTotalInvestido > 0 ? (rentabilidadeTotal / valorTotalInvestido) * 100 : 0;
            } else {
                // Se não há cotações atualizadas, rendimento é zero (sem valorização conhecida)
                rendimentoTotal = 0;
                // Rentabilidade considera apenas dividendos
                rendimentoPercentual = valorTotalInvestido > 0 ? (totalDividendos / valorTotalInvestido) * 100 : 0;
            }
            
            if (rendimentoTotalEl) {
                rendimentoTotalEl.textContent = rendimentoTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                // Aplicar cor baseada no valor do rendimento
                rendimentoTotalEl.className = rendimentoTotal >= 0 ? 'text-info' : 'text-danger';
            }
            
            // Atualizar quadro de dividendos na página de investimentos
            const totalDividendosCardEl = document.getElementById('total-dividendos-card');
            if (totalDividendosCardEl) {
                totalDividendosCardEl.textContent = totalDividendos.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                // Aplicar cor baseada no valor dos dividendos
                totalDividendosCardEl.className = totalDividendos >= 0 ? 'text-secondary' : 'text-danger';
            }
            
            // Atualizar quadro rentabilidade na página de investimentos
            const rentabilidadeCompletaEl = document.getElementById('rentabilidade-completa');
            
            if (rentabilidadeCompletaEl) {
                // Calcular valor total da rentabilidade (valorização + dividendos)
                const rentabilidadeValorTotal = temCotacoesAtualizadas ? (ganhoCapital + totalDividendos) : totalDividendos;
                const valorFormatado = rentabilidadeValorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const percentualFormatado = rendimentoPercentual.toFixed(2);
                
                rentabilidadeCompletaEl.textContent = `${valorFormatado} (${percentualFormatado}%)`;
                // Aplicar cor baseada na rentabilidade
                rentabilidadeCompletaEl.className = rentabilidadeValorTotal >= 0 ? 'text-warning' : 'text-danger';
            }
            
            // Atualizar cards do dashboard principal (se existirem)
            const totalInvestidoMainEl = document.getElementById('total-investido-main');
            const patrimonioTotalEl = document.getElementById('patrimonio-total');
            const dividendosTotalEl = document.getElementById('dividendos-total');
            const rentabilidadeTotalEl = document.getElementById('rentabilidade-total');
            const totalAtivosMainEl = document.getElementById('total-ativos');
            
            if (totalInvestidoMainEl) {
                totalInvestidoMainEl.textContent = valorTotalInvestido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            if (patrimonioTotalEl) {
                patrimonioTotalEl.textContent = valorAtualCarteira.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            if (dividendosTotalEl) {
                dividendosTotalEl.textContent = totalDividendos.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            if (rentabilidadeTotalEl) {
                rentabilidadeTotalEl.textContent = `${rendimentoPercentual.toFixed(2)}%`;
                // Aplicar cor baseada na rentabilidade
                rentabilidadeTotalEl.className = rendimentoPercentual >= 0 ? 'mb-0 text-success' : 'mb-0 text-danger';
            }
            if (totalAtivosMainEl && !totalAtivosEl) { // Evitar conflito se ambos existirem
                totalAtivosMainEl.textContent = totalAtivos;
            }
            
            // Mostrar/ocultar seção de investimentos no dashboard principal
            const investimentosSection = document.getElementById('investimentos-section');
            if (investimentosSection) {
                investimentosSection.style.display = investimentos.length > 0 ? 'block' : 'none';
            }
        }
        
        function editarInvestimento(id) {
            const investimento = investimentos.find(inv => inv.id === id);
            if (!investimento) return;
            
            // Preencher formulário
            document.getElementById('investimentoId').value = investimento.id;
            document.getElementById('ativo').value = investimento.ativo;
            document.getElementById('categoria-investimento').value = investimento.categoria;
            document.getElementById('corretora').value = investimento.corretora;
            document.getElementById('data-compra').value = investimento.data;
            document.getElementById('tipo-lancamento').value = investimento.tipoLancamento || 'compra';
            
            // Verificar categoria e preencher campos apropriados
            if (investimento.categoria === 'criptomoedas') {
                // Para criptomoedas: calcular valor investido e mostrar cotação
                const valorInvestido = investimento.quantidade * investimento.preco;
                document.getElementById('valor-investido').value = valorInvestido;
                document.getElementById('cotacao-compra').value = investimento.preco;
                
                // Chamar função para mostrar campos de cripto
                alternarCamposCategoria();
            } else if (investimento.categoria === 'renda-fixa') {
                // Para renda fixa: usar valor investido e percentual do CDI
                document.getElementById('valor-investido').value = investimento.valorTotal;
                document.getElementById('percentual-cdi').value = investimento.percentualCdi || 100;
                
                // Chamar função para mostrar campos de renda fixa
                alternarCamposCategoria();
            } else {
                // Para outros investimentos: usar quantidade e preço
                document.getElementById('quantidade').value = investimento.quantidade;
                document.getElementById('preco-compra').value = investimento.preco;
                
                // Chamar função para mostrar campos tradicionais
                alternarCamposCategoria();
            }
            
            // Mostrar campos de input em vez dos selects
            const ativoSelect = document.getElementById('ativo-select');
            const ativoInput = document.getElementById('ativo');
            const corretoraSelect = document.getElementById('corretora-select');
            const corretoraInput = document.getElementById('corretora');
            
            if (ativoSelect && ativoInput) {
                ativoSelect.classList.add('d-none');
                ativoInput.classList.remove('d-none');
            }
            
            if (corretoraSelect && corretoraInput) {
                corretoraSelect.classList.add('d-none');
                corretoraInput.classList.remove('d-none');
            }
            
            // Alterar título do modal
            document.querySelector('#investimentoModal .modal-title').textContent = 'Editar Lançamento';
            
            // Ativar modo edição
            modoEdicaoInvestimento = true;
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('investimentoModal'));
            modal.show();
        }
        
        function confirmarExclusaoInvestimento(id) {
            const investimento = investimentos.find(inv => inv.id === id);
            if (!investimento) return;
            
            investimentoParaExcluir = id;
            document.getElementById('investimento-descricao').textContent = `${investimento.ativo} - ${investimento.categoria}`;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmacaoInvestimentoModal'));
            modal.show();
        }
        
        function excluirInvestimento() {
            if (investimentoParaExcluir) {
                const index = investimentos.findIndex(inv => inv.id === investimentoParaExcluir);
                if (index !== -1) {
                    investimentos.splice(index, 1);
                    salvarDados();
                    atualizarTabelaInvestimentos();
                    atualizarDashboardInvestimentos();
                    atualizarResumoAtivos();
                }
                
                investimentoParaExcluir = null;
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmacaoInvestimentoModal'));
                modal.hide();
            }
        }
        
        function excluirDividendo(id) {
            if (confirm('Tem certeza que deseja excluir este dividendo/rendimento?')) {
                const index = dividendos.findIndex(div => div.id === id);
                if (index !== -1) {
                    dividendos.splice(index, 1);
                    salvarDados();
                    atualizarTabelaDividendos();
                    atualizarDashboardInvestimentos();
                }
            }
        }
        
        function alternarCamposCategoria() {
            const categoria = document.getElementById('categoria-investimento').value;
            const camposTradicional = ['campo-quantidade-tradicional', 'campo-preco-compra-tradicional'];
            const camposCripto = ['campo-valor-investido', 'campo-cotacao-compra'];
            const camposRendaFixa = ['campo-valor-investido', 'campo-percentual-cdi'];
            
            // Esconder todos os campos específicos primeiro
            [...camposTradicional, ...camposCripto, 'campo-percentual-cdi'].forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.classList.add('d-none');
            });
            
            // Remover required de todos os campos
            ['quantidade', 'preco-compra', 'valor-investido', 'cotacao-compra', 'percentual-cdi'].forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.removeAttribute('required');
            });
            
            if (categoria === 'renda-fixa') {
                // Mostrar campos de renda fixa
                camposRendaFixa.forEach(id => {
                    const elemento = document.getElementById(id);
                    if (elemento) elemento.classList.remove('d-none');
                });
                
                // Adicionar required nos campos de renda fixa
                document.getElementById('valor-investido').setAttribute('required', 'required');
                document.getElementById('percentual-cdi').setAttribute('required', 'required');
                
                // Alterar label do campo valor investido para renda fixa
                const labelValor = document.querySelector('label[for="valor-investido"]');
                if (labelValor) labelValor.textContent = 'Valor Investido (R$)';
                
            } else if (categoria === 'criptomoedas') {
                // Mostrar campos de criptomoedas
                camposCripto.forEach(id => {
                    const elemento = document.getElementById(id);
                    if (elemento) elemento.classList.remove('d-none');
                });
                
                // Adicionar required nos campos de cripto
                document.getElementById('valor-investido').setAttribute('required', 'required');
                document.getElementById('cotacao-compra').setAttribute('required', 'required');
                
                // Alterar label do campo valor investido para cripto
                const labelValor = document.querySelector('label[for="valor-investido"]');
                if (labelValor) labelValor.textContent = 'Valor Investido (R$)';
                
            } else {
                // Mostrar campos tradicionais (ações, fundos, etc.)
                camposTradicional.forEach(id => {
                    const elemento = document.getElementById(id);
                    if (elemento) elemento.classList.remove('d-none');
                });
                
                // Adicionar required nos campos tradicionais
                document.getElementById('quantidade').setAttribute('required', 'required');
                document.getElementById('preco-compra').setAttribute('required', 'required');
            }
        }
        
        function limparFormularioInvestimento() {
            document.getElementById('investimentoForm').reset();
            document.getElementById('investimentoId').value = '';
            document.querySelector('#investimentoModal .modal-title').textContent = 'Adicionar Lançamento';
            
            // Resetar campos de categoria para mostrar campos tradicionais
            const camposTradicional = ['campo-quantidade-tradicional', 'campo-preco-compra-tradicional'];
            const camposCripto = ['campo-valor-investido', 'campo-cotacao-compra'];
            
            // Mostrar campos tradicionais
            camposTradicional.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.classList.remove('d-none');
            });
            
            // Esconder campos de criptomoedas
            camposCripto.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.classList.add('d-none');
            });
            
            // Resetar required attributes
            document.getElementById('quantidade').setAttribute('required', 'required');
            document.getElementById('preco-compra').setAttribute('required', 'required');
            document.getElementById('valor-investido').removeAttribute('required');
            document.getElementById('cotacao-compra').removeAttribute('required');
            
            // Resetar campos de seleção
            const ativoSelect = document.getElementById('ativo-select');
            const ativoInput = document.getElementById('ativo');
            const corretoraSelect = document.getElementById('corretora-select');
            const corretoraInput = document.getElementById('corretora');
            
            if (ativoSelect && ativoInput) {
                ativoSelect.classList.remove('d-none');
                ativoInput.classList.add('d-none');
                ativoSelect.value = '';
                ativoInput.value = '';
            }
            
            if (corretoraSelect && corretoraInput) {
                corretoraSelect.classList.remove('d-none');
                corretoraInput.classList.add('d-none');
                corretoraSelect.value = '';
                corretoraInput.value = '';
            }
            
            modoEdicaoInvestimento = false;
        }
        
        function limparFormularioDividendo() {
            document.getElementById('dividendoForm').reset();
        }
        
        function carregarAtivosDividendo() {
            const ativoSelect = document.getElementById('ativo-dividendo');
            if (!ativoSelect) return;
            
            // Limpar opções existentes (exceto a padrão)
            ativoSelect.innerHTML = '<option value="">Selecione um ativo</option>';
            
            // Adicionar ativos cadastrados
            ativos.forEach(ativo => {
                const option = document.createElement('option');
                option.value = ativo;
                option.textContent = ativo;
                ativoSelect.appendChild(option);
            });
        }
        
        function aplicarFiltrosInvestimentos() {
            atualizarTabelaInvestimentos();
            atualizarResumoAtivos();
            atualizarTabelaDividendos();
        }
        
        function limparFiltrosInvestimentos() {
            document.getElementById('filtro-categoria-investimento').value = '';
            document.getElementById('filtro-tipo-lancamento').value = '';
            document.getElementById('filtro-corretora-investimento').value = '';
            document.getElementById('filtro-data-inicio').value = '';
            document.getElementById('filtro-data-fim').value = '';
            atualizarTabelaInvestimentos();
            atualizarResumoAtivos();
            atualizarTabelaDividendos();
        }
        
        // Event listeners para os modais de investimentos
        document.addEventListener('DOMContentLoaded', function() {
            // Modal de investimento
            const investimentoModal = document.getElementById('investimentoModal');
            if (investimentoModal) {
                investimentoModal.addEventListener('hidden.bs.modal', function() {
                    limparFormularioInvestimento();
                });
            }
            
            // Modal de dividendo
            const dividendoModal = document.getElementById('dividendoModal');
            if (dividendoModal) {
                dividendoModal.addEventListener('shown.bs.modal', function() {
                    carregarAtivosDividendo();
                });
                dividendoModal.addEventListener('hidden.bs.modal', function() {
                    limparFormularioDividendo();
                });
            }
            
            // Botão de confirmar exclusão
            const btnConfirmarExclusao = document.getElementById('confirmarExclusaoInvestimento');
            if (btnConfirmarExclusao) {
                btnConfirmarExclusao.addEventListener('click', excluirInvestimento);
            }
        });
        
        // ===== FIM DAS FUNÇÕES DE INVESTIMENTOS =====
        
        // Função para migrar contas antigas (strings) para nova estrutura (objetos)
        function migrarContasAntigas() {
            if (!usuarioAtual) return;
            
            let precisaMigrar = false;
            const userPrefix = `financas_${usuarioAtual.email}_`;
            
            bancos.forEach(banco => {
                if (banco.contas && banco.contas.length > 0) {
                    banco.contas.forEach((conta, index) => {
                        if (typeof conta === 'string') {
                            // Migrar conta string para objeto
                            banco.contas[index] = {
                                id: Date.now() + Math.random(),
                                numero: `${banco.id}${String(index + 1).padStart(3, '0')}-${Math.floor(Math.random() * 10)}`,
                                tipo: conta
                            };
                            precisaMigrar = true;
                        }
                    });
                }
            });
            
            if (precisaMigrar) {
                localStorage.setItem(`${userPrefix}Bancos`, JSON.stringify(bancos));
            }
        }
        
        // Função para inicializar bancos de exemplo (apenas quando necessário)
        function inicializarBancosExemplo() {
            if (!usuarioAtual) return;
            
            console.log('🏦 DEBUG: Inicializando bancos de exemplo');
            bancos = [
                { id: 1, nome: 'Nubank', contas: [
                    { id: 1001, numero: '1234-5', tipo: 'Conta Corrente' },
                    { id: 1002, numero: '1234-6', tipo: 'Conta Poupança' }
                ]},
                { id: 2, nome: 'Inter', contas: [
                    { id: 2001, numero: '2345-6', tipo: 'Conta Corrente' },
                    { id: 2002, numero: '2345-7', tipo: 'Conta Poupança' }
                ]},
                { id: 3, nome: 'Bradesco', contas: [
                    { id: 3001, numero: '3456-7', tipo: 'Conta Corrente' },
                    { id: 3002, numero: '3456-8', tipo: 'Conta Poupança' }
                ]},
                { id: 4, nome: 'Itaú', contas: [
                    { id: 4001, numero: '4567-8', tipo: 'Conta Corrente' },
                    { id: 4002, numero: '4567-9', tipo: 'Conta Poupança' }
                ]},
                { id: 5, nome: 'Santander', contas: [
                    { id: 5001, numero: '5678-9', tipo: 'Conta Corrente' },
                    { id: 5002, numero: '5678-0', tipo: 'Conta Poupança' }
                ]},
                { id: 6, nome: 'Caixa Econômica Federal', contas: [
                    { id: 6001, numero: '6789-0', tipo: 'Conta Corrente' },
                    { id: 6002, numero: '6789-1', tipo: 'Conta Poupança' }
                ]},
                { id: 7, nome: 'Banco do Brasil', contas: [
                    { id: 7001, numero: '7890-1', tipo: 'Conta Corrente' },
                    { id: 7002, numero: '7890-2', tipo: 'Conta Poupança' }
                ]},
                { id: 8, nome: 'C6 Bank', contas: [
                    { id: 8001, numero: '8901-2', tipo: 'Conta Corrente' }
                ]},
                { id: 9, nome: 'PicPay', contas: [
                    { id: 9001, numero: '9012-3', tipo: 'Conta Digital' }
                ]},
                { id: 10, nome: 'Neon', contas: [
                    { id: 10001, numero: '0123-4', tipo: 'Conta Digital' }
                ]}
            ];
            salvarDados();
        }
        
        // Função para inicializar investimentos de exemplo
        function inicializarInvestimentosExemplo() {
            if (!usuarioAtual) return;
            
            console.log('📈 DEBUG: Inicializando investimentos de exemplo');
            investimentos = [
                { id: 1, data: '2024-01-15', ativo: 'PETR4', quantidade: 100, preco: 35.50, tipo: 'Compra', corretora: 'XP Investimentos' },
                { id: 2, data: '2024-01-20', ativo: 'VALE3', quantidade: 50, preco: 68.20, tipo: 'Compra', corretora: 'Rico' },
                { id: 3, data: '2024-02-10', ativo: 'ITUB4', quantidade: 200, preco: 32.80, tipo: 'Compra', corretora: 'Clear' },
                { id: 4, data: '2024-02-15', ativo: 'BBDC4', quantidade: 150, preco: 14.90, tipo: 'Compra', corretora: 'XP Investimentos' },
                { id: 5, data: '2024-03-05', ativo: 'WEGE3', quantidade: 80, preco: 42.30, tipo: 'Compra', corretora: 'Rico' }
            ];
            salvarDados();
        }
        
        // Função para inicializar ativos de exemplo
        function inicializarAtivosExemplo() {
            if (!usuarioAtual) return;
            
            console.log('🏢 DEBUG: Inicializando ativos de exemplo');
            ativos = [
                { id: 1, ticker: 'PETR4', nome: 'Petrobras PN', setor: 'Petróleo e Gás', tipo: 'Ação' },
                { id: 2, ticker: 'VALE3', nome: 'Vale ON', setor: 'Mineração', tipo: 'Ação' },
                { id: 3, ticker: 'ITUB4', nome: 'Itaú Unibanco PN', setor: 'Bancos', tipo: 'Ação' },
                { id: 4, ticker: 'BBDC4', nome: 'Bradesco PN', setor: 'Bancos', tipo: 'Ação' },
                { id: 5, ticker: 'WEGE3', nome: 'WEG ON', setor: 'Máquinas e Equipamentos', tipo: 'Ação' },
                { id: 6, ticker: 'MGLU3', nome: 'Magazine Luiza ON', setor: 'Comércio', tipo: 'Ação' },
                { id: 7, ticker: 'ABEV3', nome: 'Ambev ON', setor: 'Bebidas', tipo: 'Ação' },
                { id: 8, ticker: 'BBAS3', nome: 'Banco do Brasil ON', setor: 'Bancos', tipo: 'Ação' }
            ];
            salvarDados();
        }
        
        // Função para inicializar corretoras de exemplo
        function inicializarCorretorasExemplo() {
            if (!usuarioAtual) return;
            
            console.log('🏛️ DEBUG: Inicializando corretoras de exemplo');
            corretoras = [
                { id: 1, nome: 'XP Investimentos', taxa: 0.00, observacoes: 'Corretagem zero para ações' },
                { id: 2, nome: 'Rico', taxa: 0.00, observacoes: 'Corretagem zero para ações' },
                { id: 3, nome: 'Clear', taxa: 0.00, observacoes: 'Corretagem zero para ações' },
                { id: 4, nome: 'Inter Invest', taxa: 0.00, observacoes: 'Corretagem zero para ações' },
                { id: 5, nome: 'Nubank', taxa: 0.00, observacoes: 'Corretagem zero para ações' },
                { id: 6, nome: 'BTG Pactual', taxa: 9.90, observacoes: 'Taxa fixa por operação' },
                { id: 7, nome: 'Itaú Corretora', taxa: 18.90, observacoes: 'Taxa fixa por operação' }
            ];
            salvarDados();
        }
        
        // ===== FUNÇÕES DE COTAÇÕES =====
        
        // Função para buscar cotações na API Brapi
        async function buscarCotacaoBrapi(ticker) {
            const apiKey = '8Kit3i4Diim1pymyVmRkEt';
            try {
                const response = await fetch(`https://brapi.dev/api/quote/${ticker}?token=${apiKey}`);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const resultado = data.results[0];
                    return {
                        ticker: resultado.symbol,
                        preco: resultado.regularMarketPrice,
                        variacao: resultado.regularMarketChangePercent,
                        ultimaAtualizacao: new Date().toISOString()
                    };
                }
                return null;
            } catch (error) {
                console.error(`Erro ao buscar cotação de ${ticker}:`, error);
                return null;
            }
        }
        
        // Função para obter todos os ativos únicos dos investimentos
        function obterAtivosUnicos() {
            if (!usuarioAtual) {
                return [];
            }
            
            const userPrefix = `financas_${usuarioAtual.email}_`;
            const investimentos = JSON.parse(localStorage.getItem(`${userPrefix}Investimentos`)) || [];
            const ativos = [...new Set(investimentos.map(inv => inv.ativo))];
            return ativos;
        }
        
        // Função para salvar cotações no localStorage
        function salvarCotacoes(cotacoes) {
            localStorage.setItem('cotacoesAtuais', JSON.stringify(cotacoes));
        }
        
        // Função para carregar cotações do localStorage
        function carregarCotacoes() {
            const cotacoes = localStorage.getItem('cotacoesAtuais');
            return cotacoes ? JSON.parse(cotacoes) : {};
        }
        
        // Função para buscar cotações de criptomoedas usando CoinGecko API
        async function buscarCotacaoCripto(simbolo) {
            try {
                // Mapear símbolos comuns para IDs do CoinGecko
                const mapeamentoCripto = {
                    'BTC': 'bitcoin',
                    'ETH': 'ethereum',
                    'ADA': 'cardano',
                    'DOT': 'polkadot',
                    'LINK': 'chainlink',
                    'LTC': 'litecoin',
                    'XRP': 'ripple',
                    'BCH': 'bitcoin-cash',
                    'BNB': 'binancecoin',
                    'SOL': 'solana',
                    'MATIC': 'matic-network',
                    'AVAX': 'avalanche-2',
                    'ATOM': 'cosmos',
                    'UNI': 'uniswap',
                    'DOGE': 'dogecoin'
                };
                
                const coinId = mapeamentoCripto[simbolo.toUpperCase()] || simbolo.toLowerCase();
                
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=brl&include_24hr_change=true`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data[coinId]) {
                    return {
                        ticker: simbolo.toUpperCase(),
                        preco: data[coinId].brl,
                        variacao: data[coinId].brl_24h_change || 0,
                        ultimaAtualizacao: new Date().toISOString()
                    };
                }
                return null;
            } catch (error) {
                console.error(`Erro ao buscar cotação de ${simbolo}:`, error);
                return null;
            }
        }
        
        // Função para verificar se um ativo é criptomoeda
        function verificarSeCriptomoeda(ativo) {
            if (!usuarioAtual) return false;
            
            const userPrefix = `financas_${usuarioAtual.email}_`;
            const investimentos = JSON.parse(localStorage.getItem(`${userPrefix}Investimentos`)) || [];
            
            // Buscar qualquer investimento deste ativo que seja da categoria criptomoedas
            const investimentoCripto = investimentos.find(inv => 
                inv.ativo === ativo && inv.categoria === 'criptomoedas'
            );
            
            return !!investimentoCripto;
        }
        
        // Função principal para atualizar cotações
        async function atualizarCotacoes() {
            const btnAtualizar = document.getElementById('btnAtualizarCotacoes');
            const ativos = obterAtivosUnicos();
            
            if (ativos.length === 0) {
                alert('Nenhum ativo encontrado para atualizar cotações.');
                return;
            }
            
            // Desabilitar botão e mostrar loading
            btnAtualizar.disabled = true;
            btnAtualizar.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spin"></i> Atualizando...';
            
            try {
                const cotacoes = carregarCotacoes();
                let sucessos = 0;
                let erros = 0;
                
                // Buscar cotações para cada ativo
                for (const ativo of ativos) {
                    // Verificar se é criptomoeda baseado na categoria do investimento
                    const isCripto = verificarSeCriptomoeda(ativo);
                    
                    let cotacao;
                    if (isCripto) {
                        cotacao = await buscarCotacaoCripto(ativo);
                    } else {
                        cotacao = await buscarCotacaoBrapi(ativo);
                    }
                    
                    if (cotacao) {
                        cotacoes[ativo] = cotacao;
                        sucessos++;
                    } else {
                        erros++;
                    }
                    
                    // Pequena pausa entre requisições para não sobrecarregar a API
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                // Salvar cotações atualizadas
                salvarCotacoes(cotacoes);
                
                // Atualizar dashboard com novos valores
                atualizarDashboardInvestimentos();
                
                // Mostrar resultado
                const mensagem = `Cotações atualizadas!\n✅ Sucessos: ${sucessos}\n❌ Erros: ${erros}`;
                alert(mensagem);
                
            } catch (error) {
                console.error('Erro ao atualizar cotações:', error);
                alert('Erro ao atualizar cotações. Verifique sua conexão com a internet.');
            } finally {
                // Reabilitar botão
                btnAtualizar.disabled = false;
                btnAtualizar.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i> Atualizar Cotações';
            }
        }
        
        // Função para obter preço atual de um ativo (cotação da API ou preço médio como fallback)
        function obterPrecoAtual(ativo, precoMedio) {
            const cotacoes = carregarCotacoes();
            if (cotacoes[ativo] && cotacoes[ativo].preco) {
                return cotacoes[ativo].preco;
            }
            return precoMedio; // Fallback para preço médio se não houver cotação
        }

        // Função para calcular preço médio de compra por ativo
        function calcularPrecoMedio(ativo) {
            if (!usuarioAtual) return 0;
            
            const userPrefix = `financas_${usuarioAtual.email}_`;
            const investimentos = JSON.parse(localStorage.getItem(`${userPrefix}Investimentos`)) || [];
            
            const investimentosAtivo = investimentos.filter(inv => inv.ativo === ativo && inv.tipoLancamento === 'compra');
            
            if (investimentosAtivo.length === 0) return 0;
            
            let totalQuantidade = 0;
            let totalValor = 0;
            
            investimentosAtivo.forEach(inv => {
                totalQuantidade += inv.quantidade;
                totalValor += inv.quantidade * inv.preco;
            });
            
            return totalQuantidade > 0 ? totalValor / totalQuantidade : 0;
        }

        // Função para calcular valorização de um ativo
        function calcularValorizacao(precoMedio, precoAtual) {
            if (precoMedio <= 0 || precoAtual <= 0) return { percentual: 0, valor: 0 };
            
            const diferenca = precoAtual - precoMedio;
            const percentual = (diferenca / precoMedio) * 100;
            
            return {
                percentual: percentual,
                valor: diferenca
            };
        }

        // Função para obter dados consolidados de um ativo
        function obterDadosAtivo(ativo) {
            const precoMedio = calcularPrecoMedio(ativo);
            const precoAtual = obterPrecoAtual(ativo, precoMedio);
            const valorizacao = calcularValorizacao(precoMedio, precoAtual);
            
            return {
                ativo: ativo,
                precoMedio: precoMedio,
                precoAtual: precoAtual,
                valorizacao: valorizacao
            };
        }
        
        // Funções para transferência entre contas
        function prepararModalTransferencia() {
            console.log('🔄 MODAL DE TRANSFERÊNCIA SENDO PREPARADO');
            // Limpar campos
            document.getElementById('dataTransferencia').value = new Date().toISOString().split('T')[0];
            document.getElementById('descricaoTransferencia').value = '';
            document.getElementById('valor-transferencia').value = '';
            document.getElementById('categoria-transferencia').value = '';
            
            // Carregar bancos nos dropdowns
            carregarBancosTransferencia();
            
            // Carregar categorias no dropdown
            carregarCategorias();
        }

        function carregarBancosTransferencia() {
            const bancoOrigemSelect = document.getElementById('banco-origem-transferencia');
            const bancoDestinoSelect = document.getElementById('banco-destino-transferencia');
            
            if (!bancoOrigemSelect || !bancoDestinoSelect) {
                console.error('Elementos select não encontrados!');
                return;
            }
            
            // Limpar opções existentes
            bancoOrigemSelect.innerHTML = '<option value="">Selecione o banco</option>';
            bancoDestinoSelect.innerHTML = '<option value="">Selecione o banco</option>';
            
            // Filtrar apenas bancos válidos
            const bancosValidos = bancos.filter(banco => {
                return banco && 
                       banco.nome && 
                       banco.nome !== 'undefined' && 
                       banco.id && 
                       banco.contas && 
                       Array.isArray(banco.contas) &&
                       banco.contas.length > 0;
            });
            
            // Carregar bancos
            bancosValidos.forEach(banco => {
                const optionOrigem = document.createElement('option');
                optionOrigem.value = banco.id;
                optionOrigem.textContent = banco.nome;
                bancoOrigemSelect.appendChild(optionOrigem);
                
                const optionDestino = document.createElement('option');
                optionDestino.value = banco.id;
                optionDestino.textContent = banco.nome;
                bancoDestinoSelect.appendChild(optionDestino);
            });
        }

        function carregarContasTransferencia(bancoSelecionado, selectContaId) {
            const selectConta = document.getElementById(selectContaId);
            selectConta.innerHTML = '<option value="">Selecione a conta</option>';
            
            if (bancoSelecionado) {
                const banco = bancos.find(b => b.id == bancoSelecionado);
                if (banco && banco.contas) {
                    banco.contas.forEach(conta => {
                        const option = document.createElement('option');
                        
                        // Verificar se a conta é um objeto com numero e tipo ou apenas uma string
                        if (typeof conta === 'object' && conta.numero) {
                            option.value = conta.id; // Usar o ID da conta, não o número
                            option.textContent = `${conta.numero} (${conta.tipo})`;
                        } else {
                            // Para compatibilidade com contas antigas que são apenas strings
                            option.value = conta;
                            option.textContent = conta;
                        }
                        
                        selectConta.appendChild(option);
                    });
                }
            }
        }

        function salvarTransferencia() {
            console.log('🔄 FUNÇÃO SALVAR TRANSFERÊNCIA CHAMADA');
            const data = document.getElementById('dataTransferencia').value;
            const descricao = document.getElementById('descricaoTransferencia').value;
            const bancoOrigemId = document.getElementById('banco-origem-transferencia').value;
            const contaOrigem = document.getElementById('conta-origem-transferencia').value;
            const bancoDestinoId = document.getElementById('banco-destino-transferencia').value;
            const contaDestino = document.getElementById('conta-destino-transferencia').value;
            const valor = parseFloat(document.getElementById('valor-transferencia').value);
            const categoria = document.getElementById('categoria-transferencia').value;
            const status = document.querySelector('input[name="status-transferencia"]:checked').value;

            // Obter nomes dos bancos a partir dos IDs
            const bancoOrigemObj = bancos.find(b => b.id == bancoOrigemId);
            const bancoDestinoObj = bancos.find(b => b.id == bancoDestinoId);
            const bancoOrigem = bancoOrigemObj ? bancoOrigemObj.nome : '';
            const bancoDestino = bancoDestinoObj ? bancoDestinoObj.nome : '';

            // Validações
            console.log('🔍 VALIDANDO CAMPOS:', {data, descricao, bancoOrigem, contaOrigem, bancoDestino, contaDestino, valor});
            if (!data || !descricao || !bancoOrigem || !contaOrigem || !bancoDestino || !contaDestino || !valor || valor <= 0) {
                console.log('❌ VALIDAÇÃO FALHOU - Campos obrigatórios');
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            if (bancoOrigem === bancoDestino && contaOrigem === contaDestino) {
                console.log('❌ VALIDAÇÃO FALHOU - Mesma conta origem/destino');
                alert('A conta de origem deve ser diferente da conta de destino.');
                return;
            }
            
            console.log('✅ VALIDAÇÕES PASSARAM - Criando dois lançamentos separados');

            // Criar ID único para a transferência (será usado para vincular os dois lançamentos)
            const timestamp = Date.now();
            const idTransferencia = `transfer_${timestamp}`;
            
            // 1. Criar lançamento de SAÍDA na conta de origem
            const lancamentoSaida = {
                id: `${idTransferencia}_saida`,
                data: data,
                descricao: `Transferência para ${bancoDestino} - ${contaDestino}: ${descricao}`,
                categoria: categoria || 'Transferência',
                banco: parseInt(bancoOrigemId),
                conta: contaOrigem,
                tipo: 'saida',
                tipoTransacao: 'transferencia_interna', // Identificador especial
                cartao: '',
                valor: valor,
                status: status || 'realizado', // Garantir que tenha status realizado
                transferencia_id: idTransferencia, // Vincula os dois lançamentos
                transferencia_tipo: 'origem'
            };

            // 2. Criar lançamento de ENTRADA na conta de destino
            const lancamentoEntrada = {
                id: `${idTransferencia}_entrada`,
                data: data,
                descricao: `Transferência de ${bancoOrigem} - ${contaOrigem}: ${descricao}`,
                categoria: categoria || 'Transferência',
                banco: parseInt(bancoDestinoId),
                conta: contaDestino,
                tipo: 'entrada',
                tipoTransacao: 'transferencia_interna', // Identificador especial
                cartao: '',
                valor: valor,
                status: status || 'realizado', // Garantir que tenha status realizado
                transferencia_id: idTransferencia, // Vincula os dois lançamentos
                transferencia_tipo: 'destino'
            };

            // Adicionar os dois lançamentos
            lancamentos.push(lancamentoSaida);
            lancamentos.push(lancamentoEntrada);

            console.log('💾 SALVANDO DADOS NO LOCALSTORAGE');
            // Salvar dados
            salvarDados();
            console.log('✅ DADOS SALVOS - Atualizando interface');

            // Atualizar interface
            carregarLancamentos();
            atualizarDashboard();
            atualizarSaldosPorConta(); // Forçar atualização dos saldos por conta
            


            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('transferenciaModal'));
            modal.hide();

            alert('Transferência realizada com sucesso!');
        }

        // Carregar dados iniciais
        carregarBancos();
        carregarCartoes();
        carregarTabelaBancos();
        carregarTabelaCartoes();

        // ========================================
        // FUNÇÕES DE MIGRAÇÃO DE DADOS
        // ========================================

        function verificarDadosDisponiveis() {
            const dadosAtuais = {
                lancamentos: lancamentos.length,
                categorias: categorias.length,
                bancos: bancos.length,
                cartoes: cartoes.length,
                orcamentos: orcamentos.length,
                investimentos: investimentos.length
            };

            let mensagem = '📊 DADOS DISPONÍVEIS NO SERVIDOR WEB:\n\n';
            mensagem += `• Lançamentos: ${dadosAtuais.lancamentos}\n`;
            mensagem += `• Categorias: ${dadosAtuais.categorias}\n`;
            mensagem += `• Bancos: ${dadosAtuais.bancos}\n`;
            mensagem += `• Cartões: ${dadosAtuais.cartoes}\n`;
            mensagem += `• Orçamentos: ${dadosAtuais.orcamentos}\n`;
            mensagem += `• Investimentos: ${dadosAtuais.investimentos}\n\n`;

            if (dadosAtuais.lancamentos === 0) {
                mensagem += '⚠️ Nenhum dado encontrado no servidor web.\n';
                mensagem += 'Se você tem dados no arquivo HTML direto, use "Migrar Dados".';
            } else {
                mensagem += '✅ Dados encontrados no servidor web!';
            }

            alert(mensagem);
        }

        function migrarDadosHTML() {
            const confirmacao = confirm(
                '🔄 MIGRAÇÃO DE DADOS\n\n' +
                'Esta função vai tentar importar dados que você pode ter salvado ' +
                'quando abria o arquivo HTML diretamente.\n\n' +
                '⚠️ IMPORTANTE:\n' +
                '• Esta operação vai SUBSTITUIR os dados atuais\n' +
                '• Faça um backup antes se necessário\n' +
                '• Você precisa colar os dados manualmente\n\n' +
                'Deseja continuar?'
            );

            if (!confirmacao) return;

            const instrucoes = 
                '📋 INSTRUÇÕES PARA MIGRAÇÃO:\n\n' +
                '1. Abra o arquivo HTML diretamente no navegador\n' +
                '2. Pressione F12 → Console\n' +
                '3. Digite: exportarDadosParaMigracao()\n' +
                '4. Copie o resultado\n' +
                '5. Volte aqui e cole quando solicitado\n\n' +
                'Clique OK quando tiver os dados copiados.';

            alert(instrucoes);

            const dadosColados = prompt(
                '📥 COLE OS DADOS AQUI:\n\n' +
                'Cole o resultado do comando exportarDadosParaMigracao() aqui:'
            );

            if (!dadosColados) {
                alert('❌ Migração cancelada.');
                return;
            }

            try {
                const dadosImportados = JSON.parse(dadosColados);
                
                // Importar dados
                if (dadosImportados.lancamentos) {
                    lancamentos = dadosImportados.lancamentos;
                }
                if (dadosImportados.categorias) {
                    categorias = dadosImportados.categorias;
                }
                if (dadosImportados.bancos) {
                    bancos = dadosImportados.bancos;
                }
                if (dadosImportados.cartoes) {
                    cartoes = dadosImportados.cartoes;
                }
                if (dadosImportados.orcamentos) {
                    orcamentos = dadosImportados.orcamentos;
                }
                if (dadosImportados.investimentos) {
                    investimentos = dadosImportados.investimentos;
                }
                if (dadosImportados.dividendos) {
                    dividendos = dadosImportados.dividendos;
                }
                if (dadosImportados.ativos) {
                    ativos = dadosImportados.ativos;
                }
                if (dadosImportados.corretoras) {
                    corretoras = dadosImportados.corretoras;
                }
                if (dadosImportados.saldoInicial !== undefined) {
                    saldoInicial = dadosImportados.saldoInicial;
                }
                if (dadosImportados.nextId !== undefined) {
                    nextId = dadosImportados.nextId;
                }
                if (dadosImportados.nextInvestimentoId !== undefined) {
                    nextInvestimentoId = dadosImportados.nextInvestimentoId;
                }
                if (dadosImportados.nextDividendoId !== undefined) {
                    nextDividendoId = dadosImportados.nextDividendoId;
                }

                // Salvar no localStorage do servidor
                salvarDados();

                // Atualizar interface
                carregarLancamentos();
                atualizarDashboard();
                atualizarFiltros();
                aplicarFiltros();
                carregarCategorias();
                carregarBancos();
                carregarTabelaBancos();
                carregarCartoes();
                carregarTabelaCartoes();
                carregarInvestimentos();
                carregarTabelaInvestimentos();
                carregarDividendos();
                carregarTabelaDividendos();
                carregarAtivos();
                carregarCorretoras();

                alert('✅ Migração concluída com sucesso!\n\nDados importados e salvos no servidor web.');

            } catch (error) {
                alert('❌ Erro na migração:\n\n' + error.message + '\n\nVerifique se os dados estão no formato correto.');
            }
        }

        // Função para ser usada no arquivo HTML direto
        function exportarDadosParaMigracao() {
            if (!usuarioAtual) {
                alert('❌ Erro: Nenhum usuário logado. Faça login primeiro.');
                return;
            }
            
            const userPrefix = `financas_${usuarioAtual.email}_`;
            
            const dados = {
                lancamentos: JSON.parse(localStorage.getItem(`${userPrefix}Lancamentos`) || '[]'),
                categorias: JSON.parse(localStorage.getItem(`${userPrefix}Categorias`) || '[]'),
                bancos: JSON.parse(localStorage.getItem(`${userPrefix}Bancos`) || '[]'),
                cartoes: JSON.parse(localStorage.getItem(`${userPrefix}Cartoes`) || '[]'),
                orcamentos: JSON.parse(localStorage.getItem(`${userPrefix}Orcamentos`) || '[]'),
                investimentos: JSON.parse(localStorage.getItem(`${userPrefix}Investimentos`) || '[]'),
                dividendos: JSON.parse(localStorage.getItem(`${userPrefix}Dividendos`) || '[]'),
                ativos: JSON.parse(localStorage.getItem(`${userPrefix}Ativos`) || '[]'),
                corretoras: JSON.parse(localStorage.getItem(`${userPrefix}Corretoras`) || '[]'),
                saldoInicial: parseFloat(localStorage.getItem(`${userPrefix}SaldoInicial`) || '0'),
                nextId: parseInt(localStorage.getItem(`${userPrefix}NextId`) || '1'),
                nextInvestimentoId: parseInt(localStorage.getItem(`${userPrefix}NextInvestimentoId`) || '1'),
                nextDividendoId: parseInt(localStorage.getItem(`${userPrefix}NextDividendoId`) || '1')
            };

            const dadosString = JSON.stringify(dados);
            console.log('📋 DADOS PARA MIGRAÇÃO (copie tudo abaixo):');
            console.log(dadosString);
            
            // Tentar copiar para clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(dadosString).then(() => {
                    console.log('✅ Dados copiados para a área de transferência!');
                }).catch(() => {
                    console.log('⚠️ Copie manualmente os dados acima.');
                });
            }
            
            return dadosString;
        }

        // ========================================
        // FUNÇÕES DE FEEDBACK VISUAL
        // ========================================

        function mostrarIndicadorCarregamento(mensagem = 'Carregando...') {
            // Remover indicador existente se houver
            ocultarIndicadorCarregamento();
            
            // Criar overlay de carregamento
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                color: white;
                font-size: 18px;
                font-family: Arial, sans-serif;
            `;
            
            // Criar conteúdo do carregamento
            const content = document.createElement('div');
            content.style.cssText = `
                text-align: center;
                background: rgba(255, 255, 255, 0.1);
                padding: 30px;
                border-radius: 10px;
                backdrop-filter: blur(10px);
            `;
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                </div>
                <div>${mensagem}</div>
            `;
            
            // Adicionar animação CSS
            if (!document.getElementById('loading-styles')) {
                const style = document.createElement('style');
                style.id = 'loading-styles';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            overlay.appendChild(content);
            document.body.appendChild(overlay);
        }

        function ocultarIndicadorCarregamento() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function atualizarMensagemCarregamento(novaMensagem) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                const messageDiv = overlay.querySelector('div:last-child');
                if (messageDiv) {
                    messageDiv.textContent = novaMensagem;
                }
            }
        }

        // ===== FUNÇÕES DE ADMINISTRAÇÃO =====
        
        function mostrarMenuAdmin() {
            const adminMenuItem = document.getElementById('admin-menu-item');
            if (adminMenuItem) {
                adminMenuItem.style.display = 'block';
            }
        }

        async function carregarUsuarios() {
            try {
                mostrarIndicadorCarregamento('Carregando usuários...');
                
                const response = await fetch('/api/admin', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'admin-email': usuarioAtual ? usuarioAtual.email : 'admin@financeplus.com'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar usuários');
                }

                const data = await response.json();
                
                if (data.success) {
                    exibirUsuarios(data.users);
                    atualizarEstatisticas(data.users);
                } else {
                    mostrarAlerta('Erro ao carregar usuários: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                mostrarAlerta('Erro ao carregar usuários: ' + error.message, 'danger');
            } finally {
                ocultarIndicadorCarregamento();
            }
        }

        function exibirUsuarios(usuarios) {
            const tbody = document.getElementById('usuarios-lista');
            
            if (!usuarios || usuarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum usuário encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = usuarios.map(usuario => {
                const dataFormatada = new Date(usuario.created_at).toLocaleDateString('pt-BR');
                const isActive = usuario.subscription_status === 'active';
                const statusBadge = isActive ? 
                    '<span class="badge bg-success">Ativa</span>' : 
                    '<span class="badge bg-danger">Inativa</span>';
                
                const subscriptionBadge = usuario.subscription_type === 'premium' ? 
                    '<span class="badge bg-warning">Premium</span>' : 
                    '<span class="badge bg-secondary">Gratuita</span>';

                return `
                    <tr>
                        <td>${usuario.id}</td>
                        <td>${usuario.nome}</td>
                        <td>${usuario.email}</td>
                        <td>${subscriptionBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${dataFormatada}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="abrirModalEdicao(${usuario.id}, '${usuario.nome}', '${usuario.email}', '${usuario.subscription_type}', '${usuario.subscription_status}')" title="Editar Usuário">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn ${isActive ? 'btn-outline-warning' : 'btn-outline-success'}" onclick="alternarStatusUsuario(${usuario.id}, '${isActive ? 'inactive' : 'active'}')" title="${isActive ? 'Desativar' : 'Ativar'} Assinatura">
                                    <i class="bi ${isActive ? 'bi-pause-circle' : 'bi-play-circle'}"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="confirmarDeleteUsuario(${usuario.id}, '${usuario.nome}')" title="Deletar Usuário">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function atualizarEstatisticas(usuarios) {
            const totalUsuarios = usuarios.length;
            const totalPremium = usuarios.filter(u => u.subscription_type === 'premium').length;
            const totalFree = usuarios.filter(u => u.subscription_type === 'free').length;
            const totalAtivas = usuarios.filter(u => u.subscription_status === 'active').length;

            document.getElementById('total-usuarios').textContent = totalUsuarios;
            document.getElementById('total-premium').textContent = totalPremium;
            document.getElementById('total-free').textContent = totalFree;
            document.getElementById('total-ativas').textContent = totalAtivas;
        }

        function abrirModalEdicao(userId, userName, userEmail, subscriptionType, subscriptionStatus) {
            // Preencher os campos do modal
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserIdDisplay').textContent = userId;
            document.getElementById('editUserName').textContent = userName;
            document.getElementById('editUserEmail').textContent = userEmail;
            document.getElementById('editSubscriptionType').value = subscriptionType;
            document.getElementById('editSubscriptionActive').value = subscriptionStatus === 'active' ? 'true' : 'false';
            
            // Abrir o modal
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        async function alternarStatusUsuario(userId, novoStatus) {
            const acao = novoStatus === 'active' ? 'ativar' : 'desativar';
            
            if (!confirm(`Tem certeza que deseja ${acao} a assinatura deste usuário?`)) {
                return;
            }

            try {
                mostrarIndicadorCarregamento(`${acao.charAt(0).toUpperCase() + acao.slice(1)}ando assinatura...`);
                
                // Primeiro, buscar os dados atuais do usuário
                const usuarios = await buscarUsuarios();
                const usuario = usuarios.find(u => u.id === userId);
                
                if (!usuario) {
                    throw new Error('Usuário não encontrado');
                }
                
                const response = await fetch('/api/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update_subscription',
                        userId: userId,
                        subscriptionType: usuario.subscription_type,
                        subscriptionStatus: novoStatus,
                        adminEmail: usuarioAtual ? usuarioAtual.email : 'admin@financeplus.com'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    mostrarAlerta(`Assinatura ${novoStatus === 'active' ? 'ativada' : 'desativada'} com sucesso!`, 'success');
                    carregarUsuarios(); // Recarregar lista
                } else {
                    mostrarAlerta('Erro ao alterar status: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                mostrarAlerta('Erro ao alterar status: ' + error.message, 'danger');
            } finally {
                ocultarIndicadorCarregamento();
            }
        }

        async function salvarEdicaoUsuario() {
            const userId = document.getElementById('editUserId').value;
            const subscriptionType = document.getElementById('editSubscriptionType').value;
            const subscriptionStatus = document.getElementById('editSubscriptionActive').value === 'true' ? 'active' : 'inactive';

            try {
                mostrarIndicadorCarregamento('Salvando alterações...');
                
                const response = await fetch('/api/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update_subscription',
                        userId: userId,
                        subscriptionType: subscriptionType,
                        subscriptionStatus: subscriptionStatus,
                        adminEmail: usuarioAtual ? usuarioAtual.email : 'admin@financeplus.com'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    mostrarAlerta('Usuário atualizado com sucesso!', 'success');
                    
                    // Fechar o modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                    modal.hide();
                    
                    carregarUsuarios(); // Recarregar lista
                } else {
                    mostrarAlerta('Erro ao atualizar usuário: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Erro ao atualizar usuário:', error);
                mostrarAlerta('Erro ao atualizar usuário: ' + error.message, 'danger');
            } finally {
                ocultarIndicadorCarregamento();
            }
        }

        async function buscarUsuarios() {
            const response = await fetch('/api/admin', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'admin-email': usuarioAtual ? usuarioAtual.email : 'admin@financeplus.com'
                }
            });

            if (!response.ok) {
                throw new Error('Erro ao buscar usuários');
            }

            const data = await response.json();
            return data.success ? data.users : [];
        }

        async function confirmarDeleteUsuario(userId, userName) {
            if (!confirm(`Tem certeza que deseja deletar o usuário "${userName}" (ID: ${userId})?\n\nEsta ação não pode ser desfeita!`)) {
                return;
            }

            try {
                mostrarIndicadorCarregamento('Deletando usuário...');
                
                const response = await fetch('/api/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_user',
                        userId: userId,
                        adminEmail: usuarioAtual ? usuarioAtual.email : 'admin@financeplus.com'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    mostrarAlerta('Usuário deletado com sucesso!', 'success');
                    carregarUsuarios(); // Recarregar lista
                } else {
                    mostrarAlerta('Erro ao deletar usuário: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Erro ao deletar usuário:', error);
                mostrarAlerta('Erro ao deletar usuário: ' + error.message, 'danger');
            } finally {
                ocultarIndicadorCarregamento();
            }
        }

    </script>
</body>
</html>