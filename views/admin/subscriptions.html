<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Assinaturas - FinancePlus Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .status-active { background-color: #28a745; }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-cancelled { background-color: #dc3545; }
        .status-inactive { background-color: #6c757d; }
        .card-stats {
            border-left: 4px solid #667eea;
        }
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar text-white p-3">
                <h4 class="mb-4"><i class="fas fa-crown"></i> Admin Panel</h4>
                <nav class="nav flex-column">
                    <a class="nav-link text-white" href="/admin/dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a class="nav-link text-white" href="/admin/users">
                        <i class="fas fa-users"></i> Usuários
                    </a>
                    <a class="nav-link text-white active bg-white bg-opacity-25 rounded" href="/admin/subscriptions">
                        <i class="fas fa-credit-card"></i> Assinaturas
                    </a>
                    <a class="nav-link text-white" href="/admin/analytics">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-credit-card"></i> Gerenciar Assinaturas</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSubscriptionModal">
                        <i class="fas fa-plus"></i> Nova Assinatura
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card card-stats">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="card-category text-muted">Total de Assinaturas</p>
                                        <h3 class="card-title" id="totalSubscriptions">0</h3>
                                    </div>
                                    <div class="text-primary">
                                        <i class="fas fa-credit-card fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stats">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="card-category text-muted">Assinaturas Ativas</p>
                                        <h3 class="card-title text-success" id="activeSubscriptions">0</h3>
                                    </div>
                                    <div class="text-success">
                                        <i class="fas fa-check-circle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stats">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="card-category text-muted">Solicitações Pendentes</p>
                                        <h3 class="card-title text-warning" id="pendingRequests">0</h3>
                                    </div>
                                    <div class="text-warning">
                                        <i class="fas fa-clock fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stats">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="card-category text-muted">Receita Mensal</p>
                                        <h3 class="card-title text-info" id="monthlyRevenue">R$ 0</h3>
                                    </div>
                                    <div class="text-info">
                                        <i class="fas fa-dollar-sign fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">Todos</option>
                                    <option value="active">Ativo</option>
                                    <option value="pending">Pendente</option>
                                    <option value="cancelled">Cancelado</option>
                                    <option value="inactive">Inativo</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Plano</label>
                                <select class="form-select" id="filterPlan">
                                    <option value="">Todos</option>
                                    <option value="free">Gratuito</option>
                                    <option value="pro">Profissional</option>
                                    <option value="enterprise">Empresarial</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Buscar</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Nome ou email...">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-outline-primary me-2" onclick="applyFilters()">
                                    <i class="fas fa-search"></i> Filtrar
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscriptions Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Lista de Assinaturas</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Plano</th>
                                        <th>Status</th>
                                        <th>Período</th>
                                        <th>Valor</th>
                                        <th>Solicitado em</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="subscriptionsTable">
                                    <!-- Dados carregados via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Paginação">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Paginação carregada via JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Assinatura -->
    <div class="modal fade" id="newSubscriptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Assinatura Manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newSubscriptionForm">
                        <div class="mb-3">
                            <label class="form-label">Usuário</label>
                            <select class="form-select" id="userId" required>
                                <option value="">Selecione um usuário...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Plano</label>
                            <select class="form-select" id="planId" required>
                                <option value="pro">Profissional - R$ 29,90/mês</option>
                                <option value="enterprise">Empresarial - R$ 99,90/mês</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Período</label>
                            <select class="form-select" id="interval" required>
                                <option value="month">Mensal</option>
                                <option value="year">Anual</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor Pago (R$)</label>
                            <input type="number" class="form-control" id="priceAtPurchase" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Método de Pagamento</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="pix">PIX</option>
                                <option value="transfer">Transferência</option>
                                <option value="cash">Dinheiro</option>
                                <option value="other">Outro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="createSubscription()">Criar Assinatura</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Assinatura -->
    <div class="modal fade" id="editSubscriptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Assinatura</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSubscriptionForm">
                        <input type="hidden" id="editSubscriptionId">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editStatus" required>
                                <option value="active">Ativo</option>
                                <option value="pending">Pendente</option>
                                <option value="cancelled">Cancelado</option>
                                <option value="inactive">Inativo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data de Expiração</label>
                            <input type="date" class="form-control" id="editCurrentPeriodEnd">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="editNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="updateSubscription()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let subscriptions = [];

        // Carregar dados iniciais
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadUsers();
            loadSubscriptions();
        });

        // Carregar estatísticas
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/subscriptions/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalSubscriptions').textContent = data.data.total;
                    document.getElementById('activeSubscriptions').textContent = data.data.active;
                    document.getElementById('pendingRequests').textContent = data.data.pending;
                    document.getElementById('monthlyRevenue').textContent = 
                        new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })
                        .format(data.data.revenue);
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar usuários para o select
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users?limit=1000');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('userId');
                    select.innerHTML = '<option value="">Selecione um usuário...</option>';
                    
                    data.data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user._id;
                        option.textContent = `${user.name} (${user.email})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
            }
        }

        // Carregar assinaturas
        async function loadSubscriptions(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 20
                });

                // Aplicar filtros
                const status = document.getElementById('filterStatus')?.value;
                const plan = document.getElementById('filterPlan')?.value;
                const search = document.getElementById('searchInput')?.value;

                if (status) params.append('status', status);
                if (plan) params.append('plan', plan);
                if (search) params.append('search', search);

                const response = await fetch(`/api/admin/subscriptions?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    subscriptions = data.data.subscriptions;
                    currentPage = data.data.currentPage;
                    totalPages = data.data.totalPages;
                    
                    renderSubscriptionsTable();
                    renderPagination();
                }
            } catch (error) {
                console.error('Erro ao carregar assinaturas:', error);
            }
        }

        // Renderizar tabela de assinaturas
        function renderSubscriptionsTable() {
            const tbody = document.getElementById('subscriptionsTable');
            tbody.innerHTML = '';

            subscriptions.forEach(subscription => {
                const row = document.createElement('tr');
                
                const statusClass = `status-${subscription.status}`;
                const statusText = {
                    'active': 'Ativo',
                    'pending': 'Pendente',
                    'cancelled': 'Cancelado',
                    'inactive': 'Inativo'
                }[subscription.status] || subscription.status;

                const planText = {
                    'free': 'Gratuito',
                    'pro': 'Profissional',
                    'enterprise': 'Empresarial'
                }[subscription.planId] || subscription.planId;

                row.innerHTML = `
                    <td>
                        <div>
                            <strong>${subscription.userId?.name || 'N/A'}</strong><br>
                            <small class="text-muted">${subscription.userId?.email || 'N/A'}</small>
                        </div>
                    </td>
                    <td><span class="badge bg-info">${planText}</span></td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        ${subscription.currentPeriodStart ? 
                            new Date(subscription.currentPeriodStart).toLocaleDateString('pt-BR') : 'N/A'} - 
                        ${subscription.currentPeriodEnd ? 
                            new Date(subscription.currentPeriodEnd).toLocaleDateString('pt-BR') : 'N/A'}
                    </td>
                    <td>R$ ${subscription.priceAtPurchase?.toFixed(2) || '0.00'}</td>
                    <td>${subscription.requestedAt ? 
                        new Date(subscription.requestedAt).toLocaleDateString('pt-BR') : 
                        new Date(subscription.createdAt).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action me-1" 
                                onclick="editSubscription('${subscription._id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${subscription.status === 'pending' ? `
                            <button class="btn btn-sm btn-success btn-action me-1" 
                                    onclick="activateSubscription('${subscription._id}')">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        ${subscription.status === 'active' ? `
                            <button class="btn btn-sm btn-warning btn-action me-1" 
                                    onclick="extendSubscription('${subscription._id}')">
                                <i class="fas fa-calendar-plus"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-danger btn-action" 
                                onclick="cancelSubscription('${subscription._id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Renderizar paginação
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Botão anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadSubscriptions(${currentPage - 1})">Anterior</a>`;
            pagination.appendChild(prevLi);

            // Números das páginas
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="loadSubscriptions(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            // Botão próximo
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadSubscriptions(${currentPage + 1})">Próximo</a>`;
            pagination.appendChild(nextLi);
        }

        // Aplicar filtros
        function applyFilters() {
            loadSubscriptions(1);
        }

        // Limpar filtros
        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPlan').value = '';
            document.getElementById('searchInput').value = '';
            loadSubscriptions(1);
        }

        // Criar nova assinatura
        async function createSubscription() {
            try {
                const formData = {
                    userId: document.getElementById('userId').value,
                    planId: document.getElementById('planId').value,
                    interval: document.getElementById('interval').value,
                    priceAtPurchase: parseFloat(document.getElementById('priceAtPurchase').value),
                    paymentMethod: document.getElementById('paymentMethod').value,
                    notes: document.getElementById('notes').value
                };

                const response = await fetch('/api/admin/subscriptions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('newSubscriptionModal')).hide();
                    document.getElementById('newSubscriptionForm').reset();
                    loadStats();
                    loadSubscriptions();
                    alert('Assinatura criada com sucesso!');
                } else {
                    alert('Erro ao criar assinatura: ' + data.message);
                }
            } catch (error) {
                console.error('Erro ao criar assinatura:', error);
                alert('Erro ao criar assinatura');
            }
        }

        // Editar assinatura
        function editSubscription(id) {
            const subscription = subscriptions.find(s => s._id === id);
            if (!subscription) return;

            document.getElementById('editSubscriptionId').value = id;
            document.getElementById('editStatus').value = subscription.status;
            document.getElementById('editCurrentPeriodEnd').value = 
                subscription.currentPeriodEnd ? 
                new Date(subscription.currentPeriodEnd).toISOString().split('T')[0] : '';
            document.getElementById('editNotes').value = subscription.metadata?.notes || '';

            new bootstrap.Modal(document.getElementById('editSubscriptionModal')).show();
        }

        // Atualizar assinatura
        async function updateSubscription() {
            try {
                const id = document.getElementById('editSubscriptionId').value;
                const formData = {
                    status: document.getElementById('editStatus').value,
                    currentPeriodEnd: document.getElementById('editCurrentPeriodEnd').value,
                    notes: document.getElementById('editNotes').value
                };

                const response = await fetch(`/api/admin/subscriptions/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editSubscriptionModal')).hide();
                    loadStats();
                    loadSubscriptions();
                    alert('Assinatura atualizada com sucesso!');
                } else {
                    alert('Erro ao atualizar assinatura: ' + data.message);
                }
            } catch (error) {
                console.error('Erro ao atualizar assinatura:', error);
                alert('Erro ao atualizar assinatura');
            }
        }

        // Ativar assinatura pendente
        async function activateSubscription(id) {
            if (!confirm('Deseja ativar esta assinatura?')) return;

            try {
                const response = await fetch(`/api/subscriptions/activate/${id}`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    loadStats();
                    loadSubscriptions();
                    alert('Assinatura ativada com sucesso!');
                } else {
                    alert('Erro ao ativar assinatura: ' + data.message);
                }
            } catch (error) {
                console.error('Erro ao ativar assinatura:', error);
                alert('Erro ao ativar assinatura');
            }
        }

        // Estender assinatura
        async function extendSubscription(id) {
            const days = prompt('Quantos dias deseja estender?', '30');
            if (!days || isNaN(days)) return;

            try {
                const response = await fetch(`/api/subscriptions/extend/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ days: parseInt(days) })
                });

                const data = await response.json();
                
                if (data.success) {
                    loadStats();
                    loadSubscriptions();
                    alert('Assinatura estendida com sucesso!');
                } else {
                    alert('Erro ao estender assinatura: ' + data.message);
                }
            } catch (error) {
                console.error('Erro ao estender assinatura:', error);
                alert('Erro ao estender assinatura');
            }
        }

        // Cancelar assinatura
        async function cancelSubscription(id) {
            if (!confirm('Deseja cancelar esta assinatura?')) return;

            try {
                const response = await fetch(`/api/subscriptions/cancel/${id}`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    loadStats();
                    loadSubscriptions();
                    alert('Assinatura cancelada com sucesso!');
                } else {
                    alert('Erro ao cancelar assinatura: ' + data.message);
                }
            } catch (error) {
                console.error('Erro ao cancelar assinatura:', error);
                alert('Erro ao cancelar assinatura');
            }
        }
    </script>
</body>
</html>